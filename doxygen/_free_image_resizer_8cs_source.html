<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ImageResizer: C:/Users/Administrator/Documents/resizer/Plugins/FreeImage/FreeImageResizer.cs Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="resizer-icon-64.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">ImageResizer
   &#160;<span id="projectnumber">3.1.3</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">C:/Users/Administrator/Documents/resizer/Plugins/FreeImage/FreeImageResizer.cs</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 ï»¿using System;
<a name="l00002"></a>00002 <span class="keyword">using</span> System.Collections.Generic;
<a name="l00003"></a>00003 <span class="keyword">using</span> System.Text;
<a name="l00004"></a>00004 <span class="keyword">using</span> ImageResizer.Resizing;
<a name="l00005"></a>00005 <span class="keyword">using</span> FreeImageAPI;
<a name="l00006"></a>00006 <span class="keyword">using</span> System.Drawing.Drawing2D;
<a name="l00007"></a>00007 <span class="keyword">using</span> ImageResizer.Util;
<a name="l00008"></a>00008 <span class="keyword">using</span> System.Drawing;
<a name="l00009"></a>00009 
<a name="l00010"></a><a class="code" href="namespace_image_resizer_1_1_plugins_1_1_free_image_scaling.html">00010</a> <span class="keyword">namespace </span>ImageResizer.Plugins.FreeImageScaling {
<a name="l00011"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_free_image_scaling_1_1_free_image_scaling_plugin.html">00011</a>     <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="class_image_resizer_1_1_plugins_1_1_free_image_scaling_1_1_free_image_scaling_plugin.html">FreeImageScalingPlugin</a> : <a class="code" href="class_image_resizer_1_1_resizing_1_1_builder_extension.html" title="Provides a useable base class that can be used to modify the behavior of ImageBuilder. When registered with an ImageBuilder instance, the ImageBuilder will call the corresponding methods on the extension prior to executing its own methods.">BuilderExtension</a>, <a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_plugin.html" title="All plugins must implement this. Enables web.config addition and removal.">IPlugin</a>, <a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_querystring_plugin.html" title="For plugins that access the query string (important!)">IQuerystringPlugin</a> {
<a name="l00012"></a>00012         <span class="keyword">public</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_free_image_scaling_1_1_free_image_scaling_plugin.html">FreeImageScalingPlugin</a>() {
<a name="l00013"></a>00013         }
<a name="l00014"></a>00014         <span class="keyword">public</span> <a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_plugin.html" title="All plugins must implement this. Enables web.config addition and removal.">IPlugin</a> Install(Configuration.Config c) {
<a name="l00015"></a>00015             c.Plugins.add_plugin(<span class="keyword">this</span>);
<a name="l00016"></a>00016             <span class="keywordflow">return</span> <span class="keyword">this</span>;
<a name="l00017"></a>00017         }
<a name="l00018"></a>00018 
<a name="l00019"></a>00019         <span class="keyword">public</span> <span class="keywordtype">bool</span> Uninstall(Configuration.Config c) {
<a name="l00020"></a>00020             c.Plugins.remove_plugin(<span class="keyword">this</span>);
<a name="l00021"></a>00021             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00022"></a>00022         }
<a name="l00023"></a>00023 
<a name="l00024"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_free_image_scaling_1_1_free_image_scaling_plugin.html#a3a2691c4874eea38e44e2159afd33125">00024</a>         <span class="keyword">public</span> IEnumerable&lt;string&gt; <a class="code" href="class_image_resizer_1_1_plugins_1_1_free_image_scaling_1_1_free_image_scaling_plugin.html#a3a2691c4874eea38e44e2159afd33125" title="If the plugin reads any values from the querystring, the names of the keys should be specified here...">GetSupportedQuerystringKeys</a>() {
<a name="l00025"></a>00025             <span class="keywordflow">return</span> <span class="keyword">new</span> <span class="keywordtype">string</span>[] { <span class="stringliteral">&quot;fi.scale&quot;</span> };
<a name="l00026"></a>00026         }
<a name="l00027"></a>00027 
<a name="l00028"></a>00028         <span class="keyword">public</span> <span class="keyword">static</span> FREE_IMAGE_FILTER ParseResizeAlgorithm(<span class="keywordtype">string</span> sf, FREE_IMAGE_FILTER defaultValue, out <span class="keywordtype">bool</span> valid){
<a name="l00029"></a>00029             FREE_IMAGE_FILTER filter = defaultValue;
<a name="l00030"></a>00030 
<a name="l00031"></a>00031              valid = <span class="keyword">true</span>;
<a name="l00032"></a>00032              <span class="keywordflow">if</span> (<span class="stringliteral">&quot;bicubic&quot;</span>.Equals(sf, StringComparison.OrdinalIgnoreCase)) filter = FREE_IMAGE_FILTER.FILTER_BICUBIC;
<a name="l00033"></a>00033              <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="stringliteral">&quot;bilinear&quot;</span>.Equals(sf, StringComparison.OrdinalIgnoreCase)) filter = FREE_IMAGE_FILTER.FILTER_BILINEAR;
<a name="l00034"></a>00034              <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="stringliteral">&quot;box&quot;</span>.Equals(sf, StringComparison.OrdinalIgnoreCase)) filter = FREE_IMAGE_FILTER.FILTER_BOX;
<a name="l00035"></a>00035              <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="stringliteral">&quot;bspline&quot;</span>.Equals(sf, StringComparison.OrdinalIgnoreCase)) filter = FREE_IMAGE_FILTER.FILTER_BSPLINE;
<a name="l00036"></a>00036              <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="stringliteral">&quot;catmullrom&quot;</span>.Equals(sf, StringComparison.OrdinalIgnoreCase)) filter = FREE_IMAGE_FILTER.FILTER_CATMULLROM;
<a name="l00037"></a>00037              <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="stringliteral">&quot;lanczos&quot;</span>.Equals(sf, StringComparison.OrdinalIgnoreCase)) filter = FREE_IMAGE_FILTER.FILTER_LANCZOS3;
<a name="l00038"></a>00038              <span class="keywordflow">else</span> valid = <span class="keyword">false</span>;
<a name="l00039"></a>00039 
<a name="l00040"></a>00040             <span class="keywordflow">return</span> filter;
<a name="l00041"></a>00041         }
<a name="l00042"></a>00042 
<a name="l00043"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_free_image_scaling_1_1_free_image_scaling_plugin.html#acb93206f312e8370f2d39ada323e0180">00043</a>         <span class="keyword">protected</span> <span class="keyword">override</span> <a class="code" href="namespace_image_resizer_1_1_resizing.html#a22bbb53580a122efe469a26ad584fa86" title="What to do about remaining handlers/methods for the specified section.">RequestedAction</a> <a class="code" href="class_image_resizer_1_1_plugins_1_1_free_image_scaling_1_1_free_image_scaling_plugin.html#acb93206f312e8370f2d39ada323e0180" title="Process.5(Render).9: The image is copied to the destination parallelogram specified by ring &#39;image&#39;...">RenderImage</a>(<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html" title="Encapsulates the state of an image being resized. Can be used to simulate a resize as well as actuall...">ImageState</a> s) {
<a name="l00044"></a>00044             <span class="comment">//Skip this when we are doing simulations</span>
<a name="l00045"></a>00045             <span class="keywordflow">if</span> (s.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a14723e4f7de63667e37fcbdb6a00055b" title="A graphics object to write to the destination bitmap. If null, skip drawing commands, but continue layout logic.">destGraphics</a> == null) <span class="keywordflow">return</span> <a class="code" href="namespace_image_resizer_1_1_resizing.html#a22bbb53580a122efe469a26ad584fa86" title="What to do about remaining handlers/methods for the specified section.">RequestedAction</a>.None;
<a name="l00046"></a>00046 
<a name="l00047"></a>00047             <span class="keywordtype">string</span> sf = s.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a7229be6e840514ac987e571bfa7a9179" title="The commands to apply to the bitmap.">settings</a>[<span class="stringliteral">&quot;fi.scale&quot;</span>];
<a name="l00048"></a>00048             <span class="keywordflow">if</span> (<span class="keywordtype">string</span>.IsNullOrEmpty(sf)) <span class="keywordflow">return</span> <a class="code" href="namespace_image_resizer_1_1_resizing.html#a22bbb53580a122efe469a26ad584fa86" title="What to do about remaining handlers/methods for the specified section.">RequestedAction</a>.None;
<a name="l00049"></a>00049             <span class="keywordtype">bool</span> validAlg = <span class="keyword">false</span>;
<a name="l00050"></a>00050             FREE_IMAGE_FILTER filter = ParseResizeAlgorithm(sf, FREE_IMAGE_FILTER.FILTER_CATMULLROM, out validAlg);
<a name="l00051"></a>00051             <span class="keywordflow">if</span> (!validAlg) <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_image_processing_exception.html" title="Represents an non-recoverable exception that occured while processing the image. Possible causes are:...">ImageProcessingException</a>(<span class="stringliteral">&quot;The specified resizing filter &#39;&quot;</span> + sf + <span class="stringliteral">&quot;&#39; did not match bicubic, bilinear, box, bspline, catmullrom, or lanczos.&quot;</span>);
<a name="l00052"></a>00052 
<a name="l00053"></a>00053             <span class="comment">//Set copy attributes</span>
<a name="l00054"></a>00054             s.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a0575a388f0e3235d967cb62f4904fe09" title="Allows color correction/modification during the image copy.">copyAttibutes</a>.SetWrapMode(WrapMode.TileFlipXY);
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 
<a name="l00057"></a>00057             <span class="comment">//The minimum dimensions of the temporary bitmap.</span>
<a name="l00058"></a>00058             SizeF targetSize = <a class="code" href="class_image_resizer_1_1_util_1_1_polygon_math.html">PolygonMath</a>.<a class="code" href="class_image_resizer_1_1_util_1_1_polygon_math.html#a02b9e3951484c2e1592c6eb8131d8405" title="Determines the width and height of the paralellogram.">getParallelogramSize</a>(s.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a845b5dc0d563cd83e8591ceccdbfe31e" title="The layout object. Used for calculated and flowing the layout of the various rings around the image (...">layout</a>[<span class="stringliteral">&quot;image&quot;</span>]);
<a name="l00059"></a>00059             targetSize = <span class="keyword">new</span> SizeF((<span class="keywordtype">float</span>)Math.Ceiling(targetSize.Width), (float)Math.Ceiling(targetSize.Height));
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 
<a name="l00062"></a>00062             <span class="comment">//The size of the temporary bitmap. </span>
<a name="l00063"></a>00063             <span class="comment">//We want it larger than the size we&#39;ll use on the final copy, so we never upscale it</span>
<a name="l00064"></a>00064             <span class="comment">//- but we also want it as small as possible so processing is fast.</span>
<a name="l00065"></a>00065             SizeF tempSize = <a class="code" href="class_image_resizer_1_1_util_1_1_polygon_math.html">PolygonMath</a>.<a class="code" href="class_image_resizer_1_1_util_1_1_polygon_math.html#a63ca79f538e9c19e38f14ad57de06958" title="Scales &#39;outer&#39; to be equal or larger than &#39;innerBounds&#39; while maintaining aspect ratio. Upscales and downscales.">ScaleOutside</a>(targetSize, s.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a22528462bb2ca64173878ef4441bad28" title="The rectangular portion of the source image to copy.">copyRect</a>.Size);
<a name="l00066"></a>00066             <span class="keywordtype">int</span> tempWidth = (int)Math.Ceiling(tempSize.Width);
<a name="l00067"></a>00067             <span class="keywordtype">int</span> tempHeight = (int)Math.Ceiling(tempSize.Height);
<a name="l00068"></a>00068             FIBITMAP src = FIBITMAP.Zero;
<a name="l00069"></a>00069             FIBITMAP midway = FIBITMAP.Zero;
<a name="l00070"></a>00070             <span class="keywordflow">try</span> {
<a name="l00071"></a>00071                 <span class="comment">//Convert, scale, then convert back.</span>
<a name="l00072"></a>00072                 src = FreeImage.CreateFromBitmap(s.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a8aa9f1c77100b8bb71c5ffa1bdff62d0" title="The source bitmap. If null, skip drawing commands, but continue layout logic.">sourceBitmap</a>);
<a name="l00073"></a>00073                 midway = FreeImage.Rescale(src, tempWidth, tempHeight, filter);
<a name="l00074"></a>00074                 FreeImage.UnloadEx(ref src);
<a name="l00075"></a>00075                 <span class="keyword">using</span> (Bitmap resized = FreeImage.GetBitmap(midway)) {
<a name="l00076"></a>00076                     FreeImage.UnloadEx(ref midway);
<a name="l00077"></a>00077                     resized.MakeTransparent();
<a name="l00078"></a>00078                     s.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a0575a388f0e3235d967cb62f4904fe09" title="Allows color correction/modification during the image copy.">copyAttibutes</a>.SetWrapMode(WrapMode.TileFlipXY);
<a name="l00079"></a>00079                     s.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a14723e4f7de63667e37fcbdb6a00055b" title="A graphics object to write to the destination bitmap. If null, skip drawing commands, but continue layout logic.">destGraphics</a>.DrawImage(resized, <a class="code" href="class_image_resizer_1_1_util_1_1_polygon_math.html">PolygonMath</a>.<a class="code" href="class_image_resizer_1_1_util_1_1_polygon_math.html#a28d60a0db031946a534a4efbc85e2728" title="Moves element 4 to spot 3 and truncates to 3 elements. For compatiblity with Graphics.DrawImage.">getParallelogram</a>(s.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a845b5dc0d563cd83e8591ceccdbfe31e" title="The layout object. Used for calculated and flowing the layout of the various rings around the image (...">layout</a>[<span class="stringliteral">&quot;image&quot;</span>]), <span class="keyword">new</span> RectangleF(0, 0, resized.Width, resized.Height), GraphicsUnit.Pixel, s.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a0575a388f0e3235d967cb62f4904fe09" title="Allows color correction/modification during the image copy.">copyAttibutes</a>);
<a name="l00080"></a>00080                 }
<a name="l00081"></a>00081             } <span class="keywordflow">finally</span> {
<a name="l00082"></a>00082                 <span class="keywordflow">if</span> (!src.IsNull) FreeImage.UnloadEx(ref src);
<a name="l00083"></a>00083                 <span class="keywordflow">if</span> (!midway.IsNull) FreeImage.UnloadEx(ref midway);
<a name="l00084"></a>00084             }
<a name="l00085"></a>00085             
<a name="l00086"></a>00086 
<a name="l00087"></a>00087             <span class="keywordflow">return</span> <a class="code" href="namespace_image_resizer_1_1_resizing.html#a22bbb53580a122efe469a26ad584fa86" title="What to do about remaining handlers/methods for the specified section.">RequestedAction</a>.Cancel;
<a name="l00088"></a>00088         }
<a name="l00089"></a>00089     }
<a name="l00090"></a>00090 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Events</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
