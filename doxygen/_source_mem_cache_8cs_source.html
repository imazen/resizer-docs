<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ImageResizer: C:/Users/Administrator/Documents/resizer/Plugins/DiskCache/SourceMemCache/SourceMemCache.cs Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="resizer-icon-64.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">ImageResizer
   &#160;<span id="projectnumber">3.2.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">C:/Users/Administrator/Documents/resizer/Plugins/DiskCache/SourceMemCache/SourceMemCache.cs</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 ï»¿using System;
<a name="l00002"></a>00002 <span class="keyword">using</span> System.Collections.Generic;
<a name="l00003"></a>00003 <span class="keyword">using</span> System.Text;
<a name="l00004"></a>00004 <span class="keyword">using</span> System.IO;
<a name="l00005"></a>00005 <span class="keyword">using</span> ImageResizer.Collections;
<a name="l00006"></a>00006 <span class="keyword">using</span> ImageResizer.Util;
<a name="l00007"></a>00007 <span class="keyword">using</span> System.Collections.Specialized;
<a name="l00008"></a>00008 <span class="keyword">using</span> ImageResizer.ExtensionMethods;
<a name="l00009"></a>00009 
<a name="l00010"></a>00010 <span class="keyword">namespace </span>ImageResizer.Plugins.SourceMemCache {
<a name="l00011"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_source_mem_cache_1_1_source_mem_cache_plugin.html">00011</a>     <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="class_image_resizer_1_1_plugins_1_1_source_mem_cache_1_1_source_mem_cache_plugin.html">SourceMemCachePlugin</a>: <a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_plugin.html" title="All plugins must implement this. Enables web.config addition and removal.">IPlugin</a>, <a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_virtual_file_cache.html" title="Implement this if you are caching files provided by a virtual image provider (For example...">IVirtualFileCache</a> {
<a name="l00012"></a>00012 <span class="comment"></span>
<a name="l00013"></a>00013 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00014"></a>00014 <span class="comment">        /// Defaults to 10MB limit, and samples usage over the last 10 minutes when deciding what to remove. Stuff not used in the last 10 minutes gets discarded even if the limit hasn&#39;t been reached.</span>
<a name="l00015"></a>00015 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00016"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_source_mem_cache_1_1_source_mem_cache_plugin.html#ac47ea6d5f3d99242ec41277553fb9a6d">00016</a> <span class="comment"></span>        <span class="keyword">public</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_source_mem_cache_1_1_source_mem_cache_plugin.html#ac47ea6d5f3d99242ec41277553fb9a6d" title="Defaults to 10MB limit, and samples usage over the last 10 minutes when deciding what to remove...">SourceMemCachePlugin</a>() : this(1024 * 1024 * 1024, new TimeSpan(0, 10, 0)) { }
<a name="l00017"></a>00017 
<a name="l00018"></a>00018         <span class="keyword">public</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_source_mem_cache_1_1_source_mem_cache_plugin.html">SourceMemCachePlugin</a>(<span class="keywordtype">long</span> maxBytes, TimeSpan usageWindow) {
<a name="l00019"></a>00019             <span class="comment">//Cleanup at most once per minute, unless hitting the limits. </span>
<a name="l00020"></a>00020             cache = <span class="keyword">new</span> ConstrainedCache&lt;string, CachedVirtualFile&gt;(StringComparer.OrdinalIgnoreCase, delegate(<span class="keywordtype">string</span> key, <a class="code" href="class_image_resizer_1_1_plugins_1_1_source_mem_cache_1_1_cached_virtual_file.html">CachedVirtualFile</a> file) {
<a name="l00021"></a>00021                 <span class="keywordflow">return</span> key.Length * 4 + file.BytesOccupied;
<a name="l00022"></a>00022             }, maxBytes, usageWindow, <span class="keyword">new</span> TimeSpan(0, 1, 0)); 
<a name="l00023"></a>00023 
<a name="l00024"></a>00024         }
<a name="l00025"></a>00025 
<a name="l00026"></a>00026         <span class="keyword">private</span> ConstrainedCache&lt;string, CachedVirtualFile&gt; cache;
<a name="l00027"></a>00027 
<a name="l00028"></a>00028         <span class="keyword">public</span> IVirtualFile GetFileIfCached(<span class="keywordtype">string</span> virtualPath, System.Collections.Specialized.NameValueCollection queryString, IVirtualFile original) {
<a name="l00029"></a>00029             <span class="comment">//Use alternate cache key if provided</span>
<a name="l00030"></a>00030             <span class="keywordtype">string</span> key = original is IVirtualFileSourceCacheKey ? ((IVirtualFileSourceCacheKey)original).GetCacheKey(<span class="keyword">true</span>) : original.VirtualPath;
<a name="l00031"></a>00031             <span class="comment">//If cached, serve it. </span>
<a name="l00032"></a>00032             CachedVirtualFile c = cache.Get(key);
<a name="l00033"></a>00033             <span class="keywordflow">if</span> (c != null) <span class="keywordflow">return</span> c;
<a name="l00034"></a>00034             <span class="comment">//If not, let&#39;s cache it.</span>
<a name="l00035"></a>00035             <span class="keywordflow">if</span> (<span class="stringliteral">&quot;mem&quot;</span>.Equals(queryString[<span class="stringliteral">&quot;scache&quot;</span>], StringComparison.OrdinalIgnoreCase)) {
<a name="l00036"></a>00036                 <span class="comment">//Optimization idea - use LockProvider to prevent duplicate requests. Would mean merging with DiskCache :(</span>
<a name="l00037"></a>00037                 <span class="keyword">using</span> (Stream data = original.Open()) {<span class="comment">//Very long-running call</span>
<a name="l00038"></a>00038                     c = <span class="keyword">new</span> CachedVirtualFile(original.VirtualPath,  data.CopyToBytes(<span class="keyword">true</span>)); 
<a name="l00039"></a>00039                 }
<a name="l00040"></a>00040                 cache.Set(key, c); <span class="comment">//Save to cache (may trigger cleanup)</span>
<a name="l00041"></a>00041                 <span class="keywordflow">return</span> c;
<a name="l00042"></a>00042             }
<a name="l00043"></a>00043             <span class="keywordflow">return</span> null;
<a name="l00044"></a>00044         }
<a name="l00045"></a>00045 
<a name="l00046"></a>00046         <span class="keyword">public</span> IPlugin Install(Configuration.Config c) {
<a name="l00047"></a>00047             c.Plugins.add_plugin(<span class="keyword">this</span>);
<a name="l00048"></a>00048             <span class="keywordflow">return</span> <span class="keyword">this</span>;
<a name="l00049"></a>00049         }
<a name="l00050"></a>00050 
<a name="l00051"></a>00051         <span class="keyword">public</span> <span class="keywordtype">bool</span> Uninstall(Configuration.Config c) {
<a name="l00052"></a>00052             c.Plugins.remove_plugin(<span class="keyword">this</span>);
<a name="l00053"></a>00053             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00054"></a>00054         }
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 
<a name="l00057"></a>00057     }
<a name="l00058"></a>00058 
<a name="l00059"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_source_mem_cache_1_1_cached_virtual_file.html">00059</a>     <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="class_image_resizer_1_1_plugins_1_1_source_mem_cache_1_1_cached_virtual_file.html">CachedVirtualFile</a> : <a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_virtual_file.html" title="A virtual file to support IVirtualImageProvider.">IVirtualFile</a> {
<a name="l00060"></a>00060 
<a name="l00061"></a>00061         <span class="keyword">public</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_source_mem_cache_1_1_cached_virtual_file.html">CachedVirtualFile</a>(<span class="keywordtype">string</span> virtualPath, byte[] data) {
<a name="l00062"></a>00062             this.virtualPath = virtualPath;
<a name="l00063"></a>00063             this.data = data;
<a name="l00064"></a>00064         }
<a name="l00065"></a>00065         <span class="keywordtype">string</span> virtualPath;
<a name="l00066"></a>00066         byte[] data;
<a name="l00067"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_source_mem_cache_1_1_cached_virtual_file.html#a5a3a85cf73857a0d63c40fe33733bf66">00067</a>         <span class="keyword">public</span> <span class="keywordtype">string</span> VirtualPath {
<a name="l00068"></a>00068             <span class="keyword">get</span> { <span class="keywordflow">return</span> virtualPath; }
<a name="l00069"></a>00069         }
<a name="l00070"></a>00070 
<a name="l00071"></a>00071         <span class="keyword">private</span> <span class="keywordtype">bool</span> checkIntegrity = <span class="keyword">true</span>;
<a name="l00072"></a>00072 
<a name="l00073"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_source_mem_cache_1_1_cached_virtual_file.html#aa5e21c1d163d3f9df17355f418bc50e2">00073</a>         <span class="keyword">public</span> System.IO.Stream <a class="code" href="class_image_resizer_1_1_plugins_1_1_source_mem_cache_1_1_cached_virtual_file.html#aa5e21c1d163d3f9df17355f418bc50e2" title="Returns an opened stream to the file contents.">Open</a>() {
<a name="l00074"></a>00074             <span class="keywordflow">if</span> (checkIntegrity) {
<a name="l00075"></a>00075                 <span class="keywordflow">if</span> (originalHash == -1) originalHash = CaluclateHash();
<a name="l00076"></a>00076                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (originalHash != CaluclateHash()) <span class="keywordflow">throw</span> <span class="keyword">new</span> AccessViolationException(<span class="stringliteral">&quot;A read-only memory stream was somehow modified.&quot;</span>);
<a name="l00077"></a>00077             }
<a name="l00078"></a>00078 
<a name="l00079"></a>00079             <span class="keywordflow">return</span> <span class="keyword">new</span> MemoryStream(data, <span class="keyword">false</span>);
<a name="l00080"></a>00080         }
<a name="l00081"></a>00081 
<a name="l00082"></a>00082         <span class="keyword">protected</span> <span class="keywordtype">int</span> originalHash = -1;
<a name="l00083"></a>00083         <span class="keyword">protected</span> <span class="keywordtype">int</span> CaluclateHash() {
<a name="l00084"></a>00084             unchecked {
<a name="l00085"></a>00085                 <span class="keyword">const</span> <span class="keywordtype">int</span> p = 16777619;
<a name="l00086"></a>00086                 <span class="keywordtype">int</span> hash = (int)2166136261;
<a name="l00087"></a>00087 
<a name="l00088"></a>00088                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; data.Length; i++)
<a name="l00089"></a>00089                     hash = (hash ^ data[i]) * p;
<a name="l00090"></a>00090 
<a name="l00091"></a>00091                 hash += hash &lt;&lt; 13;
<a name="l00092"></a>00092                 hash ^= hash &gt;&gt; 7;
<a name="l00093"></a>00093                 hash += hash &lt;&lt; 3;
<a name="l00094"></a>00094                 hash ^= hash &gt;&gt; 17;
<a name="l00095"></a>00095                 hash += hash &lt;&lt; 5;
<a name="l00096"></a>00096                 <span class="keywordflow">return</span> hash;
<a name="l00097"></a>00097             }
<a name="l00098"></a>00098         }
<a name="l00099"></a>00099 
<a name="l00100"></a>00100         <span class="keyword">public</span> <span class="keywordtype">long</span> BytesOccupied { <span class="keyword">get</span> { <span class="keywordflow">return</span> data.Length + virtualPath.Length * 4 + 32; } }
<a name="l00101"></a>00101 
<a name="l00102"></a>00102 
<a name="l00103"></a>00103     }
<a name="l00104"></a>00104 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Events</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
