<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ImageResizer: C:/Users/Administrator/Documents/resizer/Plugins/DiskCache/Async/AsyncWriteCollection.cs Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="resizer-icon-64.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">ImageResizer
   &#160;<span id="projectnumber">3.1.3</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">C:/Users/Administrator/Documents/resizer/Plugins/DiskCache/Async/AsyncWriteCollection.cs</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 ï»¿using System;
<a name="l00002"></a>00002 <span class="keyword">using</span> System.Collections.Generic;
<a name="l00003"></a>00003 <span class="keyword">using</span> System.Text;
<a name="l00004"></a>00004 <span class="keyword">using</span> System.Threading;
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 <span class="keyword">namespace </span>ImageResizer.Plugins.DiskCache.Async {
<a name="l00007"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_async_1_1_async_write_collection.html">00007</a>     <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_async_1_1_async_write_collection.html">AsyncWriteCollection</a> {
<a name="l00008"></a>00008 
<a name="l00009"></a>00009         <span class="keyword">public</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_async_1_1_async_write_collection.html">AsyncWriteCollection</a>() {
<a name="l00010"></a>00010         }
<a name="l00011"></a>00011 
<a name="l00012"></a>00012         <span class="keyword">private</span> <span class="keywordtype">object</span> _sync = <span class="keyword">new</span> object();
<a name="l00013"></a>00013 
<a name="l00014"></a>00014         <span class="keyword">private</span> Dictionary&lt;string, AsyncWrite&gt; c = <span class="keyword">new</span> Dictionary&lt;string, AsyncWrite&gt;();
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 
<a name="l00017"></a>00017         <span class="keyword">private</span> <span class="keywordtype">long</span> _maxQueueBytes = 1024 * 1024 * 10;<span class="comment"></span>
<a name="l00018"></a>00018 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00019"></a>00019 <span class="comment">        /// How many bytes of buffered file data to hold in memory before refusing futher queue requests and forcing them to be executed synchronously.</span>
<a name="l00020"></a>00020 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00021"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_async_1_1_async_write_collection.html#accd19b4886af197047ce6d12953157bf">00021</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">long</span> MaxQueueBytes {
<a name="l00022"></a>00022             <span class="keyword">get</span> { <span class="keywordflow">return</span> _maxQueueBytes; }
<a name="l00023"></a>00023             <span class="keyword">set</span> { _maxQueueBytes = value; }
<a name="l00024"></a>00024         }
<a name="l00025"></a>00025 <span class="comment"></span>
<a name="l00026"></a>00026 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00027"></a>00027 <span class="comment">        /// If the collection contains the specified item, it is returned. Otherwise, null is returned.</span>
<a name="l00028"></a>00028 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00029"></a>00029 <span class="comment">        /// &lt;param name=&quot;relativePath&quot;&gt;&lt;/param&gt;</span>
<a name="l00030"></a>00030 <span class="comment">        /// &lt;param name=&quot;modifiedUtc&quot;&gt;&lt;/param&gt;</span>
<a name="l00031"></a>00031 <span class="comment">        /// &lt;returns&gt;&lt;/returns&gt;</span>
<a name="l00032"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_async_1_1_async_write_collection.html#a002c466579c94e379c32f7aabc675254">00032</a> <span class="comment"></span>        <span class="keyword">public</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_async_1_1_async_write.html">AsyncWrite</a> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_async_1_1_async_write_collection.html#a002c466579c94e379c32f7aabc675254" title="If the collection contains the specified item, it is returned. Otherwise, null is returned...">Get</a>(<span class="keywordtype">string</span> relativePath, DateTime modifiedUtc) {
<a name="l00033"></a>00033             lock (_sync) {
<a name="l00034"></a>00034                 <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_async_1_1_async_write.html">AsyncWrite</a> result;
<a name="l00035"></a>00035                 <span class="keywordflow">return</span> c.TryGetValue(HashTogether(relativePath, modifiedUtc), out result) ? result : null;
<a name="l00036"></a>00036             }
<a name="l00037"></a>00037         }
<a name="l00038"></a>00038 <span class="comment"></span>
<a name="l00039"></a>00039 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00040"></a>00040 <span class="comment">        /// Returns how many bytes are allocated by buffers in the queue. May be 2x the amount of data. Represents how much ram is being used by the queue, not the amount of encoded bytes that will actually be written.</span>
<a name="l00041"></a>00041 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00042"></a>00042 <span class="comment">        /// &lt;returns&gt;&lt;/returns&gt;</span>
<a name="l00043"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_async_1_1_async_write_collection.html#ac15496ee661c56506120dd0a5a09c16f">00043</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">long</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_async_1_1_async_write_collection.html#ac15496ee661c56506120dd0a5a09c16f" title="Returns how many bytes are allocated by buffers in the queue. May be 2x the amount of data...">GetQueuedBufferBytes</a>() {
<a name="l00044"></a>00044             lock (_sync) {
<a name="l00045"></a>00045                 <span class="keywordtype">long</span> total = 0;
<a name="l00046"></a>00046                 <span class="keywordflow">foreach</span> (<a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_async_1_1_async_write.html">AsyncWrite</a> value <span class="keywordflow">in</span> c.Values) {
<a name="l00047"></a>00047                     <span class="keywordflow">if</span> (value == null) <span class="keywordflow">continue</span>;
<a name="l00048"></a>00048                     total += value.GetBufferLength();
<a name="l00049"></a>00049                 }
<a name="l00050"></a>00050                 <span class="keywordflow">return</span> total;
<a name="l00051"></a>00051             }
<a name="l00052"></a>00052         }
<a name="l00053"></a>00053 <span class="comment"></span>
<a name="l00054"></a>00054 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00055"></a>00055 <span class="comment">        /// Removes the specified object based on its relativepath and modifieddateutc values.</span>
<a name="l00056"></a>00056 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00057"></a>00057 <span class="comment">        /// &lt;param name=&quot;w&quot;&gt;&lt;/param&gt;</span>
<a name="l00058"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_async_1_1_async_write_collection.html#aa245eff15b732e3caee328ad86a278a9">00058</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_async_1_1_async_write_collection.html#aa245eff15b732e3caee328ad86a278a9" title="Removes the specified object based on its relativepath and modifieddateutc values.">Remove</a>(<a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_async_1_1_async_write.html">AsyncWrite</a> w) {
<a name="l00059"></a>00059             lock (_sync) {
<a name="l00060"></a>00060                 c.Remove(HashTogether(w.RelativePath, w.ModifiedDateUtc));
<a name="l00061"></a>00061             }
<a name="l00062"></a>00062         }<span class="comment"></span>
<a name="l00063"></a>00063 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00064"></a>00064 <span class="comment">        /// Returns false when (a) the specified AsyncWrite value already exists, (b) the queue is full, or (c) the thread pool queue is full</span>
<a name="l00065"></a>00065 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00066"></a>00066 <span class="comment">        /// &lt;param name=&quot;w&quot;&gt;&lt;/param&gt;</span>
<a name="l00067"></a>00067 <span class="comment">        /// &lt;returns&gt;&lt;/returns&gt;</span>
<a name="l00068"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_async_1_1_async_write_collection.html#a92b45565d75d0c9c9a0d56d5b11fcac0">00068</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_async_1_1_async_write_collection.html#a92b45565d75d0c9c9a0d56d5b11fcac0" title="Returns false when (a) the specified AsyncWrite value already exists, (b) the queue is full...">Queue</a>(<a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_async_1_1_async_write.html">AsyncWrite</a> w,WriterDelegate writerDelegate ){
<a name="l00069"></a>00069             lock (_sync) {
<a name="l00070"></a>00070                 <span class="keywordflow">if</span> (GetQueuedBufferBytes() + w.GetBufferLength() &gt; MaxQueueBytes) <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">//Because we would use too much ram.</span>
<a name="l00071"></a>00071                 <span class="keywordflow">if</span> (c.ContainsKey(HashTogether(w.RelativePath, w.ModifiedDateUtc))) <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">//We already have a queued write for this data.</span>
<a name="l00072"></a>00072                 <span class="keywordflow">if</span> (!ThreadPool.QueueUserWorkItem(delegate(<span class="keywordtype">object</span> state){
<a name="l00073"></a>00073                     <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_async_1_1_async_write.html">AsyncWrite</a> job = state as <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_async_1_1_async_write.html">AsyncWrite</a>;
<a name="l00074"></a>00074                     writerDelegate(job);
<a name="l00075"></a>00075                 }, w)) <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">//thread pool refused</span>
<a name="l00076"></a>00076                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00077"></a>00077             }
<a name="l00078"></a>00078         }
<a name="l00079"></a>00079 
<a name="l00080"></a>00080         <span class="keyword">public</span> delegate <span class="keywordtype">void</span> WriterDelegate(<a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_async_1_1_async_write.html">AsyncWrite</a> w);
<a name="l00081"></a>00081 
<a name="l00082"></a>00082         <span class="keyword">public</span> <span class="keywordtype">string</span> HashTogether(<span class="keywordtype">string</span> relativePath, DateTime modifiedUtc) {
<a name="l00083"></a>00083             <span class="keywordflow">return</span> relativePath.ToUpperInvariant() + <span class="stringliteral">&quot;_&quot;</span> + modifiedUtc.Ticks.ToString();
<a name="l00084"></a>00084         }
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 
<a name="l00087"></a>00087     }
<a name="l00088"></a>00088 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Events</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
