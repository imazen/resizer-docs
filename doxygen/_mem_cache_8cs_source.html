<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ImageResizer: C:/Users/Administrator/Documents/resizer/Plugins/DiskCache/OutputMemCache/MemCache.cs Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="imageresizer-logo-00aec4.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">ImageResizer
   &#160;<span id="projectnumber">3.3.3</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">C:/Users/Administrator/Documents/resizer/Plugins/DiskCache/OutputMemCache/MemCache.cs</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 ï»¿using System;
<a name="l00002"></a>00002 <span class="keyword">using</span> System.Collections.Generic;
<a name="l00003"></a>00003 <span class="keyword">using</span> System.Text;
<a name="l00004"></a>00004 <span class="keyword">using</span> ImageResizer.Caching;
<a name="l00005"></a>00005 <span class="keyword">using</span> ImageResizer.Plugins.SourceMemCache;
<a name="l00006"></a>00006 <span class="keyword">using</span> ImageResizer.Plugins.DiskCache;
<a name="l00007"></a>00007 <span class="keyword">using</span> System.Web;
<a name="l00008"></a>00008 <span class="keyword">using</span> System.IO;
<a name="l00009"></a>00009 <span class="keyword">using</span> ImageResizer.ExtensionMethods;
<a name="l00010"></a>00010 
<a name="l00011"></a><a class="code" href="namespace_image_resizer_1_1_plugins_1_1_mem_cache.html">00011</a> <span class="keyword">namespace </span>ImageResizer.Plugins.MemCache {
<a name="l00012"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_mem_cache_1_1_mem_cache_plugin.html">00012</a>     <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="class_image_resizer_1_1_plugins_1_1_mem_cache_1_1_mem_cache_plugin.html">MemCachePlugin</a>:<a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_plugin.html" title="All plugins must implement this. Enables web.config addition and removal.">IPlugin</a>,<a class="code" href="interface_image_resizer_1_1_caching_1_1_i_cache.html" title="Provides caching behavior.">ICache</a> {
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 
<a name="l00015"></a>00015         <span class="comment"></span>
<a name="l00016"></a>00016 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00017"></a>00017 <span class="comment">        /// Defaults to 10MB limit, and samples usage over the last 10 minutes when deciding what to remove. Stuff not used in the last 10 minutes gets discarded even if the limit hasn&#39;t been reached.</span>
<a name="l00018"></a>00018 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00019"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_mem_cache_1_1_mem_cache_plugin.html#ad8bbee446e5f990ccfd941d5e276a248">00019</a> <span class="comment"></span>        <span class="keyword">public</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_mem_cache_1_1_mem_cache_plugin.html#ad8bbee446e5f990ccfd941d5e276a248" title="Defaults to 10MB limit, and samples usage over the last 10 minutes when deciding what to remove...">MemCachePlugin</a>() : this(1024 * 1024 * 1024, new TimeSpan(0, 10, 0)) { }
<a name="l00020"></a>00020 
<a name="l00021"></a>00021         <span class="keyword">public</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_mem_cache_1_1_mem_cache_plugin.html">MemCachePlugin</a>(<span class="keywordtype">long</span> maxBytes, TimeSpan usageWindow) {
<a name="l00022"></a>00022             <span class="comment">//Cleanup at most once per minute, unless hitting the limits. </span>
<a name="l00023"></a>00023             cache = <span class="keyword">new</span> ConstrainedCache&lt;string, MemCacheResult&gt;(StringComparer.OrdinalIgnoreCase, delegate(<span class="keywordtype">string</span> key, <a class="code" href="class_image_resizer_1_1_plugins_1_1_mem_cache_1_1_mem_cache_result.html">MemCacheResult</a> file) {
<a name="l00024"></a>00024                 <span class="keywordflow">return</span> key.Length * 4 + file.BytesOccupied;
<a name="l00025"></a>00025             }, maxBytes, usageWindow, <span class="keyword">new</span> TimeSpan(0, 1, 0)); 
<a name="l00026"></a>00026 
<a name="l00027"></a>00027         }
<a name="l00028"></a>00028 
<a name="l00029"></a>00029         <span class="keyword">private</span> ConstrainedCache&lt;string, MemCacheResult&gt; cache;
<a name="l00030"></a>00030         <span class="keyword">private</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html" title="Provides locking based on a string key. Locks are local to the LockProvider instance. The class handles disposing of unused locks. Generally used for coordinating writes to files (of which there can be millions). Only keeps key/lock pairs in memory which are in use. Thread-safe.">LockProvider</a> locks = <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html" title="Provides locking based on a string key. Locks are local to the LockProvider instance. The class handles disposing of unused locks. Generally used for coordinating writes to files (of which there can be millions). Only keeps key/lock pairs in memory which are in use. Thread-safe.">LockProvider</a>();
<a name="l00031"></a>00031 
<a name="l00032"></a>00032         <span class="keyword">public</span> <span class="keywordtype">bool</span> CanProcess(System.Web.HttpContext current, <a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html" title="A collection of data and callbacks that can be passed to a caching object.">IResponseArgs</a> e) {
<a name="l00033"></a>00033             <span class="keywordflow">return</span> <span class="stringliteral">&quot;true&quot;</span>.Equals(e.<a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html#aa9dc61f9d5c59912f02c89da09abf69b" title="The rewritten querystring. Can be useful for caching systems that accept querystring arguments...">RewrittenQuerystring</a>[<span class="stringliteral">&quot;mcache&quot;</span>], StringComparison.OrdinalIgnoreCase);
<a name="l00034"></a>00034         }
<a name="l00035"></a>00035 
<a name="l00036"></a>00036         <span class="keyword">public</span> <span class="keywordtype">void</span> Process(System.Web.HttpContext current, <a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html" title="A collection of data and callbacks that can be passed to a caching object.">IResponseArgs</a> e) {
<a name="l00037"></a>00037 
<a name="l00038"></a>00038             <span class="comment">//Use alternate cache key if provided</span>
<a name="l00039"></a>00039             <span class="keywordtype">string</span> key = e.<a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html#a9325a2e3eb32f9e5b2a3e320fe51aab9" title="A string derived from the request, which can contain any kind of data. To get a cache key that varies...">RequestKey</a> + (e.<a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html#aac9c73303f119c5530d14dfcdef7bce2" title="True if a modified date is available for verifying cache integrity.">HasModifiedDate</a> ? e.<a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html#a163d883b2e541e2702de8d7d09acec04" title="A delegate that returns the modified date of the source data.">GetModifiedDateUTC</a>().Ticks.ToString() : <span class="stringliteral">&quot;&quot;</span>);
<a name="l00040"></a>00040 
<a name="l00041"></a>00041             <span class="comment">//If cached, serve it. </span>
<a name="l00042"></a>00042             var c = cache.Get(key);
<a name="l00043"></a>00043             <span class="keywordflow">if</span> (c != null) {
<a name="l00044"></a>00044                 Serve(current, e, c);
<a name="l00045"></a>00045                 <span class="keywordflow">return</span>;
<a name="l00046"></a>00046             }
<a name="l00047"></a>00047             <span class="comment">//If not, let&#39;s cache it.</span>
<a name="l00048"></a>00048             locks.TryExecute(key, 3000, delegate() {
<a name="l00049"></a>00049                 c = cache.Get(key);
<a name="l00050"></a>00050                 <span class="keywordflow">if</span> (c == null) {
<a name="l00051"></a>00051                     <span class="keyword">using</span> (var data = <span class="keyword">new</span> MemoryStream()){
<a name="l00052"></a>00052                         e.<a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html#a1090d53eee6cda04ba5ae3e611044495" title="A callback method that will resize, encode, and write the data to the given stream.">ResizeImageToStream</a>(data);<span class="comment">//Very long-running call</span>
<a name="l00053"></a>00053                         c = <span class="keyword">new</span> MemCacheResult(<a class="code" href="class_image_resizer_1_1_extension_methods_1_1_stream_extensions.html" title="Provides extension methods for copying streams.">StreamExtensions</a>.<a class="code" href="class_image_resizer_1_1_extension_methods_1_1_stream_extensions.html#afee19807fe5e2ed408204859d5898c9c" title="Copies the remaining data in the current stream to a byte[] array of exact size.">CopyToBytes</a>(data, <span class="keyword">true</span>));
<a name="l00054"></a>00054                     }
<a name="l00055"></a>00055                     cache.Set(key, c);<span class="comment">//Save to cache (may trigger cleanup)</span>
<a name="l00056"></a>00056                 }
<a name="l00057"></a>00057                 Serve(current, e, c);
<a name="l00058"></a>00058                 <span class="keywordflow">return</span>;
<a name="l00059"></a>00059             });
<a name="l00060"></a>00060 
<a name="l00061"></a>00061         }
<a name="l00062"></a>00062 
<a name="l00063"></a>00063         <span class="keyword">private</span> <span class="keywordtype">void</span> Serve(HttpContext context, <a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html" title="A collection of data and callbacks that can be passed to a caching object.">IResponseArgs</a> e, MemCacheResult result) {
<a name="l00064"></a>00064             context.RemapHandler(<span class="keyword">new</span> MemCacheHandler(e,result.Data));
<a name="l00065"></a>00065         }
<a name="l00066"></a>00066         
<a name="l00067"></a>00067 
<a name="l00068"></a>00068         <span class="keyword">public</span> IPlugin Install(Configuration.Config c) {
<a name="l00069"></a>00069             c.Plugins.add_plugin(<span class="keyword">this</span>);
<a name="l00070"></a>00070             <span class="keywordflow">return</span> <span class="keyword">this</span>;
<a name="l00071"></a>00071         }
<a name="l00072"></a>00072 
<a name="l00073"></a>00073         <span class="keyword">public</span> <span class="keywordtype">bool</span> Uninstall(Configuration.Config c) {
<a name="l00074"></a>00074             c.Plugins.remove_plugin(<span class="keyword">this</span>);
<a name="l00075"></a>00075             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00076"></a>00076         }
<a name="l00077"></a>00077 
<a name="l00078"></a>00078     }
<a name="l00079"></a>00079 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Events</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
