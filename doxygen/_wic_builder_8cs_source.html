<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>ImageResizer: C:/Users/nathanael/Documents/resizer/Plugins/Wic/WicBuilder.cs Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="imageresizer-logo-00aec4.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">ImageResizer
   &#160;<span id="projectnumber">3.4.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Events</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_0b4eaef40a1fe20bedafe9e8e719ce66.html">Plugins</a></li><li class="navelem"><a class="el" href="dir_631d991aa83f8e307d4242057f5c6ccd.html">Wic</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">WicBuilder.cs</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">using</span> System;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="keyword">using</span> System.Collections.Generic;</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="keyword">using</span> System.Text;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="keyword">using</span> ImageResizer.Resizing;</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="keyword">using</span> ImageResizer.Encoding;</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="keyword">using</span> ImageResizer.Configuration.Issues;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="keyword">using</span> ImageResizer.Util;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="keyword">using</span> ImageResizer.Plugins.Basic;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="keyword">using</span> System.IO;</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="keyword">using</span> ImageResizer.Plugins.Wic.InteropServices.ComTypes;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="keyword">using</span> System.Drawing;</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="keyword">using</span> ImageResizer.Plugins.Wic.InteropServices;</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="keyword">using</span> ImageResizer.Configuration;</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="keyword">using</span> ImageResizer.Plugins.Wic;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="keyword">using</span> System.Web.Hosting;</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="keyword">using</span> System.Runtime.InteropServices;</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="keyword">using</span> System.Runtime.InteropServices.ComTypes;</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="keyword">using</span> ImageResizer.Plugins.WicEncoder;</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="keyword">using</span> System.Globalization;</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="keyword">using</span> ImageResizer.ExtensionMethods;</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;</div>
<div class="line"><a name="l00022"></a><span class="lineno"><a class="line" href="namespace_image_resizer_1_1_plugins_1_1_wic_builder.html">   22</a></span>&#160;<span class="keyword">namespace </span>ImageResizer.Plugins.WicBuilder {</div>
<div class="line"><a name="l00023"></a><span class="lineno"><a class="line" href="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin.html">   23</a></span>&#160;    <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin.html">WicBuilderPlugin</a> : <a class="code" href="class_image_resizer_1_1_resizing_1_1_builder_extension.html">BuilderExtension</a>, <a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_plugin.html">IPlugin</a>, <a class="code" href="interface_image_resizer_1_1_configuration_1_1_issues_1_1_i_issue_provider.html">IIssueProvider</a>, <a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_file_extension_plugin.html">IFileExtensionPlugin</a> {</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;        <span class="keyword">public</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin.html">WicBuilderPlugin</a>() {</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;        }</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;        <a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html">Config</a> c;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;        <span class="keyword">public</span> <a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_plugin.html">IPlugin</a> Install(Configuration.Config c) {</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;            c.Plugins.add_plugin(<span class="keyword">this</span>);</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;            this.c = c;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">this</span>;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;        }</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;        <span class="keyword">public</span> <span class="keywordtype">bool</span> Uninstall(Configuration.Config c) {</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;            c.Plugins.remove_plugin(<span class="keyword">this</span>);</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;        }</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment">        /// &lt;summary&gt;</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment">        /// Adds alternate pipeline based on WIC. Invoked by &amp;builder=wic. </span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="comment">        /// This method doesn&#39;t handle job.DisposeSource or job.DesposeDest or settings filtering, that&#39;s handled by ImageBuilder.</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment">        /// Handles all the work for turning &#39;source&#39; into a byte[]/long pair.</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment">        /// &lt;/summary&gt;</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="comment">        /// &lt;param name=&quot;job&quot;&gt;&lt;/param&gt;</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="comment">        /// &lt;returns&gt;&lt;/returns&gt;</span></div>
<div class="line"><a name="l00048"></a><span class="lineno"><a class="line" href="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin.html#ac298ce3871e1c85220f40da82b483205">   48</a></span>&#160;<span class="comment"></span>        <span class="keyword">protected</span> <span class="keyword">override</span> <a class="code" href="namespace_image_resizer_1_1_resizing.html#a22bbb53580a122efe469a26ad584fa86">RequestedAction</a> <a class="code" href="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin.html#ac298ce3871e1c85220f40da82b483205">BuildJob</a>(<a class="code" href="class_image_resizer_1_1_image_job.html">ImageJob</a> job) {</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;            <span class="keywordflow">if</span> (!<span class="stringliteral">&quot;wic&quot;</span>.Equals(job.<a class="code" href="class_image_resizer_1_1_image_job.html#ab835a4dde8a2962bbe48182641316cee">Settings</a>[<span class="stringliteral">&quot;builder&quot;</span>])) <span class="keywordflow">return</span> RequestedAction.None;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;            <span class="comment">//Convert the source stream to a byte[] array and length.</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;            byte[] data = null;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;            <span class="keywordtype">long</span> lData = 0;</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;            <span class="comment">//This step gets a Stream instance, copies it to a MemoryStream, then accesses the underlying buffer to get the byte[] and length we need.</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;            Stream s = null;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;            <span class="keywordtype">bool</span> disposeStream = !(job.Source is Stream);</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;            <span class="keywordtype">long</span> originalPosition = 0;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;            <span class="keywordtype">bool</span> restoreStreamPosition = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;            <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;                <span class="comment">//Get a Stream instance for the job</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;                <span class="keywordtype">string</span> path;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;                s = c.CurrentImageBuilder.GetStreamFromSource(job.Source, job.Settings, ref disposeStream, out path, out restoreStreamPosition);</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;                <span class="keywordflow">if</span> (s == null) <span class="keywordflow">return</span> RequestedAction.None; <span class="comment">//We don&#39;t support the source object!</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;                <span class="keywordflow">if</span> (job.<a class="code" href="class_image_resizer_1_1_image_job.html#aa6cb13a20ee55698d62de78f6d749d07">ResetSourceStream</a>) restoreStreamPosition = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;                job.SourcePathData = path;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;                <span class="comment">//Save the original stream positione</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;                originalPosition = (restoreStreamPosition) ? s.Position : -1;</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;                data = <a class="code" href="class_image_resizer_1_1_extension_methods_1_1_stream_extensions.html">StreamExtensions</a>.<a class="code" href="class_image_resizer_1_1_extension_methods_1_1_stream_extensions.html#a37c8daa2d13e4f2343b80b352a91796a">CopyOrReturnBuffer</a>(s, out lData,<span class="keyword">false</span>, 0x1000);</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;            } <span class="keywordflow">finally</span> {</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;                <span class="keywordflow">if</span> (s != null &amp;&amp; restoreStreamPosition &amp;&amp; s.CanSeek) s.Seek(originalPosition, SeekOrigin.Begin);</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;                <span class="keywordflow">if</span> (disposeStream) s.Dispose();</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;            }</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;            <span class="comment">//Ok, now we have our byte[] and length. </span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;            <span class="comment">//Let&#39;s find out if transparency is supported.</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;            <a class="code" href="interface_image_resizer_1_1_encoding_1_1_i_encoder.html">IEncoder</a> managedEncoder = c.Plugins.GetEncoder(job.Settings, job.SourcePathData);</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;            <span class="keywordtype">bool</span> supportsTransparency = managedEncoder.SupportsTransparency;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;            <a class="code" href="namespace_image_resizer_1_1_resizing.html#a22bbb53580a122efe469a26ad584fa86">RequestedAction</a> result = BuildJobWic(data, lData, job, supportsTransparency);</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;            GC.KeepAlive(data);</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;            <span class="keywordflow">return</span> result;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;        }</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="comment">        /// &lt;summary&gt;</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="comment">        /// Decodes the image in byte[] data, performs the image proccessing, and encodes it to job.Dest</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="comment">        /// &lt;/summary&gt;</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="comment">        /// &lt;param name=&quot;data&quot;&gt;The buffer containing the encoded image file&lt;/param&gt;</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="comment">        /// &lt;param name=&quot;lData&quot;&gt;The number of bytes to read&lt;/param&gt;</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="comment">        /// &lt;param name=&quot;job&quot;&gt;&lt;/param&gt;</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="comment">        /// &lt;param name=&quot;supportsTransparency&quot;&gt;&lt;/param&gt;</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="comment">        /// &lt;returns&gt;&lt;/returns&gt;</span></div>
<div class="line"><a name="l00098"></a><span class="lineno"><a class="line" href="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin.html#a07987e59f23e7abf59d863db13240f42">   98</a></span>&#160;<span class="comment"></span>        <span class="keyword">protected</span> <span class="keyword">virtual</span> <a class="code" href="namespace_image_resizer_1_1_resizing.html#a22bbb53580a122efe469a26ad584fa86">RequestedAction</a> <a class="code" href="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin.html#a07987e59f23e7abf59d863db13240f42">BuildJobWic</a>(byte[] data, <span class="keywordtype">long</span> lData, <a class="code" href="class_image_resizer_1_1_image_job.html">ImageJob</a> job, <span class="keywordtype">bool</span> supportsTransparency) {</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;            <a class="code" href="class_image_resizer_1_1_resize_settings.html">ResizeSettings</a> settings = job.Settings; <a class="code" href="class_image_resizer_1_1_resize_settings.html">ResizeSettings</a> q = settings;</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;            <span class="keywordtype">string</span> path = job.SourcePathData;</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;            <span class="comment">//A list of COM objects to destroy</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;            List&lt;object&gt; com = <span class="keyword">new</span> List&lt;object&gt;();</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;            <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;                <span class="comment">//Create the factory</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;                <a class="code" href="interface_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_i_w_i_c_component_factory.html">IWICComponentFactory</a> factory  = (<a class="code" href="interface_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_i_w_i_c_component_factory.html">IWICComponentFactory</a>)<span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_w_i_c_imaging_factory.html">WICImagingFactory</a>();</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;                com.Add(factory);</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;                <span class="comment">//Wrap the byte[] with a IWICStream instance</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;                var streamWrapper = factory.CreateStream();</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;                streamWrapper.InitializeFromMemory(data, (uint)lData);</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;                com.Add(streamWrapper);</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;                var decoder = factory.CreateDecoderFromStream(streamWrapper, null,</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;                                                              WICDecodeOptions.WICDecodeMetadataCacheOnLoad);</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;                com.Add(decoder);</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;                <span class="comment">//Figure out which frame to work with</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;                <span class="keywordtype">int</span> frameIndex = 0;</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;                <span class="keywordflow">if</span> (!<span class="keywordtype">string</span>.IsNullOrEmpty(q[<span class="stringliteral">&quot;page&quot;</span>]) &amp;&amp; !int.TryParse(q[<span class="stringliteral">&quot;page&quot;</span>], NumberStyles.Number, NumberFormatInfo.InvariantInfo, out frameIndex))</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;                    <span class="keywordflow">if</span> (!<span class="keywordtype">string</span>.IsNullOrEmpty(q[<span class="stringliteral">&quot;frame&quot;</span>]) &amp;&amp; !int.TryParse(q[<span class="stringliteral">&quot;frame&quot;</span>], NumberStyles.Number, NumberFormatInfo.InvariantInfo, out frameIndex))</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;                        frameIndex = 0;</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;                <span class="comment">//So users can use 1-based numbers</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;                frameIndex--;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;                <span class="keywordflow">if</span> (frameIndex &gt; 0) {</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;                    <span class="keywordtype">int</span> frameCount = (int)decoder.GetFrameCount(); <span class="comment">//Don&#39;t let the user go past the end.</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;                    <span class="keywordflow">if</span> (frameIndex &gt;= frameCount) frameIndex = frameCount - 1;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;                }</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;                <a class="code" href="interface_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_i_w_i_c_bitmap_frame_decode.html">IWICBitmapFrameDecode</a> frame = decoder.GetFrame((uint)Math.Max(0,frameIndex));</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                com.Add(frame);</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;                </div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;                WICBitmapInterpolationMode interpolationMode = WICBitmapInterpolationMode.WICBitmapInterpolationModeFant;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;                <span class="keywordflow">if</span> (<span class="stringliteral">&quot;nearest&quot;</span>.Equals(settings[<span class="stringliteral">&quot;w.filter&quot;</span>], StringComparison.OrdinalIgnoreCase)) interpolationMode = WICBitmapInterpolationMode.WICBitmapInterpolationModeNearestNeighbor;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;                if (<span class="stringliteral">&quot;bicubic&quot;</span>.Equals(settings[<span class="stringliteral">&quot;w.filter&quot;</span>], StringComparison.OrdinalIgnoreCase)) interpolationMode = WICBitmapInterpolationMode.WICBitmapInterpolationModeCubic;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;                if (<span class="stringliteral">&quot;linear&quot;</span>.Equals(settings[<span class="stringliteral">&quot;w.filter&quot;</span>], StringComparison.OrdinalIgnoreCase)) interpolationMode = WICBitmapInterpolationMode.WICBitmapInterpolationModeLinear;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;                if (<span class="stringliteral">&quot;nearestneighbor&quot;</span>.Equals(settings[<span class="stringliteral">&quot;w.filter&quot;</span>], StringComparison.OrdinalIgnoreCase)) interpolationMode = WICBitmapInterpolationMode.WICBitmapInterpolationModeLinear;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;                </div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;                <span class="comment">//Find the original image size</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;                uint origWidth, origHeight;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;                frame.GetSize(out origWidth,out origHeight);</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;                Size orig = <span class="keyword">new</span> Size((<span class="keywordtype">int</span>)origWidth,(<span class="keywordtype">int</span>)origHeight);</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;                Guid pixelFormat;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;                frame.GetPixelFormat(out pixelFormat);</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;                <span class="comment">//Calculate the new size of the image and the canvas.</span></div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;                <a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html">ImageState</a> state = <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html">ImageState</a>(settings, orig, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;                c.CurrentImageBuilder.Process(state);</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;                Rectangle imageDest = PolygonMath.ToRectangle(PolygonMath.GetBoundingBox(state.layout[<span class="stringliteral">&quot;image&quot;</span>]));</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;              </div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;                <a class="code" href="interface_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_i_w_i_c_bitmap_source.html">IWICBitmapSource</a> imageData = frame; </div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;                <span class="comment">//Are we cropping? then daisy-chain a clipper</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;                <span class="keywordflow">if</span> (state.copyRect.Left != 0 || state.copyRect.Top != 0 || state.copyRect.Width != state.originalSize.Width || state.copyRect.Height != state.originalSize.Height) {</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;                    <span class="comment">//Cropping is absurdly slow... 4x slower than resizing!</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;                    <span class="comment">//Cropping after resizing (unintuitively) is faster.</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;                    <span class="keywordflow">if</span> (imageDest.Width != state.originalSize.Width || imageDest.Height != state.originalSize.Height) {</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;                        <span class="keywordtype">double</span> sx = (double)imageDest.Width / (<span class="keywordtype">double</span>)state.copyRect.Width;</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;                        <span class="keywordtype">double</span> sy = (double)imageDest.Height / (<span class="keywordtype">double</span>)state.copyRect.Height;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;                        uint uncroppedDestWidth = (uint)Math.Round(sx * state.originalSize.Width);</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;                        uint uncroppedDestHeight = (uint)Math.Round(sy * state.originalSize.Height);</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;                        </div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;                        var scaler = factory.CreateBitmapScaler();</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;                        scaler.Initialize(imageData, uncroppedDestWidth, uncroppedDestHeight, interpolationMode);</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;                        com.Add(scaler);</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;                        <span class="comment">//TODO: cropping is not consistent with GDI.</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;                        var clipper = factory.CreateBitmapClipper();</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;                        clipper.Initialize(scaler, <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_w_i_c_rect.html">WICRect</a> { </div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;                            <a class="code" href="namespace_image_resizer.html#ae28e0dd90e308cbc414def9313e66362a02129bb861061d1a052c592e2dc6b383">X</a> = (int)Math.Floor((<span class="keywordtype">double</span>)state.copyRect.X * sx),</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;                            <a class="code" href="namespace_image_resizer.html#ae28e0dd90e308cbc414def9313e66362a57cec4137b614c87cb4e24a3d003a3e0">Y</a> = (int)Math.Floor((<span class="keywordtype">double</span>)state.copyRect.Y * sy), </div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                            Width = imageDest.Width, </div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;                            Height = imageDest.Height</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;                        });</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;                        com.Add(clipper);</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;                        imageData = clipper;</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;                        var clipper = factory.CreateBitmapClipper();</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;                        clipper.Initialize(imageData, <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_w_i_c_rect.html">WICRect</a> { <a class="code" href="namespace_image_resizer.html#ae28e0dd90e308cbc414def9313e66362a02129bb861061d1a052c592e2dc6b383">X</a> = (int)state.copyRect.X, <a class="code" href="namespace_image_resizer.html#ae28e0dd90e308cbc414def9313e66362a57cec4137b614c87cb4e24a3d003a3e0">Y</a> = (<span class="keywordtype">int</span>)state.copyRect.Y, Width = (int)state.copyRect.Width, Height = (<span class="keywordtype">int</span>)state.copyRect.Height });</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;                        com.Add(clipper);</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;                        imageData = clipper;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;                    }</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;                    <span class="comment">//If we&#39;re scaling but not cropping.</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;                }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (imageDest.Width != state.originalSize.Width || imageDest.Height != state.originalSize.Height) {</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;                    var scaler = factory.CreateBitmapScaler();</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;                    scaler.Initialize(imageData, (uint)imageDest.Width, (uint)imageDest.Height, interpolationMode);</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;                    com.Add(scaler);</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;                    imageData = scaler;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;                }</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;                </div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;                <span class="comment">//Are we padding? Then we have to do an intermediate write.</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;                <span class="keywordflow">if</span> (state.destSize.Width != imageDest.Width || state.destSize.Height != imageDest.Height){</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;                    byte[] bgcolor = ConversionUtils.ConvertColor(job.Settings.BackgroundColor, pixelFormat);</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;                    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; bgcolor.Length; i++) bgcolor[i] = 255; <span class="comment">//White</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;                    var padder = <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_wic_1_1_wic_bitmap_padder.html">WicBitmapPadder</a>(imageData, imageDest.X, imageDest.Y, state.destSize.Width - (imageDest.X + imageDest.Width), state.destSize.Height - (imageDest.Y + imageDest.Height), bgcolor, null);</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;                    imageData = padder;</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;                }</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;                <span class="comment">//Now encode imageData and be done with it...</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;                <span class="keywordflow">return</span> Encode(factory, imageData, imageDest.Size, job);</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;            } <span class="keywordflow">finally</span> {</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;                <span class="comment">//Manually cleanup all the com reference counts, aggressively</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;                <span class="keywordflow">while</span> (com.Count &gt; 0) {</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;                    Marshal.ReleaseComObject(com[com.Count - 1]); <span class="comment">//In reverse order, so no item is ever deleted out from under another.</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;                    com.RemoveAt(com.Count - 1);</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;                }</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;            }</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;        }</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        <span class="keyword">protected</span> <span class="keyword">virtual</span> <a class="code" href="namespace_image_resizer_1_1_resizing.html#a22bbb53580a122efe469a26ad584fa86">RequestedAction</a> Encode(<a class="code" href="interface_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_i_w_i_c_component_factory.html">IWICComponentFactory</a> factory, <a class="code" href="interface_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_i_w_i_c_bitmap_source.html">IWICBitmapSource</a> data, Size imageSize, <a class="code" href="class_image_resizer_1_1_image_job.html">ImageJob</a> job) {</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;            <a class="code" href="class_image_resizer_1_1_plugins_1_1_wic_encoder_1_1_wic_encoder_plugin.html">WicEncoderPlugin</a> encoder = <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_wic_encoder_1_1_wic_encoder_plugin.html">WicEncoderPlugin</a>(job.<a class="code" href="class_image_resizer_1_1_image_job.html#ab835a4dde8a2962bbe48182641316cee">Settings</a>, job.<a class="code" href="class_image_resizer_1_1_image_job.html#abcb3343acc3389bbefeae232b2a26773">SourcePathData</a>); </div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160; </div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;            <span class="comment">//Create the IStream/MemoryStream</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;            var outputStream = <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_memory_i_stream.html">MemoryIStream</a>();</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;            encoder.EncodeToStream(factory, data, imageSize, outputStream);</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;            <span class="keywordtype">object</span> dest = job.Dest;</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;            <span class="comment">// Try to save the bitmap</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;            <span class="keywordflow">if</span> (dest is <span class="keywordtype">string</span>) {</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;                <span class="comment">//Make physical and resolve variable references all at the same time.</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;                job.FinalPath = job.ResolveTemplatedPath(job.Dest as string,</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;                    delegate(<span class="keywordtype">string</span> var) {</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;                        <span class="keywordflow">if</span> (<span class="stringliteral">&quot;ext&quot;</span>.Equals(var, StringComparison.OrdinalIgnoreCase)) <span class="keywordflow">return</span> encoder.Extension;</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;                        <span class="keywordflow">if</span> (<span class="stringliteral">&quot;width&quot;</span>.Equals(var, StringComparison.OrdinalIgnoreCase)) <span class="keywordflow">return</span> imageSize.Width.ToString();</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;                        <span class="keywordflow">if</span> (<span class="stringliteral">&quot;height&quot;</span>.Equals(var, StringComparison.OrdinalIgnoreCase)) <span class="keywordflow">return</span> imageSize.Height.ToString();</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                        <span class="keywordflow">return</span> null;</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;                    });</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;                <span class="comment">//If requested, auto-create the parent directory(ies)</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;                <span class="keywordflow">if</span> (job.<a class="code" href="class_image_resizer_1_1_image_job.html#aa364f02160b72d8fb1b0df47d65e59b5">CreateParentDirectory</a>) {</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;                    <span class="keywordtype">string</span> dirName = Path.GetDirectoryName(job.FinalPath);</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;                    <span class="keywordflow">if</span> (!Directory.Exists(dirName)) Directory.CreateDirectory(dirName);</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;                }</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;                <span class="keyword">using</span> (FileStream fs = <span class="keyword">new</span> FileStream(job.<a class="code" href="class_image_resizer_1_1_image_job.html#a4ffc5aa55609b62ecbda6b35ba019745">FinalPath</a>, FileMode.OpenOrCreate, FileAccess.Write, FileShare.None)) {</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;                    outputStream.WriteTo(fs);</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                }</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dest is Stream) {</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                outputStream.WriteTo((Stream)dest);</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">return</span> RequestedAction.None;</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;            <span class="keywordflow">return</span> RequestedAction.Cancel;</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;        }</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;        <span class="keyword">public</span> IEnumerable&lt;IIssue&gt; GetIssues() {</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;            List&lt;IIssue&gt; issues = <span class="keyword">new</span> List&lt;IIssue&gt;();</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;            <span class="keywordflow">if</span> (Environment.OSVersion.Version.Major &lt; 6) issues.Add(<span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_configuration_1_1_issues_1_1_issue.html">Issue</a>(<span class="stringliteral">&quot;WIC should only be used Windows 7, Server 2008, or higher to prevent stability issues.&quot;</span>, <a class="code" href="namespace_image_resizer_1_1_configuration_1_1_issues.html#ada2af2a44c17c99a124cadb8a92f8555">IssueSeverity</a>.Critical));</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;            <span class="keywordflow">return</span> issues;</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;        }</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;</div>
<div class="line"><a name="l00266"></a><span class="lineno"><a class="line" href="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin.html#ac5da8942efdbf6a92d7736fb9f3d8192">  266</a></span>&#160;        <span class="keyword">public</span> IEnumerable&lt;string&gt; <a class="code" href="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin.html#ac5da8942efdbf6a92d7736fb9f3d8192">GetSupportedFileExtensions</a>() {</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">new</span> <span class="keywordtype">string</span>[]{<span class="stringliteral">&quot;hdp&quot;</span>,<span class="stringliteral">&quot;jxr&quot;</span>,<span class="stringliteral">&quot;wdp&quot;</span>};<span class="comment">//Plus the ones already listed by ImageBuilder</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;            <span class="comment">//We can enumerate available codecs through factory.CreateComponentEnumerator and factory.CreateComponentInfo...</span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;            <span class="comment">//But those codecs only give us Author, CLSID, FriendlyName, SpecVersion, VendorGUID, and Version. No list of supported file extensions.</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;            <span class="comment">//So maybe it&#39;s best to make that user-specified?</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;        }</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    }</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;}</div>
<div class="ttc" id="namespace_image_resizer_1_1_resizing_html_a22bbb53580a122efe469a26ad584fa86"><div class="ttname"><a href="namespace_image_resizer_1_1_resizing.html#a22bbb53580a122efe469a26ad584fa86">ImageResizer.Resizing.RequestedAction</a></div><div class="ttdeci">RequestedAction</div><div class="ttdoc">What to do about remaining handlers/methods for the specified section </div><div class="ttdef"><b>Definition:</b> <a href="_abstract_image_processor_8cs_source.html#l00013">AbstractImageProcessor.cs:13</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_image_job_html_ab835a4dde8a2962bbe48182641316cee"><div class="ttname"><a href="class_image_resizer_1_1_image_job.html#ab835a4dde8a2962bbe48182641316cee">ImageResizer.ImageJob.Settings</a></div><div class="ttdeci">ResizeSettings Settings</div><div class="ttdoc">The image processing settings </div><div class="ttdef"><b>Definition:</b> <a href="_image_job_8cs_source.html#l00136">ImageJob.cs:136</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_image_job_html_abcb3343acc3389bbefeae232b2a26773"><div class="ttname"><a href="class_image_resizer_1_1_image_job.html#abcb3343acc3389bbefeae232b2a26773">ImageResizer.ImageJob.SourcePathData</a></div><div class="ttdeci">string SourcePathData</div><div class="ttdoc">If &amp;#39;source&amp;#39; contains any path-related data, it is copied into this member for use by format detetctio...</div><div class="ttdef"><b>Definition:</b> <a href="_image_job_8cs_source.html#l00189">ImageJob.cs:189</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_plugins_1_1_wic_1_1_wic_bitmap_padder_html"><div class="ttname"><a href="class_image_resizer_1_1_plugins_1_1_wic_1_1_wic_bitmap_padder.html">ImageResizer.Plugins.Wic.WicBitmapPadder</a></div><div class="ttdef"><b>Definition:</b> <a href="_wic_bitmap_padder_8cs_source.html#l00010">WicBitmapPadder.cs:10</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_extension_methods_1_1_stream_extensions_html_a37c8daa2d13e4f2343b80b352a91796a"><div class="ttname"><a href="class_image_resizer_1_1_extension_methods_1_1_stream_extensions.html#a37c8daa2d13e4f2343b80b352a91796a">ImageResizer.ExtensionMethods.StreamExtensions.CopyOrReturnBuffer</a></div><div class="ttdeci">static byte[] CopyOrReturnBuffer(Stream src, out long length, bool entireStream, int chunkSize)</div><div class="ttdoc">Attempts to return a byte[] array containing the remaining portion of the stream. Unlike CopyToBytes(...</div><div class="ttdef"><b>Definition:</b> <a href="_stream_8cs_source.html#l00189">Stream.cs:189</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_w_i_c_rect_html"><div class="ttname"><a href="class_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_w_i_c_rect.html">ImageResizer.Plugins.Wic.InteropServices.ComTypes.WICRect</a></div><div class="ttdef"><b>Definition:</b> <a href="_win_codec_8cs_source.html#l00457">WinCodec.cs:457</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_configuration_1_1_config_html"><div class="ttname"><a href="class_image_resizer_1_1_configuration_1_1_config.html">ImageResizer.Configuration.Config</a></div><div class="ttdef"><b>Definition:</b> <a href="_config_8cs_source.html#l00022">Config.cs:22</a></div></div>
<div class="ttc" id="interface_image_resizer_1_1_configuration_1_1_issues_1_1_i_issue_provider_html"><div class="ttname"><a href="interface_image_resizer_1_1_configuration_1_1_issues_1_1_i_issue_provider.html">ImageResizer.Configuration.Issues.IIssueProvider</a></div><div class="ttdef"><b>Definition:</b> <a href="_i_issue_provider_8cs_source.html#l00007">IIssueProvider.cs:7</a></div></div>
<div class="ttc" id="namespace_image_resizer_1_1_configuration_1_1_issues_html_ada2af2a44c17c99a124cadb8a92f8555"><div class="ttname"><a href="namespace_image_resizer_1_1_configuration_1_1_issues.html#ada2af2a44c17c99a124cadb8a92f8555">ImageResizer.Configuration.Issues.IssueSeverity</a></div><div class="ttdeci">IssueSeverity</div><div class="ttdef"><b>Definition:</b> <a href="_issue_severity_8cs_source.html#l00007">IssueSeverity.cs:7</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_extension_methods_1_1_stream_extensions_html"><div class="ttname"><a href="class_image_resizer_1_1_extension_methods_1_1_stream_extensions.html">ImageResizer.ExtensionMethods.StreamExtensions</a></div><div class="ttdoc">Provides extension methods for copying streams </div><div class="ttdef"><b>Definition:</b> <a href="_stream_8cs_source.html#l00012">Stream.cs:12</a></div></div>
<div class="ttc" id="namespace_image_resizer_html_ae28e0dd90e308cbc414def9313e66362a57cec4137b614c87cb4e24a3d003a3e0"><div class="ttname"><a href="namespace_image_resizer.html#ae28e0dd90e308cbc414def9313e66362a57cec4137b614c87cb4e24a3d003a3e0">ImageResizer.Y</a></div><div class="ttdoc">Flip vertically (identical to 180 degree rotation) </div></div>
<div class="ttc" id="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin_html_a07987e59f23e7abf59d863db13240f42"><div class="ttname"><a href="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin.html#a07987e59f23e7abf59d863db13240f42">ImageResizer.Plugins.WicBuilder.WicBuilderPlugin.BuildJobWic</a></div><div class="ttdeci">virtual RequestedAction BuildJobWic(byte[] data, long lData, ImageJob job, bool supportsTransparency)</div><div class="ttdoc">Decodes the image in byte[] data, performs the image proccessing, and encodes it to job...</div><div class="ttdef"><b>Definition:</b> <a href="_wic_builder_8cs_source.html#l00098">WicBuilder.cs:98</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_image_job_html_a4ffc5aa55609b62ecbda6b35ba019745"><div class="ttname"><a href="class_image_resizer_1_1_image_job.html#a4ffc5aa55609b62ecbda6b35ba019745">ImageResizer.ImageJob.FinalPath</a></div><div class="ttdeci">string FinalPath</div><div class="ttdoc">Contains the final physical path to the image (if &amp;#39;dest&amp;#39; was a path - null otherwise) ...</div><div class="ttdef"><b>Definition:</b> <a href="_image_job_8cs_source.html#l00178">ImageJob.cs:178</a></div></div>
<div class="ttc" id="interface_image_resizer_1_1_plugins_1_1_i_file_extension_plugin_html"><div class="ttname"><a href="interface_image_resizer_1_1_plugins_1_1_i_file_extension_plugin.html">ImageResizer.Plugins.IFileExtensionPlugin</a></div><div class="ttdoc">For plugins that add support for new source file image extensions. </div><div class="ttdef"><b>Definition:</b> <a href="_i_file_extension_plugin_8cs_source.html#l00010">IFileExtensionPlugin.cs:10</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin_html_ac298ce3871e1c85220f40da82b483205"><div class="ttname"><a href="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin.html#ac298ce3871e1c85220f40da82b483205">ImageResizer.Plugins.WicBuilder.WicBuilderPlugin.BuildJob</a></div><div class="ttdeci">override RequestedAction BuildJob(ImageJob job)</div><div class="ttdoc">Adds alternate pipeline based on WIC. Invoked by &amp;amp;builder=wic. This method doesn&amp;#39;t handle job...</div><div class="ttdef"><b>Definition:</b> <a href="_wic_builder_8cs_source.html#l00048">WicBuilder.cs:48</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_image_job_html"><div class="ttname"><a href="class_image_resizer_1_1_image_job.html">ImageResizer.ImageJob</a></div><div class="ttdef"><b>Definition:</b> <a href="_image_job_8cs_source.html#l00010">ImageJob.cs:10</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_resize_settings_html"><div class="ttname"><a href="class_image_resizer_1_1_resize_settings.html">ImageResizer.ResizeSettings</a></div><div class="ttdoc">Represents the settings which will be used to process the image. Extends NameValueCollection to provi...</div><div class="ttdef"><b>Definition:</b> <a href="_resize_settings_8cs_source.html#l00020">ResizeSettings.cs:20</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_plugins_1_1_wic_encoder_1_1_wic_encoder_plugin_html"><div class="ttname"><a href="class_image_resizer_1_1_plugins_1_1_wic_encoder_1_1_wic_encoder_plugin.html">ImageResizer.Plugins.WicEncoder.WicEncoderPlugin</a></div><div class="ttdef"><b>Definition:</b> <a href="_wic_encoder_8cs_source.html#l00016">WicEncoder.cs:16</a></div></div>
<div class="ttc" id="interface_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_i_w_i_c_component_factory_html"><div class="ttname"><a href="interface_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_i_w_i_c_component_factory.html">ImageResizer.Plugins.Wic.InteropServices.ComTypes.IWICComponentFactory</a></div><div class="ttdef"><b>Definition:</b> <a href="_win_codec_sdk_8cs_source.html#l00516">WinCodecSdk.cs:516</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_image_job_html_aa364f02160b72d8fb1b0df47d65e59b5"><div class="ttname"><a href="class_image_resizer_1_1_image_job.html#aa364f02160b72d8fb1b0df47d65e59b5">ImageResizer.ImageJob.CreateParentDirectory</a></div><div class="ttdeci">bool CreateParentDirectory</div><div class="ttdoc">Defaults to false. When true, the parent directory of the destination filename will be created if it ...</div><div class="ttdef"><b>Definition:</b> <a href="_image_job_8cs_source.html#l00217">ImageJob.cs:217</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_resizing_1_1_image_state_html"><div class="ttname"><a href="class_image_resizer_1_1_resizing_1_1_image_state.html">ImageResizer.Resizing.ImageState</a></div><div class="ttdoc">Encapsulates the state of an image being resized. Can be used to simulate a resize as well as actuall...</div><div class="ttdef"><b>Definition:</b> <a href="_image_state_8cs_source.html#l00015">ImageState.cs:15</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin_html"><div class="ttname"><a href="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin.html">ImageResizer.Plugins.WicBuilder.WicBuilderPlugin</a></div><div class="ttdef"><b>Definition:</b> <a href="_wic_builder_8cs_source.html#l00023">WicBuilder.cs:23</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_configuration_1_1_issues_1_1_issue_html"><div class="ttname"><a href="class_image_resizer_1_1_configuration_1_1_issues_1_1_issue.html">ImageResizer.Configuration.Issues.Issue</a></div><div class="ttdef"><b>Definition:</b> <a href="_issue_8cs_source.html#l00007">Issue.cs:7</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_resizing_1_1_builder_extension_html"><div class="ttname"><a href="class_image_resizer_1_1_resizing_1_1_builder_extension.html">ImageResizer.Resizing.BuilderExtension</a></div><div class="ttdoc">Provides a useable base class that can be used to modify the behavior of ImageBuilder. When registered with an ImageBuilder instance, the ImageBuilder will call the corresponding methods on the extension prior to executing its own methods. </div><div class="ttdef"><b>Definition:</b> <a href="_builder_extension_8cs_source.html#l00011">BuilderExtension.cs:11</a></div></div>
<div class="ttc" id="interface_image_resizer_1_1_plugins_1_1_i_plugin_html"><div class="ttname"><a href="interface_image_resizer_1_1_plugins_1_1_i_plugin.html">ImageResizer.Plugins.IPlugin</a></div><div class="ttdoc">All plugins must implement this. Enables web.config addition and removal. </div><div class="ttdef"><b>Definition:</b> <a href="_i_plugin_8cs_source.html#l00011">IPlugin.cs:11</a></div></div>
<div class="ttc" id="interface_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_i_w_i_c_bitmap_source_html"><div class="ttname"><a href="interface_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_i_w_i_c_bitmap_source.html">ImageResizer.Plugins.Wic.InteropServices.ComTypes.IWICBitmapSource</a></div><div class="ttdef"><b>Definition:</b> <a href="_win_codec_8cs_source.html#l00673">WinCodec.cs:673</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin_html_ac5da8942efdbf6a92d7736fb9f3d8192"><div class="ttname"><a href="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin.html#ac5da8942efdbf6a92d7736fb9f3d8192">ImageResizer.Plugins.WicBuilder.WicBuilderPlugin.GetSupportedFileExtensions</a></div><div class="ttdeci">IEnumerable&lt; string &gt; GetSupportedFileExtensions()</div><div class="ttdoc">If the plugin adds support for new file extensions (such as &amp;quot;psd&amp;quot;), they should be returned by this m...</div><div class="ttdef"><b>Definition:</b> <a href="_wic_builder_8cs_source.html#l00266">WicBuilder.cs:266</a></div></div>
<div class="ttc" id="namespace_image_resizer_html_ae28e0dd90e308cbc414def9313e66362a02129bb861061d1a052c592e2dc6b383"><div class="ttname"><a href="namespace_image_resizer.html#ae28e0dd90e308cbc414def9313e66362a02129bb861061d1a052c592e2dc6b383">ImageResizer.X</a></div><div class="ttdoc">Flip horizontally </div></div>
<div class="ttc" id="class_image_resizer_1_1_image_job_html_aa6cb13a20ee55698d62de78f6d749d07"><div class="ttname"><a href="class_image_resizer_1_1_image_job.html#aa6cb13a20ee55698d62de78f6d749d07">ImageResizer.ImageJob.ResetSourceStream</a></div><div class="ttdeci">bool ResetSourceStream</div><div class="ttdoc">If true, and if &amp;#39;source&amp;#39; is seekable, the stream will be reset to its previous position after being r...</div><div class="ttdef"><b>Definition:</b> <a href="_image_job_8cs_source.html#l00160">ImageJob.cs:160</a></div></div>
<div class="ttc" id="interface_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_i_w_i_c_bitmap_frame_decode_html"><div class="ttname"><a href="interface_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_i_w_i_c_bitmap_frame_decode.html">ImageResizer.Plugins.Wic.InteropServices.ComTypes.IWICBitmapFrameDecode</a></div><div class="ttdef"><b>Definition:</b> <a href="_win_codec_8cs_source.html#l01410">WinCodec.cs:1410</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_w_i_c_imaging_factory_html"><div class="ttname"><a href="class_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_w_i_c_imaging_factory.html">ImageResizer.Plugins.Wic.InteropServices.ComTypes.WICImagingFactory</a></div><div class="ttdef"><b>Definition:</b> <a href="_win_codec_8cs_source.html#l02388">WinCodec.cs:2388</a></div></div>
<div class="ttc" id="interface_image_resizer_1_1_encoding_1_1_i_encoder_html"><div class="ttname"><a href="interface_image_resizer_1_1_encoding_1_1_i_encoder.html">ImageResizer.Encoding.IEncoder</a></div><div class="ttdoc">An image encoder. Exposes methods for suitability checking, encoding, transparency compatibility chec...</div><div class="ttdef"><b>Definition:</b> <a href="_i_encoder_8cs_source.html#l00013">IEncoder.cs:13</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_memory_i_stream_html"><div class="ttname"><a href="class_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_memory_i_stream.html">ImageResizer.Plugins.Wic.InteropServices.MemoryIStream</a></div><div class="ttdef"><b>Definition:</b> <a href="_memory_i_stream_8cs_source.html#l00007">MemoryIStream.cs:7</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.5
</small></address>
</body>
</html>
