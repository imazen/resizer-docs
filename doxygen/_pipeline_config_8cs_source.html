<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ImageResizer: C:/Users/Administrator/Documents/resizer/Core/Configuration/PipelineConfig.cs Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="resizer-icon-64.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">ImageResizer
   &#160;<span id="projectnumber">3.2.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">C:/Users/Administrator/Documents/resizer/Core/Configuration/PipelineConfig.cs</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 ï»¿<span class="comment">/* Copyright (c) 2011 Nathanael Jones. See license.txt */</span>
<a name="l00002"></a>00002 <span class="keyword">using</span> System;
<a name="l00003"></a>00003 <span class="keyword">using</span> System.Collections.Generic;
<a name="l00004"></a>00004 <span class="keyword">using</span> System.Text;
<a name="l00005"></a>00005 <span class="keyword">using</span> ImageResizer.Configuration;
<a name="l00006"></a>00006 <span class="keyword">using</span> ImageResizer.Plugins;
<a name="l00007"></a>00007 <span class="keyword">using</span> System.Collections.ObjectModel;
<a name="l00008"></a>00008 <span class="keyword">using</span> System.Collections.Specialized;
<a name="l00009"></a>00009 <span class="keyword">using</span> ImageResizer.Caching;
<a name="l00010"></a>00010 <span class="keyword">using</span> ImageResizer.Configuration.Issues;
<a name="l00011"></a>00011 <span class="keyword">using</span> ImageResizer.Encoding;
<a name="l00012"></a>00012 <span class="keyword">using</span> System.Web.Hosting;
<a name="l00013"></a>00013 <span class="keyword">using</span> ImageResizer.Collections;
<a name="l00014"></a>00014 <span class="keyword">using</span> System.Web;
<a name="l00015"></a>00015 <span class="keyword">using</span> System.Security.Permissions;
<a name="l00016"></a>00016 <span class="keyword">using</span> System.Runtime.InteropServices;
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="keyword">namespace </span>ImageResizer.Configuration {
<a name="l00019"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html">00019</a>     <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html">PipelineConfig</a> : <a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_pipeline_config.html">IPipelineConfig</a>, <a class="code" href="interface_image_resizer_1_1_caching_1_1_i_cache_provider.html" title="Provides cache selection logic.">ICacheProvider</a>, <a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_settings_modifier.html" title="Provides a way to modify settings before they reach the managed API. Does not execute early enough to...">ISettingsModifier</a>{
<a name="l00020"></a>00020         <span class="keyword">protected</span> <a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html">Config</a> c;
<a name="l00021"></a>00021         <span class="keyword">public</span> <a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html">PipelineConfig</a>(<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html">Config</a> c) {
<a name="l00022"></a>00022             this.c = c;
<a name="l00023"></a>00023 
<a name="l00024"></a>00024             c.<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html#aa8cdada7d657ec3078e5d16310f198f7" title="Access and modify plugins.">Plugins</a>.<a class="code" href="class_image_resizer_1_1_configuration_1_1_plugin_config.html#ae571e06c5e5e95bfe4891d4f6db05aab" title="Plugins which accept querystring arguments are registered here.">QuerystringPlugins</a>.Changed += <span class="keyword">new</span> SafeList&lt;IQuerystringPlugin&gt;.ChangedHandler(urlModifyingPlugins_Changed);
<a name="l00025"></a>00025             
<a name="l00026"></a>00026         }
<a name="l00027"></a>00027 
<a name="l00028"></a>00028         <span class="keyword">protected</span> <span class="keywordtype">void</span> urlModifyingPlugins_Changed(SafeList&lt;IQuerystringPlugin&gt; sender) {
<a name="l00029"></a>00029             lock (_cachedUrlDataSync) {
<a name="l00030"></a>00030                 _cachedDirectives = null;
<a name="l00031"></a>00031                 _cachedExtensions = null;
<a name="l00032"></a>00032             }
<a name="l00033"></a>00033         }
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 
<a name="l00036"></a>00036         <span class="keyword">protected</span> <span class="keywordtype">object</span> _cachedUrlDataSync = <span class="keyword">new</span> object();
<a name="l00037"></a>00037 
<a name="l00038"></a>00038                 [CLSCompliant(<span class="keyword">false</span>)]
<a name="l00039"></a>00039         <span class="keyword">protected</span> <span class="keyword">volatile</span> Dictionary&lt;string, bool&gt; _cachedDirectives = null;
<a name="l00040"></a>00040 
<a name="l00041"></a>00041                 [CLSCompliant(<span class="keyword">false</span>)]
<a name="l00042"></a>00042         <span class="keyword">protected</span> <span class="keyword">volatile</span> Dictionary&lt;string, bool&gt; _cachedExtensions = null;
<a name="l00043"></a>00043 <span class="comment"></span>
<a name="l00044"></a>00044 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00045"></a>00045 <span class="comment">        /// Populates the cache if it is empty. Not thread safe.</span>
<a name="l00046"></a>00046 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00047"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#aa8f6df84e08a6d2f0872ecc7333aa9d9">00047</a> <span class="comment"></span>        <span class="keyword">protected</span> <span class="keywordtype">void</span> <a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#aa8f6df84e08a6d2f0872ecc7333aa9d9" title="Populates the cache if it is empty. Not thread safe.">_cacheUrlData</a>() {
<a name="l00048"></a>00048             <span class="keywordflow">if</span> (_cachedDirectives != null &amp;&amp; _cachedExtensions != null) <span class="keywordflow">return</span>;
<a name="l00049"></a>00049 
<a name="l00050"></a>00050             Dictionary&lt;string, bool&gt; directives = <span class="keyword">new</span> Dictionary&lt;string, bool&gt;(48,StringComparer.OrdinalIgnoreCase);
<a name="l00051"></a>00051             Dictionary&lt;string, bool&gt; exts = <span class="keyword">new</span> Dictionary&lt;string, bool&gt;(24,StringComparer.OrdinalIgnoreCase);
<a name="l00052"></a>00052             IEnumerable&lt;string&gt; vals = null;
<a name="l00053"></a>00053             <span class="comment">//Check the plugins</span>
<a name="l00054"></a>00054             <span class="keywordflow">foreach</span> (<a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_querystring_plugin.html" title="For plugins that access the query string (important!)">IQuerystringPlugin</a> p <span class="keywordflow">in</span> c.<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html#aa8cdada7d657ec3078e5d16310f198f7" title="Access and modify plugins.">Plugins</a>.<a class="code" href="class_image_resizer_1_1_configuration_1_1_plugin_config.html#ae571e06c5e5e95bfe4891d4f6db05aab" title="Plugins which accept querystring arguments are registered here.">QuerystringPlugins</a>) {
<a name="l00055"></a>00055 
<a name="l00056"></a>00056                 vals = p.<a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_querystring_plugin.html#aaa1c43be9b92caf1f1caa81dc9e9f4bf" title="If the plugin reads any values from the querystring, the names of the keys should be specified here...">GetSupportedQuerystringKeys</a>();
<a name="l00057"></a>00057                 <span class="keywordflow">if</span> (vals != null)
<a name="l00058"></a>00058                     <span class="keywordflow">foreach</span> (<span class="keywordtype">string</span> s <span class="keywordflow">in</span> vals)
<a name="l00059"></a>00059                         directives[s] = <span class="keyword">true</span>;
<a name="l00060"></a>00060             }
<a name="l00061"></a>00061             <span class="keywordflow">foreach</span> (<a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_file_extension_plugin.html" title="For plugins that add support for new source file image extensions.">IFileExtensionPlugin</a> p <span class="keywordflow">in</span> c.<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html#aa8cdada7d657ec3078e5d16310f198f7" title="Access and modify plugins.">Plugins</a>.<a class="code" href="class_image_resizer_1_1_configuration_1_1_plugin_config.html#afd4acc644c1be2e2ac6ec9f928964d63" title="Plugins which accept new file extensions (in the url) are registered here.">FileExtensionPlugins</a>) {
<a name="l00062"></a>00062                 vals = p.<a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_file_extension_plugin.html#a53672fd2aee854a01f313f099c95b330" title="If the plugin adds support for new file extensions (such as &quot;psd&quot;), they should be returned by this m...">GetSupportedFileExtensions</a>();
<a name="l00063"></a>00063                 <span class="keywordflow">if</span> (vals != null)
<a name="l00064"></a>00064                     <span class="keywordflow">foreach</span> (<span class="keywordtype">string</span> e <span class="keywordflow">in</span> vals)
<a name="l00065"></a>00065                         exts[e.TrimStart(<span class="charliteral">&#39;.&#39;</span>)] = <span class="keyword">true</span>;
<a name="l00066"></a>00066             }
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 
<a name="l00069"></a>00069             <span class="comment">//Now check the imagebuider instance</span>
<a name="l00070"></a>00070             <a class="code" href="class_image_resizer_1_1_image_builder.html" title="Provides methods for generating resized images, and for reading and writing them to disk...">ImageBuilder</a> b = c.<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html#a9b11da5f1856427a835034d52700c093" title="Returns a shared instance of ImageManager, (or a subclass if it has been upgraded). Instances change whenever ImageBuilderExtensions change.">CurrentImageBuilder</a>;
<a name="l00071"></a>00071             <span class="keywordflow">if</span> (b != null) {
<a name="l00072"></a>00072                 vals = b.<a class="code" href="class_image_resizer_1_1_image_builder.html#a303922cae5567e1e58462695000ec705" title="Returns a list of the file extensions ImageBuilder can load by default. Plugins can implement IFileEx...">GetSupportedFileExtensions</a>();
<a name="l00073"></a>00073                 <span class="keywordflow">if</span> (vals != null)
<a name="l00074"></a>00074                     <span class="keywordflow">foreach</span> (<span class="keywordtype">string</span> e <span class="keywordflow">in</span> vals)
<a name="l00075"></a>00075                         exts[e.TrimStart(<span class="charliteral">&#39;.&#39;</span>)] = <span class="keyword">true</span>;
<a name="l00076"></a>00076 
<a name="l00077"></a>00077                 vals = b.<a class="code" href="class_image_resizer_1_1_image_builder.html#a4d055522b14dc97d8edf5eb8ec3a1296" title="Returns a list of the querystring commands ImageBuilder can parse by default. Plugins can implement I...">GetSupportedQuerystringKeys</a>();
<a name="l00078"></a>00078                 <span class="keywordflow">if</span> (vals != null)
<a name="l00079"></a>00079                     <span class="keywordflow">foreach</span> (<span class="keywordtype">string</span> s <span class="keywordflow">in</span> vals)
<a name="l00080"></a>00080                         directives[s] = <span class="keyword">true</span>;
<a name="l00081"></a>00081             }
<a name="l00082"></a>00082 
<a name="l00083"></a>00083             _cachedDirectives = directives;
<a name="l00084"></a>00084             _cachedExtensions = exts;
<a name="l00085"></a>00085             
<a name="l00086"></a>00086         }
<a name="l00087"></a>00087         <span class="keyword">protected</span> Dictionary&lt;string, bool&gt; getCachedDirectives(){
<a name="l00088"></a>00088             lock (_cachedUrlDataSync) {
<a name="l00089"></a>00089                 _cacheUrlData();
<a name="l00090"></a>00090                 <span class="keywordflow">return</span> _cachedDirectives;
<a name="l00091"></a>00091             }
<a name="l00092"></a>00092         }
<a name="l00093"></a>00093         <span class="keyword">protected</span> Dictionary&lt;string, bool&gt; getCachedExtensions(){
<a name="l00094"></a>00094             lock (_cachedUrlDataSync) {
<a name="l00095"></a>00095                 _cacheUrlData();
<a name="l00096"></a>00096                 <span class="keywordflow">return</span> _cachedExtensions;
<a name="l00097"></a>00097             }
<a name="l00098"></a>00098         }<span class="comment"></span>
<a name="l00099"></a>00099 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00100"></a>00100 <span class="comment">        /// Returns a unqiue copy of the image extensions supported by the pipeline. Performs a cached query to all registered IQuerystringPlugin instances.</span>
<a name="l00101"></a>00101 <span class="comment">        /// Use IsAcceptedImageType for better performance.</span>
<a name="l00102"></a>00102 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00103"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a8f026db1293e7c0fd0b97ed493ee8c15">00103</a> <span class="comment"></span>        <span class="keyword">public</span> ICollection&lt;string&gt; AcceptedImageExtensions {
<a name="l00104"></a>00104             <span class="keyword">get</span> {
<a name="l00105"></a>00105                 <span class="keywordflow">return</span> <span class="keyword">new</span> List&lt;string&gt;(getCachedExtensions().Keys);
<a name="l00106"></a>00106             }
<a name="l00107"></a>00107         }<span class="comment"></span>
<a name="l00108"></a>00108 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00109"></a>00109 <span class="comment">        /// Returns a unqiue copy of all querystring keys supported by the pipeline. Performs a cached query to all registered IQuerystringPlugin instances.</span>
<a name="l00110"></a>00110 <span class="comment">        /// Use HasPipelineDirective for better performance. (binary search)</span>
<a name="l00111"></a>00111 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00112"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a77ed6d765d0fb15f54c5803ab097a81e">00112</a> <span class="comment"></span>        <span class="keyword">public</span> ICollection&lt;string&gt; SupportedQuerystringKeys {
<a name="l00113"></a>00113             <span class="keyword">get</span> {
<a name="l00114"></a>00114                 <span class="keywordflow">return</span> <span class="keyword">new</span> List&lt;string&gt;(getCachedDirectives().Keys);
<a name="l00115"></a>00115             }
<a name="l00116"></a>00116         }
<a name="l00117"></a>00117 
<a name="l00118"></a>00118         <span class="keyword">protected</span> <span class="keywordtype">string</span> getExtension(<span class="keywordtype">string</span> path) {
<a name="l00119"></a>00119             <span class="comment">//Trim off the extension</span>
<a name="l00120"></a>00120             <span class="keywordtype">int</span> lastDot = path.LastIndexOfAny(<span class="keyword">new</span> <span class="keywordtype">char</span>[] { <span class="charliteral">&#39;.&#39;</span>, <span class="charliteral">&#39;/&#39;</span>, <span class="charliteral">&#39; &#39;</span>, <span class="charliteral">&#39;\\&#39;</span>, <span class="charliteral">&#39;?&#39;</span>, <span class="charliteral">&#39;&amp;&#39;</span>, <span class="charliteral">&#39;:&#39;</span> });
<a name="l00121"></a>00121             <span class="keywordflow">if</span> (lastDot &gt; -1 &amp;&amp; path[lastDot] == <span class="charliteral">&#39;.&#39;</span>) <span class="keywordflow">return</span> path.Substring(lastDot + 1);
<a name="l00122"></a>00122             <span class="keywordflow">else</span> <span class="keywordflow">return</span> null;
<a name="l00123"></a>00123         }
<a name="l00124"></a>00124 <span class="comment"></span>
<a name="l00125"></a>00125 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00126"></a>00126 <span class="comment">        /// The specified path must not include a querystring. Slashes, spaces, question marks, ampersands, and colons are not permitted in the extension.</span>
<a name="l00127"></a>00127 <span class="comment">        /// If it contains a multipart extension like .txt.zip, only &quot;zip&quot; will be recognized.</span>
<a name="l00128"></a>00128 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00129"></a>00129 <span class="comment">        /// &lt;param name=&quot;path&quot;&gt;&lt;/param&gt;</span>
<a name="l00130"></a>00130 <span class="comment">        /// &lt;returns&gt;&lt;/returns&gt;</span>
<a name="l00131"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a4296081aec59d9bfb3675869358fc94b">00131</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a4296081aec59d9bfb3675869358fc94b" title="The specified path must not include a querystring. Slashes, spaces, question marks, ampersands, and colons are not permitted in the extension. If it contains a multipart extension like .txt.zip, only &quot;zip&quot; will be recognized.">IsAcceptedImageType</a>(<span class="keywordtype">string</span> path) {
<a name="l00132"></a>00132             <span class="keywordtype">string</span> ext = getExtension(path);
<a name="l00133"></a>00133             <span class="keywordflow">if</span> (<span class="keywordtype">string</span>.IsNullOrEmpty(ext)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00134"></a>00134             <span class="keywordflow">return</span> getCachedExtensions().ContainsKey(ext);
<a name="l00135"></a>00135         }<span class="comment"></span>
<a name="l00136"></a>00136 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00137"></a>00137 <span class="comment">        /// Returns true if any of the querystring keys match any of the directives supported by the pipeline (such as width, height, format, bgcolor, etc)</span>
<a name="l00138"></a>00138 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00139"></a>00139 <span class="comment">        /// &lt;param name=&quot;q&quot;&gt;&lt;/param&gt;</span>
<a name="l00140"></a>00140 <span class="comment">        /// &lt;returns&gt;&lt;/returns&gt;</span>
<a name="l00141"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a61d80fb5b0aaa0e2dd37cb549b0b669a">00141</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a61d80fb5b0aaa0e2dd37cb549b0b669a" title="Returns true if any of the querystring keys match any of the directives supported by the pipeline (su...">HasPipelineDirective</a>(System.Collections.Specialized.NameValueCollection q) {
<a name="l00142"></a>00142             <span class="comment">//Did you know that ASP.NET puts null keys into the QueryString?</span>
<a name="l00143"></a>00143             Dictionary&lt;string, bool&gt; dirs = getCachedDirectives();
<a name="l00144"></a>00144             <span class="comment">//The querystring always has fewer items than the cachedDirectives, so loop it instead.</span>
<a name="l00145"></a>00145             <span class="keywordflow">foreach</span> (<span class="keywordtype">string</span> key <span class="keywordflow">in</span> q.Keys) {
<a name="l00146"></a>00146                 <span class="keywordflow">if</span> (key != null &amp;&amp; dirs.ContainsKey(key)) <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">//Binary search, hashtable impl</span>
<a name="l00147"></a>00147             }
<a name="l00148"></a>00148             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00149"></a>00149         }
<a name="l00150"></a>00150 
<a name="l00151"></a>00151                 [CLSCompliant(<span class="keyword">false</span>)]
<a name="l00152"></a>00152         <span class="keyword">protected</span> <span class="keyword">volatile</span> IList&lt;string&gt; _fakeExtensions = null;
<a name="l00153"></a>00153 <span class="comment"></span>
<a name="l00154"></a>00154 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00155"></a>00155 <span class="comment">        /// Cached access to pipeline.fakeExtensions</span>
<a name="l00156"></a>00156 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00157"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a262dec0173e2e256864a00bfb099dbdb">00157</a> <span class="comment"></span>        <span class="keyword">public</span> IList&lt;string&gt; FakeExtensions {
<a name="l00158"></a>00158             <span class="keyword">get</span> {
<a name="l00159"></a>00159                 IList&lt;string&gt; temp = _fakeExtensions;
<a name="l00160"></a>00160                 <span class="keywordflow">if</span> (temp != null) <span class="keywordflow">return</span> temp;
<a name="l00161"></a>00161                 <span class="keywordflow">else</span> temp = <span class="keyword">new</span> List&lt;string&gt;(c.get(<span class="stringliteral">&quot;pipeline.fakeExtensions&quot;</span>,<span class="stringliteral">&quot;.ashx&quot;</span>).Split(<span class="keyword">new</span> <span class="keywordtype">char</span>[]{<span class="charliteral">&#39;,&#39;</span>}, StringSplitOptions.RemoveEmptyEntries));
<a name="l00162"></a>00162                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; temp.Count; i++) {
<a name="l00163"></a>00163                     <span class="keywordflow">if</span> (!temp[i].StartsWith(<span class="stringliteral">&quot;.&quot;</span>, StringComparison.OrdinalIgnoreCase)) temp[i] = <span class="stringliteral">&quot;.&quot;</span> + temp[i];
<a name="l00164"></a>00164                 }
<a name="l00165"></a>00165                 _fakeExtensions = temp;
<a name="l00166"></a>00166                 <span class="keywordflow">return</span> temp;
<a name="l00167"></a>00167             }
<a name="l00168"></a>00168         }<span class="comment"></span>
<a name="l00169"></a>00169 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00170"></a>00170 <span class="comment">        /// Removes the first fake extensionm detected at the end of &#39;path&#39;</span>
<a name="l00171"></a>00171 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00172"></a>00172 <span class="comment">        /// &lt;param name=&quot;path&quot;&gt;&lt;/param&gt;</span>
<a name="l00173"></a>00173 <span class="comment">        /// &lt;returns&gt;&lt;/returns&gt;</span>
<a name="l00174"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a197ee79d2a3ed339c11565dd093af605">00174</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">string</span> <a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a197ee79d2a3ed339c11565dd093af605" title="Removes the first fake extensionm detected at the end of &#39;path&#39;.">TrimFakeExtensions</a>(<span class="keywordtype">string</span> path) {
<a name="l00175"></a>00175             <span class="keywordflow">foreach</span> (<span class="keywordtype">string</span> s <span class="keywordflow">in</span> FakeExtensions) {
<a name="l00176"></a>00176                 <span class="keywordflow">if</span> (path.EndsWith(s, StringComparison.OrdinalIgnoreCase)) {
<a name="l00177"></a>00177                     path = path.Substring(0, path.Length - s.Length).TrimEnd(<span class="charliteral">&#39;.&#39;</span>);
<a name="l00178"></a>00178                     <span class="keywordflow">break</span>;
<a name="l00179"></a>00179                 }
<a name="l00180"></a>00180             }
<a name="l00181"></a>00181             <span class="keywordflow">return</span> path;
<a name="l00182"></a>00182         }
<a name="l00183"></a>00183 
<a name="l00184"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a8480435bdee1b4418333609e5a29cb4e">00184</a>         <span class="keyword">public</span> <span class="keywordtype">string</span> ModifiedPathKey {
<a name="l00185"></a>00185             <span class="keyword">get</span> { <span class="keywordflow">return</span> <span class="stringliteral">&quot;resizer.newPath&quot;</span>; }
<a name="l00186"></a>00186         }
<a name="l00187"></a>00187 
<a name="l00188"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a104764d90bb14b6920487d5871817af1">00188</a>         <span class="keyword">public</span> <span class="keywordtype">string</span> StopRoutingKey {
<a name="l00189"></a>00189             <span class="keyword">get</span> { <span class="keywordflow">return</span> <span class="stringliteral">&quot;resizer.stopRouting&quot;</span>; }
<a name="l00190"></a>00190         }<span class="comment"></span>
<a name="l00191"></a>00191 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00192"></a>00192 <span class="comment">        /// Returns the value of Context.Items[&quot;resizer.newPath&quot;] if present. If not, returns FilePath + PathInfo.</span>
<a name="l00193"></a>00193 <span class="comment">        /// Sets Context.Items[&quot;resizer.newPath&quot;]. </span>
<a name="l00194"></a>00194 <span class="comment">        /// Only useful during the Pipeline.PostAuthorizeRequestStart event.</span>
<a name="l00195"></a>00195 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00196"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#ae5f95c1a02cd5be7fdb3e3f92b254af3">00196</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">string</span> PreRewritePath {
<a name="l00197"></a>00197             <span class="keyword">get</span> {
<a name="l00198"></a>00198                 <span class="keywordflow">if</span> (HttpContext.Current == null) <span class="keywordflow">return</span> null;
<a name="l00199"></a>00199                 <span class="keywordflow">return</span> HttpContext.Current.Items[ModifiedPathKey] != null ? HttpContext.Current.Items[ModifiedPathKey] as <span class="keywordtype">string</span> :
<a name="l00200"></a>00200                     (HttpContext.Current.Request.FilePath + HttpContext.Current.Request.PathInfo);
<a name="l00201"></a>00201 
<a name="l00202"></a>00202             }
<a name="l00203"></a>00203             <span class="keyword">set</span> {
<a name="l00204"></a>00204                 HttpContext.Current.Items[ModifiedPathKey] = value;
<a name="l00205"></a>00205             }
<a name="l00206"></a>00206         }
<a name="l00207"></a>00207 
<a name="l00208"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#aeacd69c60ff3907665abdec5ef81d762">00208</a>         <span class="keyword">public</span> <span class="keywordtype">string</span> ModifiedQueryStringKey {
<a name="l00209"></a>00209             <span class="keyword">get</span> { <span class="keywordflow">return</span> <span class="stringliteral">&quot;resizer.modifiedQueryString&quot;</span>; }
<a name="l00210"></a>00210         }
<a name="l00211"></a>00211 
<a name="l00212"></a>00212         <span class="comment"></span>
<a name="l00213"></a>00213 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00214"></a>00214 <span class="comment">        /// Returns the modified query string. If never set, returns a copy of Request.QueryString.</span>
<a name="l00215"></a>00215 <span class="comment">        /// Returns the same instance if called multiple times. Copy it if you want to make changes without causing issues.</span>
<a name="l00216"></a>00216 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00217"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a84692589f794762a95f605f2afd7bfe9">00217</a> <span class="comment"></span>        <span class="keyword">public</span> NameValueCollection ModifiedQueryString {
<a name="l00218"></a>00218             <span class="keyword">get</span> {
<a name="l00219"></a>00219                 <span class="keywordflow">if</span> (HttpContext.Current == null) <span class="keywordflow">return</span> null;
<a name="l00220"></a>00220                 <span class="keywordflow">if</span> (HttpContext.Current.Items[ModifiedQueryStringKey] == null)
<a name="l00221"></a>00221                     HttpContext.Current.Items[ModifiedQueryStringKey] = <span class="keyword">new</span> NameValueCollection(HttpContext.Current.Request.QueryString);
<a name="l00222"></a>00222 
<a name="l00223"></a>00223                 <span class="keywordflow">return</span> (NameValueCollection)HttpContext.Current.Items[ModifiedQueryStringKey];
<a name="l00224"></a>00224             }
<a name="l00225"></a>00225             <span class="keyword">set</span> {
<a name="l00226"></a>00226                 HttpContext.Current.Items[ModifiedQueryStringKey] = value;
<a name="l00227"></a>00227             }
<a name="l00228"></a>00228         }
<a name="l00229"></a>00229 
<a name="l00230"></a>00230 
<a name="l00231"></a>00231         <span class="keyword">public</span> <span class="keywordtype">string</span> SkipFileTypeCheckKey { <span class="keyword">get</span> { <span class="keywordflow">return</span> <span class="stringliteral">&quot;resizer.skipFileTypeCheck&quot;</span>; } }<span class="comment"></span>
<a name="l00232"></a>00232 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00233"></a>00233 <span class="comment">        /// Get or sets whether the file extension check should be applied to the current request. Defaults to true.</span>
<a name="l00234"></a>00234 <span class="comment">        /// If set to true, will only affect the current request, and will only cause the Resizer to evaluate the rewriting rules on the request.</span>
<a name="l00235"></a>00235 <span class="comment">        /// Processing may still not occur if no querystring values are specified. Add &#39;cache=always&#39; to force caching to occur.</span>
<a name="l00236"></a>00236 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00237"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#af5af1ba6d323efbfa0ed58254509febb">00237</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> SkipFileTypeCheck {
<a name="l00238"></a>00238             <span class="keyword">get</span> { <span class="keywordflow">return</span> HttpContext.Current.Items[SkipFileTypeCheckKey] != null &amp;&amp; (bool)HttpContext.Current.Items[SkipFileTypeCheckKey]; }
<a name="l00239"></a>00239             <span class="keyword">set</span> { HttpContext.Current.Items[SkipFileTypeCheckKey] = value; }
<a name="l00240"></a>00240         }
<a name="l00241"></a>00241 
<a name="l00242"></a>00242 
<a name="l00243"></a>00243 
<a name="l00244"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#ab48b19a69d39efea5e54a1434a51035e">00244</a>         <span class="keyword">public</span> <span class="keywordtype">string</span> ResponseArgsKey {
<a name="l00245"></a>00245             <span class="keyword">get</span> { <span class="keywordflow">return</span> <span class="stringliteral">&quot;resizer.cacheArgs&quot;</span>; }
<a name="l00246"></a>00246         }<span class="comment"></span>
<a name="l00247"></a>00247 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00248"></a>00248 <span class="comment">        /// Returns true if the current request is being processed and/or cached by the pipeline.</span>
<a name="l00249"></a>00249 <span class="comment">        /// Will return false until *after* the FileExists method is called on the VirtualPathProviders, which is after the </span>
<a name="l00250"></a>00250 <span class="comment">        /// AuthorizeImage event fires. </span>
<a name="l00251"></a>00251 <span class="comment">        /// This will return a usable value if used from VirtualFile.Open(), or if used inside the PreHandleImage event or later.</span>
<a name="l00252"></a>00252 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00253"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a2ad16e79513596914944c6cdb63642fa">00253</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> IsHandlingRequest {
<a name="l00254"></a>00254             <span class="keyword">get</span> { <span class="keywordflow">return</span> (System.Web.HttpContext.Current != null &amp;&amp; System.Web.HttpContext.Current.Items[ResponseArgsKey] != null); }
<a name="l00255"></a>00255         }
<a name="l00256"></a>00256         
<a name="l00257"></a>00257 
<a name="l00258"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a576ef4f14028e548cfed585b36884bf1">00258</a>         <span class="keyword">public</span> VppUsageOption VppUsage {
<a name="l00259"></a>00259             <span class="keyword">get</span> {
<a name="l00260"></a>00260                 <span class="keywordflow">return</span> c.get&lt;VppUsageOption&gt;(<span class="stringliteral">&quot;pipeline.vppUsage&quot;</span>, VppUsageOption.Fallback);
<a name="l00261"></a>00261             }
<a name="l00262"></a>00262         }
<a name="l00263"></a>00263 <span class="comment"></span>
<a name="l00264"></a>00264 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00265"></a>00265 <span class="comment">        /// Returns either an IVirtualFile instance or a VirtualFile instance.</span>
<a name="l00266"></a>00266 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00267"></a>00267 <span class="comment">        /// &lt;param name=&quot;virtualPath&quot;&gt;&lt;/param&gt;</span>
<a name="l00268"></a>00268 <span class="comment">        /// &lt;param name=&quot;queryString&quot;&gt;&lt;/param&gt;</span>
<a name="l00269"></a>00269 <span class="comment">        /// &lt;returns&gt;&lt;/returns&gt;</span>
<a name="l00270"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a23d81b98db36e450511ba6481ce02459">00270</a> <span class="comment"></span>        <span class="keyword">public</span> <a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_virtual_file.html" title="A virtual file to support IVirtualImageProvider.">IVirtualFile</a> <a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a23d81b98db36e450511ba6481ce02459" title="Returns either an IVirtualFile instance or a VirtualFile instance.">GetFile</a>(<span class="keywordtype">string</span> virtualPath, NameValueCollection queryString) {
<a name="l00271"></a>00271             <a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_virtual_file.html" title="A virtual file to support IVirtualImageProvider.">IVirtualFile</a> f = null;
<a name="l00272"></a>00272             <span class="keywordflow">foreach</span> (<a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_virtual_image_provider.html" title="Implement this to allow your class (or VirtualPathProvider subclass) to be used without registering i...">IVirtualImageProvider</a> p <span class="keywordflow">in</span> c.<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html#aa8cdada7d657ec3078e5d16310f198f7" title="Access and modify plugins.">Plugins</a>.<a class="code" href="class_image_resizer_1_1_configuration_1_1_plugin_config.html#a517fd7bc29acf4eb910573fbe34997f7" title="Plugins which provide virtual files are registered here.">VirtualProviderPlugins</a>) {
<a name="l00273"></a>00273                 <span class="keywordflow">if</span> (p.<a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_virtual_image_provider.html#adc1f2caa76c242e3c0bb8ed2d824f9c3" title="Returns true if the specified file exists.">FileExists</a>(virtualPath, queryString)) { f = p.<a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_virtual_image_provider.html#aa3bb3191e4ed5cbf957c961d607d611b" title="Returns a virtual file instance for the specified path and querystring.">GetFile</a>(virtualPath, queryString); <span class="keywordflow">break</span>; }
<a name="l00274"></a>00274             }
<a name="l00275"></a>00275             <span class="keywordflow">if</span> (f == null &amp;&amp;  HostingEnvironment.VirtualPathProvider != null &amp;&amp; HostingEnvironment.VirtualPathProvider.FileExists(virtualPath)) f =  <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_virtual_file_wrapper.html" title="Wraps a standard ASP.NET VirtualFile instance in an IVirtualFile-compatible wrapper.">VirtualFileWrapper</a>(HostingEnvironment.VirtualPathProvider.GetFile(virtualPath));
<a name="l00276"></a>00276             <span class="keywordflow">if</span> (f == null) <span class="keywordflow">return</span> null;
<a name="l00277"></a>00277 
<a name="l00278"></a>00278             <span class="comment">//Now we have a reference to the real virtual file, let&#39;s see if it is source-cached.</span>
<a name="l00279"></a>00279             <a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_virtual_file.html" title="A virtual file to support IVirtualImageProvider.">IVirtualFile</a> cached = null;
<a name="l00280"></a>00280             <span class="keywordflow">foreach</span> (<a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_virtual_file_cache.html" title="Implement this if you are caching files provided by a virtual image provider (For example...">IVirtualFileCache</a> p <span class="keywordflow">in</span> c.<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html#aa8cdada7d657ec3078e5d16310f198f7" title="Access and modify plugins.">Plugins</a>.GetAll&lt;<a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_virtual_file_cache.html" title="Implement this if you are caching files provided by a virtual image provider (For example...">IVirtualFileCache</a>&gt;()) {
<a name="l00281"></a>00281                 cached = p.<a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_virtual_file_cache.html#a7c47e218f12b55976cb9da46ef61cfde" title="Returns a cached copy of virtual file if it is cached, and if caching is desired.">GetFileIfCached</a>(virtualPath,queryString,f);
<a name="l00282"></a>00282                 <span class="keywordflow">if</span> (cached != null) <span class="keywordflow">return</span> cached;
<a name="l00283"></a>00283             }
<a name="l00284"></a>00284             <span class="keywordflow">return</span> f;
<a name="l00285"></a>00285         }
<a name="l00286"></a>00286 <span class="comment"></span>
<a name="l00287"></a>00287 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00288"></a>00288 <span class="comment">        /// Returns true if (a) A registered IVirtualImageProvider says it exists, or (b) if the VirtualPathProvider chain says it exists.</span>
<a name="l00289"></a>00289 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00290"></a>00290 <span class="comment">        /// &lt;param name=&quot;virtualPath&quot;&gt;&lt;/param&gt;</span>
<a name="l00291"></a>00291 <span class="comment">        /// &lt;param name=&quot;queryString&quot;&gt;&lt;/param&gt;</span>
<a name="l00292"></a>00292 <span class="comment">        /// &lt;returns&gt;&lt;/returns&gt;</span>
<a name="l00293"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a1abc7d07064e5c4e583406be7a3ebcab">00293</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a1abc7d07064e5c4e583406be7a3ebcab" title="Returns true if (a) A registered IVirtualImageProvider says it exists, or (b) if the VirtualPathProvi...">FileExists</a>(<span class="keywordtype">string</span> virtualPath, NameValueCollection queryString) {
<a name="l00294"></a>00294             <span class="keywordflow">foreach</span> (<a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_virtual_image_provider.html" title="Implement this to allow your class (or VirtualPathProvider subclass) to be used without registering i...">IVirtualImageProvider</a> p <span class="keywordflow">in</span> c.<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html#aa8cdada7d657ec3078e5d16310f198f7" title="Access and modify plugins.">Plugins</a>.<a class="code" href="class_image_resizer_1_1_configuration_1_1_plugin_config.html#a517fd7bc29acf4eb910573fbe34997f7" title="Plugins which provide virtual files are registered here.">VirtualProviderPlugins</a>) {
<a name="l00295"></a>00295                 <span class="keywordflow">if</span> (p.<a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_virtual_image_provider.html#adc1f2caa76c242e3c0bb8ed2d824f9c3" title="Returns true if the specified file exists.">FileExists</a>(virtualPath, queryString)) <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00296"></a>00296             }
<a name="l00297"></a>00297             <span class="keywordflow">return</span> HostingEnvironment.VirtualPathProvider != null ? HostingEnvironment.VirtualPathProvider.FileExists(virtualPath) : <span class="keyword">false</span>;
<a name="l00298"></a>00298         }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300 
<a name="l00301"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#afb5c9480dc0b7ca793c53601c6f12468">00301</a>         <span class="keyword">public</span> <a class="code" href="class_image_resizer_1_1_image_builder.html" title="Provides methods for generating resized images, and for reading and writing them to disk...">ImageBuilder</a> <a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#afb5c9480dc0b7ca793c53601c6f12468" title="Returns an ImageBuilder instance to use for image processing.">GetImageBuilder</a>() {
<a name="l00302"></a>00302             <span class="keywordflow">return</span> c.<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html#a9b11da5f1856427a835034d52700c093" title="Returns a shared instance of ImageManager, (or a subclass if it has been upgraded). Instances change whenever ImageBuilderExtensions change.">CurrentImageBuilder</a>;
<a name="l00303"></a>00303         }
<a name="l00304"></a>00304 
<a name="l00305"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a6f689e397fa681ae317dbb64641defe6">00305</a>         <span class="keyword">public</span> <a class="code" href="interface_image_resizer_1_1_caching_1_1_i_cache_provider.html" title="Provides cache selection logic.">ICacheProvider</a> <a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a6f689e397fa681ae317dbb64641defe6" title="Returns a ICacheProvider instance that provides caching system selection and creation.">GetCacheProvider</a>() {
<a name="l00306"></a>00306             <span class="keywordflow">return</span> <span class="keyword">this</span>;
<a name="l00307"></a>00307         }
<a name="l00308"></a>00308 <span class="comment"></span>
<a name="l00309"></a>00309 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00310"></a>00310 <span class="comment">        /// Fired once, on the first PostAuthorizeRequest event.</span>
<a name="l00311"></a>00311 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00312"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a266d3ab1bf715a03f0449e484e7dfdfc">00312</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keyword">event</span> RequestEventHandler <a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a266d3ab1bf715a03f0449e484e7dfdfc" title="Fired once, on the first PostAuthorizeRequest event.">OnFirstRequest</a>;<span class="comment"></span>
<a name="l00313"></a>00313 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00314"></a>00314 <span class="comment">        /// Fires during the PostAuthorizeRequest phase, prior to any module-specific logic.</span>
<a name="l00315"></a>00315 <span class="comment">        /// Executes for every request to the website. Use only as a last resort. Other events occur only for image requests, and thus have lower overhead.</span>
<a name="l00316"></a>00316 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00317"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#afdeaf7b6498bb1be71ec87e3ba3e770a">00317</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keyword">event</span> RequestEventHandler <a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#afdeaf7b6498bb1be71ec87e3ba3e770a" title="Fires during the PostAuthorizeRequest phase, prior to any module-specific logic. Executes for every r...">PostAuthorizeRequestStart</a>;
<a name="l00318"></a>00318 <span class="comment"></span>
<a name="l00319"></a>00319 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00320"></a>00320 <span class="comment">        /// Fired during PostAuthorizeRequest, after ResizeExtension has been removed.</span>
<a name="l00321"></a>00321 <span class="comment">        /// On fired on requests with extensions that match supported image types.</span>
<a name="l00322"></a>00322 <span class="comment">        /// &lt;para&gt; </span>
<a name="l00323"></a>00323 <span class="comment">        /// You can add additonal supported image extentions by registering a plugin that implementes IQuerystringPlugin, or you can add an </span>
<a name="l00324"></a>00324 <span class="comment">        /// extra extension in the URL and remove it here. Example: .psd.jpg&lt;/para&gt;</span>
<a name="l00325"></a>00325 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00326"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a882cc35fba7bf06aa896938b58e28a47">00326</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keyword">event</span> UrlRewritingEventHandler <a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a882cc35fba7bf06aa896938b58e28a47" title="Fired during PostAuthorizeRequest, after ResizeExtension has been removed. On fired on requests with ...">Rewrite</a>;<span class="comment"></span>
<a name="l00327"></a>00327 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00328"></a>00328 <span class="comment">        /// Fired during PostAuthorizeRequest, after Rewrite.</span>
<a name="l00329"></a>00329 <span class="comment">        /// Any changes made here (which conflict) will be overwritten by the the current querystring values. I.e, this is a good place to specify default settings.</span>
<a name="l00330"></a>00330 <span class="comment">        /// &lt;para&gt;Only fired on accepted image types. (see Rewrite)&lt;/para&gt;</span>
<a name="l00331"></a>00331 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00332"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a3771cef24387993beb9ac618a95be4d1">00332</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keyword">event</span> UrlRewritingEventHandler <a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a3771cef24387993beb9ac618a95be4d1" title="Fired during PostAuthorizeRequest, after Rewrite. Any changes made here (which conflict) will be over...">RewriteDefaults</a>;<span class="comment"></span>
<a name="l00333"></a>00333 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00334"></a>00334 <span class="comment">        /// Fired after all other rewrite events.</span>
<a name="l00335"></a>00335 <span class="comment">        /// &lt;para&gt;Only fired on accepted image types. (see Rewrite)&lt;/para&gt;</span>
<a name="l00336"></a>00336 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00337"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a6bb3b78b217345a660bd19d8d3d91337">00337</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keyword">event</span> UrlRewritingEventHandler <a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a6bb3b78b217345a660bd19d8d3d91337" title="Fired after all other rewrite events.">PostRewrite</a>;<span class="comment"></span>
<a name="l00338"></a>00338 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00339"></a>00339 <span class="comment">        /// Fired after all rewriting is finished.</span>
<a name="l00340"></a>00340 <span class="comment">        /// e.AllowAccess defaults to the result of the UrlAuthorization module&#39;s verdict. It can be changed. </span>
<a name="l00341"></a>00341 <span class="comment">        /// Set e.AllowAccess to true to cause and 403 Access Dened result.</span>
<a name="l00342"></a>00342 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00343"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#ac105b32b257375041ed2ce72c0e19291">00343</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keyword">event</span> UrlAuthorizationEventHandler <a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#ac105b32b257375041ed2ce72c0e19291" title="Fired after all rewriting is finished. e.AllowAccess defaults to the result of the UrlAuthorization m...">AuthorizeImage</a>;
<a name="l00344"></a>00344 
<a name="l00345"></a>00345 <span class="comment"></span>
<a name="l00346"></a>00346 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00347"></a>00347 <span class="comment">        /// Fired when the specified image doesn&#39;t exist. Only called for images that would normally be processed.</span>
<a name="l00348"></a>00348 <span class="comment">        /// May be called during PostAuthorizeRequest or later - End the request completely with a redirect if you want alternate behavior.</span>
<a name="l00349"></a>00349 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00350"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a9d8c742ccffe06bffbcd54220e544cdb">00350</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keyword">event</span> UrlEventHandler <a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a9d8c742ccffe06bffbcd54220e544cdb" title="Fired when the specified image doesn&#39;t exist. Only called for images that would normally be processed...">ImageMissing</a>;
<a name="l00351"></a>00351 <span class="comment"></span>
<a name="l00352"></a>00352 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00353"></a>00353 <span class="comment">        /// Fired immediately before the image request is sent off to the caching system for proccessing.</span>
<a name="l00354"></a>00354 <span class="comment">        /// Allows modification of response headers, caching arguments, and callbacks.</span>
<a name="l00355"></a>00355 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00356"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a0b80ffa6111e6fdb6f0585b10e882cdb">00356</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keyword">event</span> PreHandleImageEventHandler <a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a0b80ffa6111e6fdb6f0585b10e882cdb" title="Fired immediately before the image request is sent off to the caching system for proccessing. Allows modification of response headers, caching arguments, and callbacks.">PreHandleImage</a>;
<a name="l00357"></a>00357 
<a name="l00358"></a>00358         <span class="keyword">public</span> <span class="keyword">event</span> CacheSelectionHandler SelectCachingSystem;
<a name="l00359"></a>00359 
<a name="l00360"></a>00360                 [CLSCompliant(<span class="keyword">false</span>)]
<a name="l00361"></a>00361         <span class="keyword">protected</span> <span class="keyword">volatile</span> <span class="keywordtype">bool</span> firedFirstRequest = <span class="keyword">false</span>;
<a name="l00362"></a>00362 
<a name="l00363"></a>00363         <span class="keyword">protected</span> <span class="keywordtype">object</span> firedFirstRequestSync = <span class="keyword">new</span> object();
<a name="l00364"></a>00364 
<a name="l00365"></a>00365         <span class="keyword">public</span> <span class="keywordtype">void</span> FirePostAuthorizeRequest(System.Web.IHttpModule sender, System.Web.HttpContext httpContext) {
<a name="l00366"></a>00366             <span class="comment">//The one-time event</span>
<a name="l00367"></a>00367             <span class="keywordflow">if</span> (!firedFirstRequest) {
<a name="l00368"></a>00368                 lock (firedFirstRequestSync) {
<a name="l00369"></a>00369                     <span class="keywordflow">if</span> (!firedFirstRequest) {
<a name="l00370"></a>00370                         firedFirstRequest = <span class="keyword">true</span>;
<a name="l00371"></a>00371                         <span class="keywordflow">if</span> (OnFirstRequest != null) OnFirstRequest(sender, httpContext);
<a name="l00372"></a>00372                     }
<a name="l00373"></a>00373                 }
<a name="l00374"></a>00374             }
<a name="l00375"></a>00375             <span class="comment">//And the main event</span>
<a name="l00376"></a>00376             <span class="keywordflow">if</span> (PostAuthorizeRequestStart != null) PostAuthorizeRequestStart(sender, httpContext);
<a name="l00377"></a>00377                    
<a name="l00378"></a>00378         }
<a name="l00379"></a>00379 
<a name="l00380"></a>00380 
<a name="l00381"></a>00381         <span class="keyword">public</span> <span class="keywordtype">void</span> FireRewritingEvents(System.Web.IHttpModule sender, System.Web.HttpContext context, <a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_url_event_args.html">IUrlEventArgs</a> e) {
<a name="l00382"></a>00382 
<a name="l00383"></a>00383             <span class="comment">//TODO: this approach is non-intuitive....</span>
<a name="l00384"></a>00384 
<a name="l00385"></a>00385             <span class="comment">//Fire first event (results will stay in e)</span>
<a name="l00386"></a>00386             <span class="keywordflow">if</span> (Rewrite != null) Rewrite(sender,context, e);
<a name="l00387"></a>00387 
<a name="l00388"></a>00388             <span class="comment">//Copy querystring for use in &#39;defaults&#39; even</span>
<a name="l00389"></a>00389             NameValueCollection copy = <span class="keyword">new</span> NameValueCollection(e.QueryString); <span class="comment">//Copy so we can later overwrite q with the rewrite values.</span>
<a name="l00390"></a>00390 
<a name="l00391"></a>00391             <span class="comment">//Fire defaults event.</span>
<a name="l00392"></a>00392             <span class="keywordflow">if</span> (RewriteDefaults != null) RewriteDefaults(sender, context, e);
<a name="l00393"></a>00393 
<a name="l00394"></a>00394             <span class="comment">//Overwrite with querystring values again - this is what makes applyDefaults applyDefaults, vs. being applyOverrides.</span>
<a name="l00395"></a>00395             <span class="keywordflow">foreach</span> (<span class="keywordtype">string</span> k <span class="keywordflow">in</span> copy) {
<a name="l00396"></a>00396                 <span class="keywordflow">if</span> (copy[k] != null) { <span class="comment">//Don&#39;t allow null values to override defaults. Empty values can, however.</span>
<a name="l00397"></a>00397                     e.QueryString[k] = copy[k];
<a name="l00398"></a>00398                 }
<a name="l00399"></a>00399             }
<a name="l00400"></a>00400             
<a name="l00401"></a>00401             <span class="comment">//Fire final event</span>
<a name="l00402"></a>00402             <span class="keywordflow">if</span> (PostRewrite != null) PostRewrite(sender,context, e);
<a name="l00403"></a>00403         }
<a name="l00404"></a>00404 
<a name="l00405"></a>00405         <span class="keyword">public</span> <span class="keywordtype">void</span> FireAuthorizeImage(System.Web.IHttpModule sender, System.Web.HttpContext context, <a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_url_authorization_event_args.html">IUrlAuthorizationEventArgs</a> e) {
<a name="l00406"></a>00406             <span class="keywordflow">if</span> (AuthorizeImage != null) AuthorizeImage(sender, context, e);
<a name="l00407"></a>00407         }
<a name="l00408"></a>00408 
<a name="l00409"></a>00409         <span class="keyword">public</span> <span class="keywordtype">void</span> FireImageMissing(System.Web.IHttpModule sender, System.Web.HttpContext context, <a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_url_event_args.html">IUrlEventArgs</a> e) {
<a name="l00410"></a>00410             <span class="keywordflow">if</span> (ImageMissing != null) ImageMissing(sender, context, e);
<a name="l00411"></a>00411         }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413         <span class="keyword">protected</span> <span class="keywordtype">long</span> processedCount = 0;<span class="comment"></span>
<a name="l00414"></a>00414 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00415"></a>00415 <span class="comment">        /// The number of images processed by this pipeline.</span>
<a name="l00416"></a>00416 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00417"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#ab6cf7932946b293d427e307b55d3c3bf">00417</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">long</span> ProcessedCount {
<a name="l00418"></a>00418             <span class="keyword">get</span> {
<a name="l00419"></a>00419                 <span class="keywordflow">return</span> processedCount;
<a name="l00420"></a>00420             }
<a name="l00421"></a>00421         }
<a name="l00422"></a>00422 
<a name="l00423"></a>00423         <span class="keyword">public</span> <span class="keywordtype">void</span> FirePreHandleImage(System.Web.IHttpModule sender, System.Web.HttpContext context, <a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html" title="A collection of data and callbacks that can be passed to a caching object.">IResponseArgs</a> e) {
<a name="l00424"></a>00424             System.Threading.Interlocked.Increment(ref processedCount);
<a name="l00425"></a>00425             <span class="keywordflow">if</span> (PreHandleImage != null) PreHandleImage(sender, context, e);
<a name="l00426"></a>00426         }
<a name="l00427"></a>00427 <span class="comment"></span>
<a name="l00428"></a>00428 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00429"></a>00429 <span class="comment">        /// Cache selection occurs as follows: (1) The first registered CachingSystem that returns  true from .CanProcess() is the default</span>
<a name="l00430"></a>00430 <span class="comment">        /// (2) The SelectCachingSystem event is fired, allowing handlers to modify the selected cache. </span>
<a name="l00431"></a>00431 <span class="comment">        /// This method may return null. </span>
<a name="l00432"></a>00432 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00433"></a>00433 <span class="comment">        /// &lt;param name=&quot;context&quot;&gt;&lt;/param&gt;</span>
<a name="l00434"></a>00434 <span class="comment">        /// &lt;param name=&quot;args&quot;&gt;&lt;/param&gt;</span>
<a name="l00435"></a>00435 <span class="comment">        /// &lt;returns&gt;&lt;/returns&gt;</span>
<a name="l00436"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#aa7e4ea3373254e7fa1c2a8e0a6bb7a8a">00436</a> <span class="comment"></span>        <span class="keyword">public</span> <a class="code" href="interface_image_resizer_1_1_caching_1_1_i_cache.html" title="Provides caching behavior.">ICache</a> <a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#aa7e4ea3373254e7fa1c2a8e0a6bb7a8a" title="Cache selection occurs as follows: (1) The first registered CachingSystem that returns true from ...">GetCachingSystem</a>(System.Web.HttpContext context, <a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html" title="A collection of data and callbacks that can be passed to a caching object.">IResponseArgs</a> args) {
<a name="l00437"></a>00437             <a class="code" href="interface_image_resizer_1_1_caching_1_1_i_cache.html" title="Provides caching behavior.">ICache</a> defaultCache = null;
<a name="l00438"></a>00438             <span class="comment">//Grab the first cache that claims it can process the request.</span>
<a name="l00439"></a>00439             <span class="keywordflow">foreach</span> (<a class="code" href="interface_image_resizer_1_1_caching_1_1_i_cache.html" title="Provides caching behavior.">ICache</a> cache <span class="keywordflow">in</span> c.<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html#aa8cdada7d657ec3078e5d16310f198f7" title="Access and modify plugins.">Plugins</a>.<a class="code" href="class_image_resizer_1_1_configuration_1_1_plugin_config.html#a7b17fd669713a797dbfc83eb78b26f4a" title="Currently registered ICache instances.">CachingSystems</a>) {
<a name="l00440"></a>00440                 <span class="keywordflow">if</span> (cache.<a class="code" href="interface_image_resizer_1_1_caching_1_1_i_cache.html#abe6aebbb4a1993a23a05b158729ef60e" title="Returns false if the cache is unable to process the request. If false, the caller should fall back to...">CanProcess</a>(context, args)) {
<a name="l00441"></a>00441                     defaultCache = cache;
<a name="l00442"></a>00442                     <span class="keywordflow">break</span>;
<a name="l00443"></a>00443                 }
<a name="l00444"></a>00444             }
<a name="l00445"></a>00445 
<a name="l00446"></a>00446             <a class="code" href="class_image_resizer_1_1_configuration_1_1_cache_selection_event_args.html">CacheSelectionEventArgs</a> e = <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_configuration_1_1_cache_selection_event_args.html">CacheSelectionEventArgs</a>(context, args, defaultCache);
<a name="l00447"></a>00447             <span class="keywordflow">if</span> (SelectCachingSystem != null) SelectCachingSystem(<span class="keyword">this</span>, e);
<a name="l00448"></a>00448             <span class="keywordflow">return</span> e.SelectedCache;
<a name="l00449"></a>00449         }
<a name="l00450"></a>00450 
<a name="l00451"></a>00451 
<a name="l00452"></a>00452 
<a name="l00453"></a>00453 
<a name="l00454"></a>00454 
<a name="l00455"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#ac5305a41fb712c41f3e2caba61def4d2">00455</a>         <span class="keyword">public</span> <a class="code" href="class_image_resizer_1_1_resize_settings.html" title="Represents the settings which will be used to process the image. Extends NameValueCollection to provi...">ResizeSettings</a> <a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#ac5305a41fb712c41f3e2caba61def4d2" title="Implementations should support being called on their own result multiple times without behavioral dif...">Modify</a>(<a class="code" href="class_image_resizer_1_1_resize_settings.html" title="Represents the settings which will be used to process the image. Extends NameValueCollection to provi...">ResizeSettings</a> settings) {
<a name="l00456"></a>00456             <span class="keywordflow">foreach</span> (<a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_settings_modifier.html" title="Provides a way to modify settings before they reach the managed API. Does not execute early enough to...">ISettingsModifier</a> m <span class="keywordflow">in</span> c.<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html#aa8cdada7d657ec3078e5d16310f198f7" title="Access and modify plugins.">Plugins</a>.<a class="code" href="class_image_resizer_1_1_configuration_1_1_plugin_config.html#a84cb6f5d6e18e51b2c572244888fa0d9" title="Plugins which modify image processing settings.">SettingsModifierPlugins</a>)
<a name="l00457"></a>00457                 settings = m.<a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_settings_modifier.html#a8cdb3583477eb87a90d7689c80b9a9cb" title="Implementations should support being called on their own result multiple times without behavioral dif...">Modify</a>(settings);
<a name="l00458"></a>00458             <span class="keywordflow">return</span> settings;
<a name="l00459"></a>00459         }
<a name="l00460"></a>00460 
<a name="l00461"></a>00461 
<a name="l00462"></a>00462         <span class="keyword">private</span> <span class="keywordtype">bool</span> _moduleInstalled = <span class="keyword">false</span>;<span class="comment"></span>
<a name="l00463"></a>00463 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00464"></a>00464 <span class="comment">        /// True once the InterceptModule has been installed and is intercepting requests.</span>
<a name="l00465"></a>00465 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00466"></a><a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#a0a751ee64627fae3bb176b7f226147ba">00466</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> ModuleInstalled {
<a name="l00467"></a>00467             <span class="keyword">get</span> {
<a name="l00468"></a>00468                 <span class="keywordflow">return</span> _moduleInstalled;
<a name="l00469"></a>00469             }
<a name="l00470"></a>00470             <span class="keyword">set</span> {
<a name="l00471"></a>00471                 _moduleInstalled = value;
<a name="l00472"></a>00472             }
<a name="l00473"></a>00473         }
<a name="l00474"></a>00474     }
<a name="l00475"></a>00475 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Events</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
