<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ImageResizer: ImageResizer.InterceptModule Class Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="resizer-icon-64.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">ImageResizer
   &#160;<span id="projectnumber">3.1.3</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="classes.html"><span>Class&#160;Index</span></a></li>
      <li><a href="inherits.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Events</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="namespace_image_resizer.html">ImageResizer</a>      </li>
      <li class="navelem"><a class="el" href="class_image_resizer_1_1_intercept_module.html">InterceptModule</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#pro-methods">Protected Member Functions</a> &#124;
<a href="#properties">Properties</a>  </div>
  <div class="headertitle">
<div class="title">ImageResizer.InterceptModule Class Reference</div>  </div>
</div><!--header-->
<div class="contents">
<!-- doxytag: class="ImageResizer::InterceptModule" -->
<p>Monitors incoming image requests to determine if resizing (or other processing) is being requested.  
 <a href="class_image_resizer_1_1_intercept_module.html#details">More...</a></p>

<p><a href="class_image_resizer_1_1_intercept_module-members.html">List of all members.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="pro-methods"></a>
Protected Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_image_resizer_1_1_intercept_module.html#ab7a18ae77265d4f17870541448c99fbf">CheckRequest_PostAuthorizeRequest</a> (object sender, EventArgs e)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">This is where we filter requests and intercept those that want resizing performed. We first strip FakeExtension, then verify the remaining file extension is supported for decoding. We fire URL rewriting events. If the result includes any supported querystring params afterwards, we process the request. Otherwise we let it fall back to IIS/ASP.NET. If the file doesn't exist, we also ignore the request. They're going to cause a 404 anyway.  <a href="#ab7a18ae77265d4f17870541448c99fbf"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ae2416623c455acb5f3a01a9449b010a2"></a><!-- doxytag: member="ImageResizer::InterceptModule::FileMissing" ref="ae2416623c455acb5f3a01a9449b010a2" args="(HttpContext httpContext, string virtualPath, NameValueCollection q)" -->
void&#160;</td><td class="memItemRight" valign="bottom"><b>FileMissing</b> (HttpContext httpContext, string virtualPath, NameValueCollection q)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_image_resizer_1_1_intercept_module.html#a55916ea27e905902663d2813fcfc9ebf">HandleRequest</a> (HttpContext context, string virtualPath, NameValueCollection queryString, <a class="el" href="interface_image_resizer_1_1_plugins_1_1_i_virtual_file.html">IVirtualFile</a> vf)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Generates the resized image to disk (if needed), then rewrites the request to that location. Perform 404 checking before calling this method. Assumes file exists. Called during PostAuthorizeRequest.  <a href="#a55916ea27e905902663d2813fcfc9ebf"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_image_resizer_1_1_intercept_module.html#a9938e258c26e277886d13712010aaa34">context_PreSendRequestHeaders</a> (object sender, EventArgs e)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">We don't actually send the data - but we still want to control the headers on the data. PreSendRequestHeaders allows us to change the content-type and cache headers at excatly the last.  <a href="#a9938e258c26e277886d13712010aaa34"></a><br/></td></tr>
<tr><td colspan="2"><h2><a name="properties"></a>
Properties</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="interface_image_resizer_1_1_configuration_1_1_i_pipeline_config.html">IPipelineConfig</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce">conf</a><code> [get]</code></td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Current configuration. Same as Config.Current.Pipeline.  <a href="#a58d5e9e6dfce4ac70f2c81abbb7414ce"></a><br/></td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>Monitors incoming image requests to determine if resizing (or other processing) is being requested. </p>

<p>Definition at line <a class="el" href="_intercept_module_8cs_source.html#l00025">25</a> of file <a class="el" href="_intercept_module_8cs_source.html">InterceptModule.cs</a>.</p>
</div><hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="ab7a18ae77265d4f17870541448c99fbf"></a><!-- doxytag: member="ImageResizer::InterceptModule::CheckRequest_PostAuthorizeRequest" ref="ab7a18ae77265d4f17870541448c99fbf" args="(object sender, EventArgs e)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">virtual void <a class="el" href="class_image_resizer_1_1_intercept_module.html#ab7a18ae77265d4f17870541448c99fbf">ImageResizer.InterceptModule.CheckRequest_PostAuthorizeRequest</a> </td>
          <td>(</td>
          <td class="paramtype">object&#160;</td>
          <td class="paramname"><em>sender</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">EventArgs&#160;</td>
          <td class="paramname"><em>e</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [inline, protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>This is where we filter requests and intercept those that want resizing performed. We first strip FakeExtension, then verify the remaining file extension is supported for decoding. We fire URL rewriting events. If the result includes any supported querystring params afterwards, we process the request. Otherwise we let it fall back to IIS/ASP.NET. If the file doesn't exist, we also ignore the request. They're going to cause a 404 anyway. </p>
<dl class="params"><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">sender</td><td></td></tr>
    <tr><td class="paramname">e</td><td></td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="_intercept_module_8cs_source.html#l00061">61</a> of file <a class="el" href="_intercept_module_8cs_source.html">InterceptModule.cs</a>.</p>
<div class="fragment"><pre class="fragment">                                                                                             {
            <span class="comment">//Skip requests if the Request object isn&#39;t populated</span>
            HttpApplication app = sender as HttpApplication;
            <span class="keywordflow">if</span> (app == null) <span class="keywordflow">return</span>;
            <span class="keywordflow">if</span> (app.Context == null) <span class="keywordflow">return</span>;
            <span class="keywordflow">if</span> (app.Context.Request == null) <span class="keywordflow">return</span>;

            <a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.FirePostAuthorizeRequest(<span class="keyword">this</span>, app.Context);

            

            <span class="comment">//Allow handlers of the above event to change filePath/pathinfo so we can successfull test the extension</span>
            <span class="keywordtype">string</span> originalPath = <a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.<a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_pipeline_config.html#a850c81766a61687b9652390e18667668" title="Returns the value of Context.Items[&quot;resizer.newPath&quot;] if present. If not, returns FilePath + PathInfo...">PreRewritePath</a>;
           
            <span class="comment">//Trim fake extensions so IsAcceptedImageType will work properly</span>
            <span class="keywordtype">string</span> filePath = <a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.<a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_pipeline_config.html#ab753ce5af44cfd042aead3e747e03276" title="Removes the first fake extension detected at the end of &#39;path&#39; (like image.jpg.ashx -&gt; image...">TrimFakeExtensions</a>(originalPath);

            
            <span class="comment">//Is this an image request? Checks the file extension for .jpg, .png, .tiff, etc.</span>
            <span class="keywordflow">if</span> (<a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.<a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_pipeline_config.html#a77bea25b98cf43d427b9dbdb6417dd3b" title="Get or sets whether the file extension check should be applied to the current request. Defaults to true. If set to true, will only affect the current request, and will only cause the Resizer to evaluate the rewriting rules on the request. Processing may still not occur if no querystring values are specified. Add &#39;cache=always&#39; to force caching to occur.">SkipFileTypeCheck</a> || <a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.<a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_pipeline_config.html#ac7ef1f4af9d8eb435963582217d2ce15" title="True if the specified extension is one that the pipeline can handle.">IsAcceptedImageType</a>(filePath)) {
                <span class="comment">//Copy the querystring so we can mod it to death without messing up other stuff.</span>
                NameValueCollection q = <a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.ModifiedQueryString;

                <span class="comment">//Call URL rewriting events</span>
                <a class="code" href="class_image_resizer_1_1_configuration_1_1_url_event_args.html">UrlEventArgs</a> ue = <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_configuration_1_1_url_event_args.html">UrlEventArgs</a>(filePath, q);
                <a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.FireRewritingEvents(<span class="keyword">this</span>, app.Context,ue);

                <span class="comment">//Pull data back out of event object, resolving app-relative paths</span>
                <span class="keywordtype">string</span> virtualPath = <a class="code" href="class_image_resizer_1_1_util_1_1_path_utils.html">PathUtils</a>.<a class="code" href="class_image_resizer_1_1_util_1_1_path_utils.html#a1a7e4faaa93c5b4d1f3652ccfc4dae82" title="Turns relative paths into domain-relative paths. Turns app-relative paths into domain relative paths...">ResolveAppRelativeAssumeAppRelative</a>(ue.<a class="code" href="class_image_resizer_1_1_configuration_1_1_url_event_args.html#a45acfa52b457e3208a4c1442c12266fa" title="Domain-relative path which also includes the path info portion. I.e, &#39;/app/folder/file.aspx/path/info&#39; could be a valid value. Relative to the domain root, not the site or app root.">VirtualPath</a>);
                q = ue.QueryString;

                <span class="comment">//Store the modified querystring in request for use by VirtualPathProviders</span>
                <a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.ModifiedQueryString = q; <span class="comment">// app.Context.Items[&quot;modifiedQueryString&quot;] = q;</span>

                <span class="comment">//See if resizing is wanted (i.e. one of the querystring commands is present).</span>
                <span class="comment">//Called after processPath so processPath can add them if needed.</span>
                <span class="comment">//Checks for thumnail, format, width, height, maxwidth, maxheight and a lot more</span>
                <span class="keywordflow">if</span> (<a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.<a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_pipeline_config.html#aa596c84a40adc00dd0d6c7bd351476b5" title="True if the querystring contains any directives that are understood by the pipeline.">HasPipelineDirective</a>(q)) {
                    <span class="comment">//Who&#39;s the user</span>
                    IPrincipal user = app.Context.User as IPrincipal;

                    <span class="comment">// no user (must be anonymous...).. Or authentication doesn&#39;t work for this suffix. Whatever, just avoid a nullref in the UrlAuthorizationModule</span>
                    <span class="keywordflow">if</span> (user == null)
                        user = <span class="keyword">new</span> GenericPrincipal(<span class="keyword">new</span> GenericIdentity(<span class="keywordtype">string</span>.Empty, <span class="keywordtype">string</span>.Empty), <span class="keyword">new</span> <span class="keywordtype">string</span>[0]);

                    <span class="comment">//Do we have permission to call UrlAuthorizationModule.CheckUrlAccessForPrincipal?</span>
                    <span class="keywordtype">bool</span> canCheckUrl = System.Security.SecurityManager.IsGranted(<span class="keyword">new</span> System.Security.Permissions.SecurityPermission(System.Security.Permissions.PermissionState.Unrestricted));
                    
                    
                    <span class="comment">//Run the rewritten path past the auth system again, using the result as the default &quot;AllowAccess&quot; value</span>
                    <span class="keywordtype">bool</span> isAllowed = <span class="keyword">true</span>;
                    <span class="keywordflow">if</span> (canCheckUrl) isAllowed = UrlAuthorizationModule.CheckUrlAccessForPrincipal(virtualPath, user, <span class="stringliteral">&quot;GET&quot;</span>);

                    
                    <a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_url_authorization_event_args.html">IUrlAuthorizationEventArgs</a> authEvent = <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_configuration_1_1_url_authorization_event_args.html">UrlAuthorizationEventArgs</a>(virtualPath, <span class="keyword">new</span> NameValueCollection(q), isAllowed);

                    <span class="comment">//Allow user code to deny access, but not modify the url or querystring.</span>
                    <a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.FireAuthorizeImage(<span class="keyword">this</span>, app.Context, authEvent);

                    <span class="keywordflow">if</span> (!authEvent.AllowAccess) <span class="keywordflow">throw</span> <span class="keyword">new</span> ImageProcessingException(403, <span class="stringliteral">&quot;Access denied&quot;</span>, <span class="stringliteral">&quot;Access denied&quot;</span>);

                    
                    
                    <span class="comment">//Does the file exist physically? (false if VppUsage=always or file is missing)</span>
                    <span class="keywordtype">bool</span> existsPhysically = (<a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.<a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_pipeline_config.html#a1f2edcda0c44b3a6432c2a108498f860" title="The behavior to use when accessing the file system.">VppUsage</a> != VppUsageOption.Always) &amp;&amp; System.IO.File.Exists(HostingEnvironment.MapPath(virtualPath));

                    <span class="comment">//If not present physically (and VppUsage!=never), try to get the virtual file. Null indicates a missing file</span>
                    <a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_virtual_file.html" title="A virtual file. Implementing this allows usage of your VirtualProvider without registering it with AS...">IVirtualFile</a> vf = (<a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.<a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_pipeline_config.html#a1f2edcda0c44b3a6432c2a108498f860" title="The behavior to use when accessing the file system.">VppUsage</a> != VppUsageOption.Never &amp;&amp; !existsPhysically) ? <a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.<a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_pipeline_config.html#aedeef5271e05c47b2b1953ee9d5f7d5c">GetFile</a>(virtualPath, q) : null;

                    <span class="comment">//Only process files that exist</span>
                    <span class="keywordflow">if</span> (existsPhysically || vf != null) {
                        <span class="keywordflow">try</span>{
                            <a class="code" href="class_image_resizer_1_1_intercept_module.html#a55916ea27e905902663d2813fcfc9ebf" title="Generates the resized image to disk (if needed), then rewrites the request to that location...">HandleRequest</a>(app.Context, virtualPath, q, vf);
                            <span class="comment">//Catch not found exceptions</span>
                        } <span class="keywordflow">catch</span> (System.IO.FileNotFoundException notFound) { <span class="comment">//Some VPPs are optimisitic , or could be a race condition</span>
                            FileMissing(app.Context, virtualPath, q);
                            <span class="keywordflow">throw</span> <span class="keyword">new</span> ImageMissingException(<span class="stringliteral">&quot;The specified resource could not be located&quot;</span>, <span class="stringliteral">&quot;File not found&quot;</span>, notFound);
                        }
                    } <span class="keywordflow">else</span>
                        FileMissing(app.Context, virtualPath, q);

                }
            }

        }
</pre></div>
</div>
</div>
<a class="anchor" id="a9938e258c26e277886d13712010aaa34"></a><!-- doxytag: member="ImageResizer::InterceptModule::context_PreSendRequestHeaders" ref="a9938e258c26e277886d13712010aaa34" args="(object sender, EventArgs e)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="class_image_resizer_1_1_intercept_module.html#a9938e258c26e277886d13712010aaa34">ImageResizer.InterceptModule.context_PreSendRequestHeaders</a> </td>
          <td>(</td>
          <td class="paramtype">object&#160;</td>
          <td class="paramname"><em>sender</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">EventArgs&#160;</td>
          <td class="paramname"><em>e</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [inline, protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>We don't actually send the data - but we still want to control the headers on the data. PreSendRequestHeaders allows us to change the content-type and cache headers at excatly the last. </p>
<dl class="params"><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">sender</td><td></td></tr>
    <tr><td class="paramname">e</td><td></td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="_intercept_module_8cs_source.html#l00305">305</a> of file <a class="el" href="_intercept_module_8cs_source.html">InterceptModule.cs</a>.</p>
<div class="fragment"><pre class="fragment">                                                                                 {
            <span class="comment">//Skip requests if the Request object isn&#39;t populated</span>
            HttpApplication app = sender as HttpApplication;
            <span class="keywordflow">if</span> (app == null) <span class="keywordflow">return</span>;
            <span class="keywordflow">if</span> (app.Context == null) <span class="keywordflow">return</span>;
            <span class="keywordflow">if</span> (app.Context.Items == null) <span class="keywordflow">return</span>;
            <span class="keywordflow">if</span> (app.Context.Request == null) <span class="keywordflow">return</span>;
            HttpContext context = app.Context;
            <span class="comment">//Skip requests if we don&#39;t have an object to work with.</span>
            <span class="keywordflow">if</span> (context.Items[<a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.<a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_pipeline_config.html#a961a5c777172d7803359db743aa44dae" title="The key in Context.Items to store the IResponseArgs object.">ResponseArgsKey</a>] == null) <span class="keywordflow">return</span>;
            <span class="comment">//Try to cast the object.</span>
            <a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html" title="A collection of data and callbacks that can be passed to a caching object.">IResponseArgs</a> obj = context.Items[<a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.<a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_pipeline_config.html#a961a5c777172d7803359db743aa44dae" title="The key in Context.Items to store the IResponseArgs object.">ResponseArgsKey</a>] as <a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html" title="A collection of data and callbacks that can be passed to a caching object.">IResponseArgs</a>;
            <span class="keywordflow">if</span> (obj == null) <span class="keywordflow">return</span>;
            <span class="comment">//Apply the headers</span>
            <span class="keywordflow">if</span> (obj.<a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html#a318f0208607e27b12ed78e692e03912b" title="The content-type of the data, among other things. Set ResponseHeaders.ApplyDuringPreSendRequestHeader...">ResponseHeaders</a>.<a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_headers.html#a0fcec2a5cc51fc00c036a01921a59a44" title="True if the application should automatically execute ApplyToResponse() during the PreSendRequestHeade...">ApplyDuringPreSendRequestHeaders</a>)
                obj.<a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html#a318f0208607e27b12ed78e692e03912b" title="The content-type of the data, among other things. Set ResponseHeaders.ApplyDuringPreSendRequestHeader...">ResponseHeaders</a>.<a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_headers.html#aa77ccbaf6e27fb602035a10a4f4b9667" title="A delegate method to apply the values stored in IResponseHeaders to the specified HttpContext...">ApplyToResponse</a>(obj.<a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html#a318f0208607e27b12ed78e692e03912b" title="The content-type of the data, among other things. Set ResponseHeaders.ApplyDuringPreSendRequestHeader...">ResponseHeaders</a>, app.Context);


        }
</pre></div>
</div>
</div>
<a class="anchor" id="a55916ea27e905902663d2813fcfc9ebf"></a><!-- doxytag: member="ImageResizer::InterceptModule::HandleRequest" ref="a55916ea27e905902663d2813fcfc9ebf" args="(HttpContext context, string virtualPath, NameValueCollection queryString, IVirtualFile vf)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">virtual void <a class="el" href="class_image_resizer_1_1_intercept_module.html#a55916ea27e905902663d2813fcfc9ebf">ImageResizer.InterceptModule.HandleRequest</a> </td>
          <td>(</td>
          <td class="paramtype">HttpContext&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">string&#160;</td>
          <td class="paramname"><em>virtualPath</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">NameValueCollection&#160;</td>
          <td class="paramname"><em>queryString</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="interface_image_resizer_1_1_plugins_1_1_i_virtual_file.html">IVirtualFile</a>&#160;</td>
          <td class="paramname"><em>vf</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [inline, protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Generates the resized image to disk (if needed), then rewrites the request to that location. Perform 404 checking before calling this method. Assumes file exists. Called during PostAuthorizeRequest. </p>
<dl class="params"><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">context</td><td></td></tr>
    <tr><td class="paramname">virtualPath</td><td></td></tr>
    <tr><td class="paramname">queryString</td><td></td></tr>
    <tr><td class="paramname">vf</td><td></td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="_intercept_module_8cs_source.html#l00168">168</a> of file <a class="el" href="_intercept_module_8cs_source.html">InterceptModule.cs</a>.</p>

<p>Referenced by <a class="el" href="_intercept_module_8cs_source.html#l00061">ImageResizer.InterceptModule.CheckRequest_PostAuthorizeRequest()</a>.</p>
<div class="fragment"><pre class="fragment">                                                                                                                                        {
            Stopwatch s = <span class="keyword">new</span> Stopwatch();
            s.Start();
            

            ResizeSettings settings = <span class="keyword">new</span> ResizeSettings(queryString);

            <span class="keywordtype">bool</span> isCaching = settings.Cache == <a class="code" href="namespace_image_resizer.html#a6b30c95c789b77db2c5aa905345d917c" title="When to disk cache the image.">ServerCacheMode</a>.Always;
            <span class="keywordtype">bool</span> isProcessing = settings.Process == <a class="code" href="namespace_image_resizer.html#a089c1fb717c880fab9cb6c06a06cf35a" title="When to process and re-encode the image.">ProcessWhen</a>.Always;

            <span class="comment">//By default, we process it if is both (a) a recognized image extension, and (b) has a resizing directive (not just &#39;cache&#39;).</span>
            <span class="keywordflow">if</span> (settings.Process == <a class="code" href="namespace_image_resizer.html#a089c1fb717c880fab9cb6c06a06cf35a" title="When to process and re-encode the image.">ProcessWhen</a>.Default){
                <span class="comment">//Check for resize directive by removing (&#39;non-resizing&#39; items from the current querystring) </span>
                NameValueCollection copy = <span class="keyword">new</span> NameValueCollection(queryString);
                copy.Remove(<span class="stringliteral">&quot;cache&quot;</span>); copy.Remove(<span class="stringliteral">&quot;process&quot;</span>); copy.Remove(<span class="stringliteral">&quot;useresizingpipeline&quot;</span>); copy.Remove(<span class="stringliteral">&quot;404&quot;</span>);
                <span class="comment">//If the &#39;copy&#39; still has directives, and it&#39;s an image request, then let&#39;s process it.</span>
                isProcessing = <a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.<a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_pipeline_config.html#ac7ef1f4af9d8eb435963582217d2ce15" title="True if the specified extension is one that the pipeline can handle.">IsAcceptedImageType</a>(virtualPath) &amp;&amp;  <a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.<a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_pipeline_config.html#aa596c84a40adc00dd0d6c7bd351476b5" title="True if the querystring contains any directives that are understood by the pipeline.">HasPipelineDirective</a>(copy);
            }

            <span class="comment">//By default, we only cache it if we&#39;re processing it. </span>
            <span class="keywordflow">if</span> (settings.Cache == <a class="code" href="namespace_image_resizer.html#a6b30c95c789b77db2c5aa905345d917c" title="When to disk cache the image.">ServerCacheMode</a>.Default &amp;&amp; isProcessing) 
                isCaching = <span class="keyword">true</span>;

            <span class="comment">//Resolve the &#39;cache&#39; setting to &#39;no&#39; unless we want it cache.</span>
            <span class="keywordflow">if</span> (!isCaching) settings.Cache = <a class="code" href="namespace_image_resizer.html#a6b30c95c789b77db2c5aa905345d917c" title="When to disk cache the image.">ServerCacheMode</a>.No;


            <span class="comment">//If we are neither processing nor caching, don&#39;t do anything more with the request</span>
            <span class="keywordflow">if</span> (!isProcessing &amp;&amp; !isCaching) <span class="keywordflow">return</span>;
            context.Items[<a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.<a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_pipeline_config.html#a961a5c777172d7803359db743aa44dae" title="The key in Context.Items to store the IResponseArgs object.">ResponseArgsKey</a>] = <span class="stringliteral">&quot;&quot;</span>; <span class="comment">//We are handling the requests</span>

            <span class="comment">//Communicate to the MVC plugin this request should not be affected by the UrlRoutingModule.</span>
            context.Items[<a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.<a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_pipeline_config.html#a01471feee6deeed9455e703d3e5be851" title="The key in Context.Items to set if we want to cancel MVC routing for the request.">StopRoutingKey</a>] = <span class="keyword">true</span>;

            <span class="comment">//Find out if we have a modified date that we can work with</span>
            <span class="keywordtype">bool</span> hasModifiedDate = (vf == null) || vf is <a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_virtual_file_with_modified_date.html" title="Always implement this if possible. Allows caching systems to detect changes to source files and inval...">IVirtualFileWithModifiedDate</a>;
            DateTime modDate = DateTime.MinValue;
            <span class="keywordflow">if</span> (hasModifiedDate &amp;&amp; vf != null) {
                modDate = ((<a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_virtual_file_with_modified_date.html" title="Always implement this if possible. Allows caching systems to detect changes to source files and inval...">IVirtualFileWithModifiedDate</a>)vf).<a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_virtual_file_with_modified_date.html#a8b36a63342e1e41f82628a8cb4ce482b" title="The modified (last write time) of the source file, in UTC form.">ModifiedDateUTC</a>;
                <span class="keywordflow">if</span> (modDate == DateTime.MinValue || modDate == DateTime.MaxValue) {
                    hasModifiedDate = <span class="keyword">false</span>; <span class="comment">//Skip modified date checking if the file has no modified date</span>
                }
            }


            <a class="code" href="interface_image_resizer_1_1_encoding_1_1_i_encoder.html" title="An image encoder. Exposes methods for suitability checking, encoding, transparency compatibility chec...">IEncoder</a> guessedEncoder = null;
            <span class="comment">//Only use an encoder to determine extension/mime-type when it&#39;s an image extension or when we&#39;ve set process = always.</span>
            <span class="keywordflow">if</span> (isProcessing) {
                guessedEncoder = <a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.<a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_pipeline_config.html#ac486ccc78554683bb7dd409a2f787bb3" title="Returns an ImageBuilder instance to use for image processing.">GetImageBuilder</a>().<a class="code" href="class_image_resizer_1_1_image_builder.html#a9bd254f85a8c846eb287a985b3accbde" title="Handles the encoder selection and provision proccess.">EncoderProvider</a>.<a class="code" href="interface_image_resizer_1_1_encoding_1_1_i_encoder_provider.html#ae0f3610b127ea2d51bff25cf931e7c3b" title="Returns an encoder based on the provided settings and the source object.">GetEncoder</a>(settings, virtualPath);
                <span class="keywordflow">if</span> (guessedEncoder == null) <span class="keywordflow">throw</span> <span class="keyword">new</span> ImageProcessingException(<span class="stringliteral">&quot;Image Resizer: No image encoder was found for the request.&quot;</span>);
            }

            <span class="comment">//Determine the file extenson for the caching system to use if we aren&#39;t processing the image</span>
            <span class="comment">//Use the exsiting one if is an image extension. If not, use &quot;unknown&quot;. </span>
            <span class="comment">// We don&#39;t want to suggest writing .exe or .aspx files to the cache! </span>
            <span class="keywordtype">string</span> fallbackExtension = <a class="code" href="class_image_resizer_1_1_util_1_1_path_utils.html">PathUtils</a>.<a class="code" href="class_image_resizer_1_1_util_1_1_path_utils.html#a3b381221fbb1e4bd0d5d299c7f0dc550" title="Will return the full extension, like &quot;.jpg.ashx&quot;, not just the last bit. Ignores the querystring part...">GetFullExtension</a>(virtualPath).TrimStart(<span class="charliteral">&#39;.&#39;</span>); 
            <span class="keywordflow">if</span> (!<a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.<a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_pipeline_config.html#ac7ef1f4af9d8eb435963582217d2ce15" title="True if the specified extension is one that the pipeline can handle.">IsAcceptedImageType</a>(virtualPath)) fallbackExtension = <span class="stringliteral">&quot;unknown&quot;</span>;

            <span class="comment">//Determine the mime-type if we aren&#39;t processing the image.</span>
            <span class="keywordtype">string</span> fallbackContentType = <span class="stringliteral">&quot;application/octet-stream&quot;</span>;
            <span class="comment">//Support jpeg, png, gif, bmp, tiff mime-types. Otherwise use &quot;application/octet-stream&quot;. </span>
            <span class="comment">//We can&#39;t set it to null - it will default to text/html</span>
            System.Drawing.Imaging.ImageFormat recognizedExtension = <a class="code" href="class_image_resizer_1_1_plugins_1_1_basic_1_1_default_encoder.html" title="Provides basic encoding functionality for Jpeg, png, and gif output. Allows adjustable Jpeg compressi...">DefaultEncoder</a>.<a class="code" href="class_image_resizer_1_1_plugins_1_1_basic_1_1_default_encoder.html#a0a8c27e25a65aba24098a7f70dc09f2e" title="Returns an ImageFormat instance from the specfied file extension. Extensions lie sometimes, just a guess. returns null if not recognized.">GetImageFormatFromExtension</a>(fallbackExtension);
            <span class="keywordflow">if</span> (recognizedExtension != null) fallbackContentType = <a class="code" href="class_image_resizer_1_1_plugins_1_1_basic_1_1_default_encoder.html" title="Provides basic encoding functionality for Jpeg, png, and gif output. Allows adjustable Jpeg compressi...">DefaultEncoder</a>.<a class="code" href="class_image_resizer_1_1_plugins_1_1_basic_1_1_default_encoder.html#ab609bf99180cd6f3c94ef111be799fc8" title="Supports Png, Jpeg, Gif, Bmp, and Tiff. Throws a ArgumentOutOfRangeException if not png...">GetContentTypeFromImageFormat</a>(recognizedExtension);


            <span class="comment">//Build CacheEventArgs</span>
            <a class="code" href="class_image_resizer_1_1_caching_1_1_response_args.html" title="IResponseArgs implementation.">ResponseArgs</a> e = <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_caching_1_1_response_args.html" title="IResponseArgs implementation.">ResponseArgs</a>();
            e.<a class="code" href="class_image_resizer_1_1_caching_1_1_response_args.html#a9a37ba30bcff0b537af5ac405c5b5a3e" title="A value derived from the request. Can be used as a cache key.">RequestKey</a> = virtualPath + <a class="code" href="class_image_resizer_1_1_util_1_1_path_utils.html">PathUtils</a>.<a class="code" href="class_image_resizer_1_1_util_1_1_path_utils.html#ac50e452cbcb5cea21318669c89632755" title="Returns a string querystring in the form &quot;?key=value&amp;amp;key=value&quot;. Keys and values are UrlEncoded a...">BuildQueryString</a>(queryString);
            e.<a class="code" href="class_image_resizer_1_1_caching_1_1_response_args.html#a0708450cd35b10e284c1a45b0ca3abc1" title="The rewritten querystring. Can be useful for caching systems that accept querystring arguments...">RewrittenQuerystring</a> = settings;
            e.<a class="code" href="class_image_resizer_1_1_caching_1_1_response_args.html#a486726072eda5c0872cd117e6913c0a4" title="The content-type of the data, among other things. Set ResponseHeaders.ApplyDuringPreSendRequestHeader...">ResponseHeaders</a>.<a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_headers.html#a0e2048699acfd1ec7b5d4657116e38de" title="The mime-type of the output data. Defaults to null.">ContentType</a> = isProcessing ? guessedEncoder.<a class="code" href="interface_image_resizer_1_1_encoding_1_1_i_encoder.html#a7cbe10dac3c2bad04d088ae6f20e4180" title="Returns the appropriate mime-time for the output format as currently configured.">MimeType</a> : fallbackContentType; 
            e.<a class="code" href="class_image_resizer_1_1_caching_1_1_response_args.html#a14024965db082abfd3d917db64d4fc8d" title="A file extension appropriate for the resulting data. May be different than the extension on the origi...">SuggestedExtension</a> = isProcessing ? guessedEncoder.<a class="code" href="interface_image_resizer_1_1_encoding_1_1_i_encoder.html#ad7da126e6577cc319df398bf04949859" title="Returns a file extension appropriate for the output format as currently configured, without a leading dot.">Extension</a> : fallbackExtension;
            e.<a class="code" href="class_image_resizer_1_1_caching_1_1_response_args.html#ae5ba046b9a32027352393bdd428b20e8" title="True if the source file/record has a modified date.">HasModifiedDate</a> = hasModifiedDate;
            <span class="comment">//Add delegate for retrieving the modified date of the source file. </span>
            e.<a class="code" href="class_image_resizer_1_1_caching_1_1_response_args.html#aa04d4cdaa9c276e0efba59d83c85cf9e" title="A callback method to return the last modified date of the source file if available, or DateTime.MinValue if not.">GetModifiedDateUTC</a> = <span class="keyword">new</span> <a class="code" href="namespace_image_resizer_1_1_caching.html#aa07f9e07e851742ccee15c9caf69c1ba" title="A callback method to return the last modified date of the source file if available, or DateTime.MinValue if not available.">ModifiedDateDelegate</a>(delegate() {
                <span class="keywordflow">if</span> (vf == null)
                    <span class="keywordflow">return</span> System.IO.File.GetLastWriteTimeUtc(HostingEnvironment.MapPath(virtualPath));
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hasModifiedDate)
                    <span class="keywordflow">return</span> modDate;
                <span class="keywordflow">else</span> <span class="keywordflow">return</span> DateTime.MinValue; <span class="comment">//Won&#39;t be called, no modified date available.</span>
            });

            <span class="comment">//Add delegate for writing the data stream</span>
            e.<a class="code" href="class_image_resizer_1_1_caching_1_1_response_args.html#a86f8e5a78c888c1944f3b39d0007b24b" title="A callback method that will resize and encode the image into a stream.">ResizeImageToStream</a> = <span class="keyword">new</span> <a class="code" href="namespace_image_resizer_1_1_caching.html#a51e885e7bc7d9c3c6906b6d51baad126" title="A callback method that will resize, encode, and write the data to the given stream. Callback may throw FileNotFoundException when running on top of an optimistic VPP.">ResizeImageDelegate</a>(delegate(System.IO.Stream stream) {
                <span class="comment">//This runs on a cache miss or cache invalid. This delegate is preventing from running in more</span>
                <span class="comment">//than one thread at a time for the specified cache key</span>
                <span class="keywordflow">try</span> {
                    if (!isProcessing) {
                        <span class="comment">//Just duplicate the data</span>
                        <span class="keyword">using</span> (Stream source = (vf != null) ? vf.<a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_virtual_file.html#ab7b7a83101de09de66b663910b3febcc" title="Returns an opened stream to the file contents.">Open</a>(): 
                                        File.Open(HostingEnvironment.MapPath(virtualPath), FileMode.Open, FileAccess.Read, FileShare.Read)) {
                            <a class="code" href="class_image_resizer_1_1_util_1_1_utils.html">Utils</a>.<a class="code" href="class_image_resizer_1_1_util_1_1_utils.html#a2630903f140fe0dafaa2d160851deeee" title="Copies all remaining data from &#39;source&#39; to &#39;dest&#39;.">copyStream</a>(source, stream);
                        }
                    } <span class="keywordflow">else</span> {
                        <span class="comment">//Process the image</span>
                        <span class="keywordflow">if</span> (vf != null)
                            <a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.<a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_pipeline_config.html#ac486ccc78554683bb7dd409a2f787bb3" title="Returns an ImageBuilder instance to use for image processing.">GetImageBuilder</a>().<a class="code" href="class_image_resizer_1_1_image_builder.html#a12f49b48e9244ee7f6e86fd60fffcc83" title="Resizes and processes the specified source image and returns a bitmap of the result. Note! This method assumes that transparency will be supported in the final output format, and therefore does not apply a matte color. Use &amp;bgcolor to specify a background color if you use this method with a non-transparent format such as Jpeg. If passed a source Stream, Bitmap, or Image instance, it will be disposed after use. Use disposeSource=False to disable that behavior.">Build</a>(vf, stream, settings);
                        <span class="keywordflow">else</span>
                            <a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.<a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_pipeline_config.html#ac486ccc78554683bb7dd409a2f787bb3" title="Returns an ImageBuilder instance to use for image processing.">GetImageBuilder</a>().<a class="code" href="class_image_resizer_1_1_image_builder.html#a12f49b48e9244ee7f6e86fd60fffcc83" title="Resizes and processes the specified source image and returns a bitmap of the result. Note! This method assumes that transparency will be supported in the final output format, and therefore does not apply a matte color. Use &amp;bgcolor to specify a background color if you use this method with a non-transparent format such as Jpeg. If passed a source Stream, Bitmap, or Image instance, it will be disposed after use. Use disposeSource=False to disable that behavior.">Build</a>(HostingEnvironment.MapPath(virtualPath), stream, settings); <span class="comment">//Use a physical path to bypass virtual file system</span>
                    }

                    <span class="comment">//Catch not found exceptions</span>
                } <span class="keywordflow">catch</span> (System.IO.FileNotFoundException notFound) {
                    <span class="comment">//This will be called later, if at all. </span>
                    FileMissing(context, virtualPath, queryString);
                    <span class="keywordflow">throw</span> <span class="keyword">new</span> ImageMissingException(<span class="stringliteral">&quot;The specified resource could not be located&quot;</span>,<span class="stringliteral">&quot;File not found&quot;</span>, notFound);
                }
            });


            context.Items[<a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.<a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_pipeline_config.html#a961a5c777172d7803359db743aa44dae" title="The key in Context.Items to store the IResponseArgs object.">ResponseArgsKey</a>] = e; <span class="comment">//store in context items</span>

            <span class="comment">//Fire events (for client-side caching plugins)</span>
            <a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.FirePreHandleImage(<span class="keyword">this</span>, context, e);

            <span class="comment">//Pass the rest of the work off to the caching module. It will handle rewriting/redirecting and everything. </span>
            <span class="comment">//We handle request headers based on what is found in context.Items</span>
            <a class="code" href="interface_image_resizer_1_1_caching_1_1_i_cache.html" title="Provides caching behavior.">ICache</a> cache = <a class="code" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce" title="Current configuration. Same as Config.Current.Pipeline.">conf</a>.<a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_pipeline_config.html#a875fc6f5b30023392b7de162b776769c" title="Returns a ICacheProvider instance that provides caching system selection and creation.">GetCacheProvider</a>().<a class="code" href="interface_image_resizer_1_1_caching_1_1_i_cache_provider.html#a52be77cf11cd203bda140a42d63a3890" title="Selects a caching system for the specified request and response.">GetCachingSystem</a>(context, e);

            <span class="comment">//Verify we have a caching system</span>
            <span class="keywordflow">if</span> (cache == null) <span class="keywordflow">throw</span> <span class="keyword">new</span> ImageProcessingException(<span class="stringliteral">&quot;Image Resizer: No caching plugin was found for the request&quot;</span>);
            
            cache.<a class="code" href="interface_image_resizer_1_1_caching_1_1_i_cache.html#adf2afb4fca74ba610979b081ebff3487" title="Must update the cache if needed, then either rewrite, redirect or serve the cached data...">Process</a>(context, e);

            

            s.Stop();
            context.Items[<span class="stringliteral">&quot;ResizingTime&quot;</span>] = s.ElapsedMilliseconds;

        }
</pre></div>
</div>
</div>
<hr/><h2>Property Documentation</h2>
<a class="anchor" id="a58d5e9e6dfce4ac70f2c81abbb7414ce"></a><!-- doxytag: member="ImageResizer::InterceptModule::conf" ref="a58d5e9e6dfce4ac70f2c81abbb7414ce" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="interface_image_resizer_1_1_configuration_1_1_i_pipeline_config.html">IPipelineConfig</a> <a class="el" href="class_image_resizer_1_1_intercept_module.html#a58d5e9e6dfce4ac70f2c81abbb7414ce">ImageResizer.InterceptModule.conf</a><code> [get, protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Current configuration. Same as Config.Current.Pipeline. </p>

<p>Definition at line <a class="el" href="_intercept_module_8cs_source.html#l00050">50</a> of file <a class="el" href="_intercept_module_8cs_source.html">InterceptModule.cs</a>.</p>

<p>Referenced by <a class="el" href="_intercept_module_8cs_source.html#l00061">ImageResizer.InterceptModule.CheckRequest_PostAuthorizeRequest()</a>, and <a class="el" href="_intercept_module_8cs_source.html#l00168">ImageResizer.InterceptModule.HandleRequest()</a>.</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li>C:/Users/Administrator/Documents/resizer/Core/<a class="el" href="_intercept_module_8cs_source.html">InterceptModule.cs</a></li>
</ul>
</div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Events</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
