<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ImageResizer: C:/Users/Administrator/Documents/resizer/Plugins/DiskCache/DiskCache.cs Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="imageresizer-logo-00aec4.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">ImageResizer
   &#160;<span id="projectnumber">3.3.3</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">C:/Users/Administrator/Documents/resizer/Plugins/DiskCache/DiskCache.cs</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* Copyright (c) 2011 Nathanael Jones. See license.txt for your rights. */</span>
<a name="l00002"></a>00002 <span class="keyword">using</span> System;
<a name="l00003"></a>00003 <span class="keyword">using</span> System.Collections.Generic;
<a name="l00004"></a>00004 <span class="keyword">using</span> System.Text;
<a name="l00005"></a>00005 <span class="keyword">using</span> System.Web;
<a name="l00006"></a>00006 <span class="keyword">using</span> System.Configuration;
<a name="l00007"></a>00007 <span class="keyword">using</span> ImageResizer.Util;
<a name="l00008"></a>00008 <span class="keyword">using</span> System.IO;
<a name="l00009"></a>00009 <span class="keyword">using</span> ImageResizer.Caching;
<a name="l00010"></a>00010 <span class="keyword">using</span> ImageResizer.Configuration;
<a name="l00011"></a>00011 <span class="keyword">using</span> System.Web.Hosting;
<a name="l00012"></a>00012 <span class="keyword">using</span> ImageResizer.Configuration.Issues;
<a name="l00013"></a>00013 <span class="keyword">using</span> ImageResizer.Configuration.Logging;
<a name="l00014"></a>00014 <span class="keyword">using</span> ImageResizer.Plugins.Basic;
<a name="l00015"></a>00015 <span class="keyword">using</span> System.Security.Permissions;
<a name="l00016"></a>00016 <span class="keyword">using</span> System.Security;
<a name="l00017"></a>00017 <span class="keyword">using</span> System.Threading;
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="keyword">namespace </span>ImageResizer.Plugins.DiskCache
<a name="l00020"></a>00020 {<span class="comment"></span>
<a name="l00021"></a>00021 <span class="comment">    /// &lt;summary&gt;</span>
<a name="l00022"></a>00022 <span class="comment">    /// Indicates a problem with disk caching. Causes include a missing (or too small) ImageDiskCacheDir setting, and severe I/O locking preventing </span>
<a name="l00023"></a>00023 <span class="comment">    /// the cache dir from being cleaned at all.</span>
<a name="l00024"></a>00024 <span class="comment">    /// &lt;/summary&gt;</span>
<a name="l00025"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache_exception.html">00025</a> <span class="comment"></span>    <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache_exception.html" title="Indicates a problem with disk caching. Causes include a missing (or too small) ImageDiskCacheDir sett...">DiskCacheException</a> : Exception
<a name="l00026"></a>00026     {
<a name="l00027"></a>00027         <span class="keyword">public</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache_exception.html" title="Indicates a problem with disk caching. Causes include a missing (or too small) ImageDiskCacheDir sett...">DiskCacheException</a>(<span class="keywordtype">string</span> message):base(message){}
<a name="l00028"></a>00028         <span class="keyword">public</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache_exception.html" title="Indicates a problem with disk caching. Causes include a missing (or too small) ImageDiskCacheDir sett...">DiskCacheException</a>(<span class="keywordtype">string</span> message, Exception innerException) : base(message, innerException) { }
<a name="l00029"></a>00029     }
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="comment"></span>
<a name="l00033"></a>00033 <span class="comment">    /// &lt;summary&gt;</span>
<a name="l00034"></a>00034 <span class="comment">    /// Provides methods for creating, maintaining, and securing the disk cache. </span>
<a name="l00035"></a>00035 <span class="comment">    /// &lt;/summary&gt;</span>
<a name="l00036"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html">00036</a> <span class="comment"></span>    <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html" title="Provides methods for creating, maintaining, and securing the disk cache.">DiskCache</a>: <a class="code" href="interface_image_resizer_1_1_caching_1_1_i_cache.html" title="Provides caching behavior.">ICache</a>, <a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_plugin.html" title="All plugins must implement this. Enables web.config addition and removal.">IPlugin</a>, <a class="code" href="interface_image_resizer_1_1_configuration_1_1_issues_1_1_i_issue_provider.html">IIssueProvider</a>, <a class="code" href="interface_image_resizer_1_1_configuration_1_1_logging_1_1_i_logger_provider.html">ILoggerProvider</a>
<a name="l00037"></a>00037     {
<a name="l00038"></a>00038         <span class="keyword">private</span> <span class="keywordtype">int</span> subfolders = 32;<span class="comment"></span>
<a name="l00039"></a>00039 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00040"></a>00040 <span class="comment">        /// Controls how many subfolders to use for disk caching. Rounded to the next power of to. (1-&gt;2, 3-&gt;4, 5-&gt;8, 9-&gt;16, 17-&gt;32, 33-&gt;64, 65-&gt;128,129-&gt;256,etc.)</span>
<a name="l00041"></a>00041 <span class="comment">        /// NTFS does not handle more than 8,000 files per folder well. Larger folders also make cleanup more resource-intensive.</span>
<a name="l00042"></a>00042 <span class="comment">        /// Defaults to 32, which combined with the default setting of 400 images per folder, allows for scalability to 12,800 actively used image versions. </span>
<a name="l00043"></a>00043 <span class="comment">        /// For example, given a desired cache size of 100,000 items, this should be set to 256.</span>
<a name="l00044"></a>00044 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00045"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#ab9566bb68b57437c9dccb4c27d6397e0">00045</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">int</span> Subfolders {
<a name="l00046"></a>00046             <span class="keyword">get</span> { <span class="keywordflow">return</span> subfolders; }
<a name="l00047"></a>00047             <span class="keyword">set</span> { BeforeSettingChanged(); subfolders = value; }
<a name="l00048"></a>00048         }
<a name="l00049"></a>00049 
<a name="l00050"></a>00050         <span class="keyword">private</span> <span class="keywordtype">bool</span> enabled = <span class="keyword">true</span>;<span class="comment"></span>
<a name="l00051"></a>00051 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00052"></a>00052 <span class="comment">        /// Allows disk caching to be disabled for debuginng purposes. Defaults to true.</span>
<a name="l00053"></a>00053 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00054"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a20fdd8f25afd3e712d4331a28886e7e1">00054</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> Enabled {
<a name="l00055"></a>00055             <span class="keyword">get</span> { <span class="keywordflow">return</span> enabled; }
<a name="l00056"></a>00056             <span class="keyword">set</span> { BeforeSettingChanged(); enabled = value; }
<a name="l00057"></a>00057         }
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 
<a name="l00060"></a>00060         <span class="keyword">private</span> <span class="keywordtype">bool</span> autoClean = <span class="keyword">false</span>;<span class="comment"></span>
<a name="l00061"></a>00061 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00062"></a>00062 <span class="comment">        /// If true, items from the cache folder will be automatically &#39;garbage collected&#39; if the cache size limits are exceeded.</span>
<a name="l00063"></a>00063 <span class="comment">        /// Defaults to false.</span>
<a name="l00064"></a>00064 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00065"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a21e3a602d75eec0399962ae9b04b2b9b">00065</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> AutoClean {
<a name="l00066"></a>00066             <span class="keyword">get</span> { <span class="keywordflow">return</span> autoClean; }
<a name="l00067"></a>00067             <span class="keyword">set</span> { BeforeSettingChanged();  autoClean = value; }
<a name="l00068"></a>00068         }
<a name="l00069"></a>00069         <span class="keyword">private</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_cleanup_strategy.html">CleanupStrategy</a> cleanupStrategy = <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_cleanup_strategy.html">CleanupStrategy</a>();<span class="comment"></span>
<a name="l00070"></a>00070 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00071"></a>00071 <span class="comment">        /// Only relevant when AutoClean=true. Settings about how background cache cleanup are performed.</span>
<a name="l00072"></a>00072 <span class="comment">        /// It is best not to modify these settings. There are very complicated and non-obvious factors involved in their choice.</span>
<a name="l00073"></a>00073 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00074"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a14e1a1afff8c1d086f91eb7f1d7b4060">00074</a> <span class="comment"></span>        <span class="keyword">public</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_cleanup_strategy.html">CleanupStrategy</a> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_cleanup_strategy.html">CleanupStrategy</a> {
<a name="l00075"></a>00075             <span class="keyword">get</span> { <span class="keywordflow">return</span> cleanupStrategy; }
<a name="l00076"></a>00076             <span class="keyword">set</span> { BeforeSettingChanged(); cleanupStrategy = value; }
<a name="l00077"></a>00077         }
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 
<a name="l00080"></a>00080         <span class="keyword">protected</span> <span class="keywordtype">int</span> cacheAccessTimeout = 15000;<span class="comment"></span>
<a name="l00081"></a>00081 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00082"></a>00082 <span class="comment">        /// How many milliseconds to wait for a cached item to be available. Values below 0 are set to 0. Defaults to 15 seconds.</span>
<a name="l00083"></a>00083 <span class="comment">        /// Actual time spent waiting may be 2 or 3x this value, if multiple layers of synchronization require a wait.</span>
<a name="l00084"></a>00084 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00085"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#ae9bd5dae4cd2ec5cfd13153386941e9b">00085</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">int</span> CacheAccessTimeout {
<a name="l00086"></a>00086             <span class="keyword">get</span> { <span class="keywordflow">return</span> cacheAccessTimeout; }
<a name="l00087"></a>00087             <span class="keyword">set</span> { BeforeSettingChanged(); cacheAccessTimeout = Math.Max(value,0); }
<a name="l00088"></a>00088         }
<a name="l00089"></a>00089 
<a name="l00090"></a>00090         <span class="keyword">private</span> <span class="keywordtype">bool</span> hashModifiedDate = <span class="keyword">true</span>;<span class="comment"></span>
<a name="l00091"></a>00091 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00092"></a>00092 <span class="comment">        /// If true, when a source file is changed, a new file will be created instead of overwriting the old cached file.</span>
<a name="l00093"></a>00093 <span class="comment">        /// This helps prevent file lock contention on high-traffic servers. Defaults to true.  </span>
<a name="l00094"></a>00094 <span class="comment">        /// Do NOT set this to false in a Web Garden or if you have overlapped recycle enabled, as you may risk having occasional failed requests due</span>
<a name="l00095"></a>00095 <span class="comment">        /// to write contention by separate proccesses.</span>
<a name="l00096"></a>00096 <span class="comment">        /// Changes the hash function, so you should delete the cache folder whenever this setting is modified.</span>
<a name="l00097"></a>00097 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00098"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a987835b68d3decf11ebc1865af9b2f1a">00098</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> HashModifiedDate {
<a name="l00099"></a>00099             <span class="keyword">get</span> { <span class="keywordflow">return</span> hashModifiedDate; }
<a name="l00100"></a>00100             <span class="keyword">set</span> { BeforeSettingChanged(); hashModifiedDate = value; }
<a name="l00101"></a>00101         }
<a name="l00102"></a>00102 
<a name="l00103"></a>00103         <span class="keyword">private</span> <span class="keywordtype">bool</span> _asyncWrites = <span class="keyword">false</span>;<span class="comment"></span>
<a name="l00104"></a>00104 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00105"></a>00105 <span class="comment">        /// If true, writes to the disk cache will be performed outside the request thread, allowing responses to return to the client quicker. </span>
<a name="l00106"></a>00106 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00107"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a041942b5394c38fd989fa268d69348a7">00107</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> AsyncWrites {
<a name="l00108"></a>00108             <span class="keyword">get</span> { <span class="keywordflow">return</span> _asyncWrites; }
<a name="l00109"></a>00109             <span class="keyword">set</span> { BeforeSettingChanged(); _asyncWrites = value; }
<a name="l00110"></a>00110         }
<a name="l00111"></a>00111 
<a name="l00112"></a>00112 
<a name="l00113"></a>00113         <span class="keyword">private</span> <span class="keywordtype">int</span> _asyncBufferSize = 1024 * 1024 * 10;<span class="comment"></span>
<a name="l00114"></a>00114 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00115"></a>00115 <span class="comment">        /// If more than this amount of memory (in bytes) is currently allocated by queued writes, the request will be processed synchronously instead of asynchronously.</span>
<a name="l00116"></a>00116 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00117"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#ad36ae61ace9fdb78f7daf1c5a672c6c4">00117</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">int</span> AsyncBufferSize {
<a name="l00118"></a>00118             <span class="keyword">get</span> { <span class="keywordflow">return</span> _asyncBufferSize; }
<a name="l00119"></a>00119             <span class="keyword">set</span> { BeforeSettingChanged(); _asyncBufferSize = value; }
<a name="l00120"></a>00120         }
<a name="l00121"></a>00121 
<a name="l00122"></a>00122 
<a name="l00123"></a>00123         <span class="keyword">protected</span> <span class="keywordtype">string</span> virtualDir =  HostingEnvironment.ApplicationVirtualPath.TrimEnd(<span class="charliteral">&#39;/&#39;</span>) + <span class="stringliteral">&quot;/imagecache&quot;</span>;<span class="comment"></span>
<a name="l00124"></a>00124 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00125"></a>00125 <span class="comment">        /// Sets the location of the cache directory. </span>
<a name="l00126"></a>00126 <span class="comment">        /// Can be a virtual path (like /App/imagecache) or an application-relative path (like ~/imagecache, the default).</span>
<a name="l00127"></a>00127 <span class="comment">        /// Relative paths are assummed to be relative to the application root.</span>
<a name="l00128"></a>00128 <span class="comment">        /// All values are converted to virtual path format upon assignment (/App/imagecache)</span>
<a name="l00129"></a>00129 <span class="comment">        /// Will throw an InvalidOperationException if changed after the plugin is installed.</span>
<a name="l00130"></a>00130 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00131"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a9107f03f8a4e721a8af66dd1bbb38eea">00131</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">string</span> VirtualCacheDir { 
<a name="l00132"></a>00132             <span class="keyword">get</span> { 
<a name="l00133"></a>00133                 <span class="keywordflow">return</span> virtualDir; 
<a name="l00134"></a>00134             }
<a name="l00135"></a>00135             <span class="keyword">set</span> {
<a name="l00136"></a>00136                 BeforeSettingChanged();
<a name="l00137"></a>00137                 <span class="comment">//Default to application-relative path if no leading slash is present. </span>
<a name="l00138"></a>00138                 <span class="comment">//Resolve the tilde if present.</span>
<a name="l00139"></a>00139                 virtualDir =  <span class="keywordtype">string</span>.IsNullOrEmpty(value) ? null : <a class="code" href="class_image_resizer_1_1_util_1_1_path_utils.html" title="A set of utility methods for manipulating virtual paths.">PathUtils</a>.<a class="code" href="class_image_resizer_1_1_util_1_1_path_utils.html#a1a7e4faaa93c5b4d1f3652ccfc4dae82" title="Turns relative paths into domain-relative paths. Turns app-relative paths into domain relative paths...">ResolveAppRelativeAssumeAppRelative</a>(value);
<a name="l00140"></a>00140             }
<a name="l00141"></a>00141         }<span class="comment"></span>
<a name="l00142"></a>00142 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00143"></a>00143 <span class="comment">        /// Returns the physical path of the cache directory specified in VirtualCacheDir.</span>
<a name="l00144"></a>00144 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00145"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a8fed6209155c922102b9430d2f216276">00145</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">string</span> PhysicalCacheDir {
<a name="l00146"></a>00146             <span class="keyword">get</span> {
<a name="l00147"></a>00147                 <span class="keywordflow">if</span> (!<span class="keywordtype">string</span>.IsNullOrEmpty(VirtualCacheDir)) <span class="keywordflow">return</span> HostingEnvironment.MapPath(VirtualCacheDir);
<a name="l00148"></a>00148                 <span class="keywordflow">return</span> null;
<a name="l00149"></a>00149             }
<a name="l00150"></a>00150         }
<a name="l00151"></a>00151 <span class="comment"></span>
<a name="l00152"></a>00152 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00153"></a>00153 <span class="comment">        /// Throws an exception if the class is already modified</span>
<a name="l00154"></a>00154 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00155"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a43a9d95ea4823f06a7125ef283e7cc9b">00155</a> <span class="comment"></span>        <span class="keyword">protected</span> <span class="keywordtype">void</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a43a9d95ea4823f06a7125ef283e7cc9b" title="Throws an exception if the class is already modified.">BeforeSettingChanged</a>() {
<a name="l00156"></a>00156             <span class="keywordflow">if</span> (_started) <span class="keywordflow">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="stringliteral">&quot;DiskCache settings may not be adjusted after it is started.&quot;</span>);
<a name="l00157"></a>00157         }
<a name="l00158"></a>00158 <span class="comment"></span>
<a name="l00159"></a>00159 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00160"></a>00160 <span class="comment">        /// Creates a disk cache in the /imagecache folder</span>
<a name="l00161"></a>00161 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00162"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a8e7ce765d0d4424bfc245a987dabfed7">00162</a> <span class="comment"></span>        <span class="keyword">public</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a8e7ce765d0d4424bfc245a987dabfed7" title="Creates a disk cache in the /imagecache folder.">DiskCache</a>(){}
<a name="l00163"></a>00163         <span class="comment"></span>
<a name="l00164"></a>00164 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00165"></a>00165 <span class="comment">        /// Creates a DiskCache instance at the specified location. Must be installed as a plugin to be operational.</span>
<a name="l00166"></a>00166 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00167"></a>00167 <span class="comment">        /// &lt;param name=&quot;virtualDir&quot;&gt;&lt;/param&gt;</span>
<a name="l00168"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a66846ff9577c53c64b8c6f569ba6af7d">00168</a> <span class="comment"></span>        <span class="keyword">public</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a66846ff9577c53c64b8c6f569ba6af7d" title="Creates a DiskCache instance at the specified location. Must be installed as a plugin to be operation...">DiskCache</a>(<span class="keywordtype">string</span> virtualDir){
<a name="l00169"></a>00169             VirtualCacheDir = virtualDir;
<a name="l00170"></a>00170         }<span class="comment"></span>
<a name="l00171"></a>00171 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00172"></a>00172 <span class="comment">        /// Uses the defaults from the resizing.diskcache section in the specified configuration.</span>
<a name="l00173"></a>00173 <span class="comment">        /// Throws an invalid operation exception if the DiskCache is already started.</span>
<a name="l00174"></a>00174 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00175"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a19e04da009febf0d35b37700ca026062">00175</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a19e04da009febf0d35b37700ca026062" title="Uses the defaults from the resizing.diskcache section in the specified configuration. Throws an invalid operation exception if the DiskCache is already started.">LoadSettings</a>(<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html">Config</a> c){
<a name="l00176"></a>00176             Subfolders = c.get(<span class="stringliteral">&quot;diskcache.subfolders&quot;</span>, Subfolders);
<a name="l00177"></a>00177             Enabled = c.get(<span class="stringliteral">&quot;diskcache.enabled&quot;</span>, Enabled);
<a name="l00178"></a>00178             AutoClean = c.get(<span class="stringliteral">&quot;diskcache.autoClean&quot;</span>, AutoClean);
<a name="l00179"></a>00179             VirtualCacheDir = c.get(<span class="stringliteral">&quot;diskcache.dir&quot;</span>, VirtualCacheDir);
<a name="l00180"></a>00180             HashModifiedDate = c.get(<span class="stringliteral">&quot;diskcache.hashModifiedDate&quot;</span>, HashModifiedDate);
<a name="l00181"></a>00181             CacheAccessTimeout = c.get(<span class="stringliteral">&quot;diskcache.cacheAccessTimeout&quot;</span>, CacheAccessTimeout);
<a name="l00182"></a>00182             AsyncBufferSize = c.get(<span class="stringliteral">&quot;diskcache.asyncBufferSize&quot;</span>, AsyncBufferSize);
<a name="l00183"></a>00183             AsyncWrites = c.get(<span class="stringliteral">&quot;diskcache.asyncWrites&quot;</span>, AsyncWrites);
<a name="l00184"></a>00184             <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_cleanup_strategy.html">CleanupStrategy</a>.<a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_cleanup_strategy.html#a95c6e6c237e403debac6150500a4be29" title="Loads settings from the specified node. Attribute names and property names must match.">LoadFrom</a>(c.<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html#a88b0d3c3b0457e5f8f0cacb35cb7d267" title="Returns a deep copy of the specified node.">getNode</a>(<span class="stringliteral">&quot;cleanupStrategy&quot;</span>));
<a name="l00185"></a>00185         }
<a name="l00186"></a>00186 
<a name="l00187"></a>00187         <span class="keyword">protected</span> <a class="code" href="interface_image_resizer_1_1_configuration_1_1_logging_1_1_i_logger.html">ILogger</a> log = null;
<a name="l00188"></a>00188         <span class="keyword">public</span> <a class="code" href="interface_image_resizer_1_1_configuration_1_1_logging_1_1_i_logger.html">ILogger</a> Logger { <span class="keyword">get</span> { <span class="keywordflow">return</span> log; } }<span class="comment"></span>
<a name="l00189"></a>00189 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00190"></a>00190 <span class="comment">        /// Loads the settings from &#39;c&#39;, starts the cache, and registers the plugin.</span>
<a name="l00191"></a>00191 <span class="comment">        /// Will throw an invalidoperationexception if already started.</span>
<a name="l00192"></a>00192 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00193"></a>00193 <span class="comment">        /// &lt;param name=&quot;c&quot;&gt;&lt;/param&gt;</span>
<a name="l00194"></a>00194 <span class="comment">        /// &lt;returns&gt;&lt;/returns&gt;</span>
<a name="l00195"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a97c992e137f180427979ef2d0459dab9">00195</a> <span class="comment"></span>        <span class="keyword">public</span> <a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_plugin.html" title="All plugins must implement this. Enables web.config addition and removal.">IPlugin</a> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a97c992e137f180427979ef2d0459dab9" title="Loads the settings from &#39;c&#39;, starts the cache, and registers the plugin. Will throw an invalidoperati...">Install</a>(<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html">Config</a> c) {
<a name="l00196"></a>00196             <span class="keywordflow">if</span> (c.get(<span class="stringliteral">&quot;diskcache.logging&quot;</span>, <span class="keyword">false</span>)) {
<a name="l00197"></a>00197                 <span class="keywordflow">if</span> (c.<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html#aa8cdada7d657ec3078e5d16310f198f7" title="Access and modify plugins.">Plugins</a>.<a class="code" href="class_image_resizer_1_1_configuration_1_1_plugin_config.html#a9f23aa7ba7f123b82a9bc17fcbac3a06" title="Returns the most recently registered Logging plugin, or null.">LogManager</a> != null) 
<a name="l00198"></a>00198                     log = c.<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html#aa8cdada7d657ec3078e5d16310f198f7" title="Access and modify plugins.">Plugins</a>.<a class="code" href="class_image_resizer_1_1_configuration_1_1_plugin_config.html#a9f23aa7ba7f123b82a9bc17fcbac3a06" title="Returns the most recently registered Logging plugin, or null.">LogManager</a>.<a class="code" href="interface_image_resizer_1_1_configuration_1_1_logging_1_1_i_log_manager.html#af010ab8b5b3ec53a3f2305e64453fb06" title="Creates the specified logger object and assigns a LoggerName to it.">GetLogger</a>(<span class="stringliteral">&quot;ImageResizer.Plugins.DiskCache&quot;</span>);
<a name="l00199"></a>00199                 <span class="keywordflow">else</span> 
<a name="l00200"></a>00200                     c.<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html#aa8cdada7d657ec3078e5d16310f198f7" title="Access and modify plugins.">Plugins</a>.LoggingAvailable += delegate(<a class="code" href="interface_image_resizer_1_1_configuration_1_1_logging_1_1_i_log_manager.html">ILogManager</a> mgr) {
<a name="l00201"></a>00201                         <span class="keywordflow">if</span> (log != null) log = c.<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html#aa8cdada7d657ec3078e5d16310f198f7" title="Access and modify plugins.">Plugins</a>.<a class="code" href="class_image_resizer_1_1_configuration_1_1_plugin_config.html#a9f23aa7ba7f123b82a9bc17fcbac3a06" title="Returns the most recently registered Logging plugin, or null.">LogManager</a>.<a class="code" href="interface_image_resizer_1_1_configuration_1_1_logging_1_1_i_log_manager.html#af010ab8b5b3ec53a3f2305e64453fb06" title="Creates the specified logger object and assigns a LoggerName to it.">GetLogger</a>(<span class="stringliteral">&quot;ImageResizer.Plugins.DiskCache&quot;</span>);
<a name="l00202"></a>00202                     };
<a name="l00203"></a>00203             }
<a name="l00204"></a>00204             LoadSettings(c);
<a name="l00205"></a>00205             Start();
<a name="l00206"></a>00206             c.<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html#ab7d8e32249817ef77f91508c087140d9" title="Access and modify settings related to the HttpModule pipline. Register URL rewriting hooks...">Pipeline</a>.<a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#ac105b32b257375041ed2ce72c0e19291" title="Fired after all rewriting is finished. e.AllowAccess defaults to the result of the UrlAuthorization m...">AuthorizeImage</a> += Pipeline_AuthorizeImage;
<a name="l00207"></a>00207             c.<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html#aa8cdada7d657ec3078e5d16310f198f7" title="Access and modify plugins.">Plugins</a>.<a class="code" href="class_image_resizer_1_1_configuration_1_1_plugin_config.html#a24a5d36dc59eee7d980a8e9b4d00ead1" title="Only for use by plugins during IPlugin.Install. Call Plugin.Install instead of this method...">add_plugin</a>(<span class="keyword">this</span>);
<a name="l00208"></a>00208             <span class="keywordflow">return</span> <span class="keyword">this</span>;
<a name="l00209"></a>00209         }
<a name="l00210"></a>00210 
<a name="l00211"></a>00211         <span class="keywordtype">void</span> Pipeline_AuthorizeImage(IHttpModule sender, HttpContext context, <a class="code" href="interface_image_resizer_1_1_configuration_1_1_i_url_authorization_event_args.html">IUrlAuthorizationEventArgs</a> e) {
<a name="l00212"></a>00212             <span class="comment">//Don&#39;t allow direct access to the cache.</span>
<a name="l00213"></a>00213             <span class="keywordflow">if</span> (e.VirtualPath.IndexOf(<span class="keyword">this</span>.VirtualCacheDir, StringComparison.OrdinalIgnoreCase) &gt;= 0) e.AllowAccess = <span class="keyword">false</span>;
<a name="l00214"></a>00214         }
<a name="l00215"></a>00215 
<a name="l00216"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#ad9f28854949ae77bc24aaeec231b4cd0">00216</a>         <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#ad9f28854949ae77bc24aaeec231b4cd0" title="Uninstalls the plugin. Should reverse all changes made during Install.">Uninstall</a>(<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html">Config</a> c) {
<a name="l00217"></a>00217             c.<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html#aa8cdada7d657ec3078e5d16310f198f7" title="Access and modify plugins.">Plugins</a>.<a class="code" href="class_image_resizer_1_1_configuration_1_1_plugin_config.html#a0aae69c8ce761b0b5869fd63e2bcb863" title="For use only by plugins during .Uninstall. Removes the specified plugin from AllPlugins, QuerystringPlugins, CachingSystems, ImageEncoders, and ImageBuiderExtensions, based on which interfaces the instance implements. Plugins may register event handlers and modify settings - thus you should use the plugin&#39;s method to uninstall them vs. using this method.">remove_plugin</a>(<span class="keyword">this</span>);
<a name="l00218"></a>00218             c.<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html#ab7d8e32249817ef77f91508c087140d9" title="Access and modify settings related to the HttpModule pipline. Register URL rewriting hooks...">Pipeline</a>.<a class="code" href="class_image_resizer_1_1_configuration_1_1_pipeline_config.html#ac105b32b257375041ed2ce72c0e19291" title="Fired after all rewriting is finished. e.AllowAccess defaults to the result of the UrlAuthorization m...">AuthorizeImage</a> -= Pipeline_AuthorizeImage;
<a name="l00219"></a>00219             <span class="keywordflow">return</span> this.Stop();
<a name="l00220"></a>00220         }
<a name="l00221"></a>00221 
<a name="l00222"></a>00222 <span class="comment"></span>
<a name="l00223"></a>00223 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00224"></a>00224 <span class="comment">        /// Returns true if the configured settings are valid and .NET (not NTFS) permissions will work.</span>
<a name="l00225"></a>00225 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00226"></a>00226 <span class="comment">        /// &lt;returns&gt;&lt;/returns&gt;</span>
<a name="l00227"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#af2c79cf5af8ef3d96966936c1e522d2a">00227</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#af2c79cf5af8ef3d96966936c1e522d2a" title="Returns true if the configured settings are valid and .NET (not NTFS) permissions will work...">IsConfigurationValid</a>(){
<a name="l00228"></a>00228             <span class="keywordflow">return</span> !<span class="keywordtype">string</span>.IsNullOrEmpty(VirtualCacheDir) &amp;&amp; this.Enabled &amp;&amp; HasFileIOPermission();
<a name="l00229"></a>00229         }<span class="comment"></span>
<a name="l00230"></a>00230 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00231"></a>00231 <span class="comment">        /// Returns true if .NET permissions allow writing to the cache directory. Does not check NTFS permissions. </span>
<a name="l00232"></a>00232 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00233"></a>00233 <span class="comment">        /// &lt;returns&gt;&lt;/returns&gt;</span>
<a name="l00234"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a51f26c30ab93791154685b3837afc953">00234</a> <span class="comment"></span>        <span class="keyword">protected</span> <span class="keywordtype">bool</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a51f26c30ab93791154685b3837afc953" title="Returns true if .NET permissions allow writing to the cache directory. Does not check NTFS permission...">HasFileIOPermission</a>() {
<a name="l00235"></a>00235             FileIOPermission writePermission = <span class="keyword">new</span> FileIOPermission(FileIOPermissionAccess.AllAccess,<span class="keyword">new</span> <span class="keywordtype">string</span>[]{PhysicalCacheDir, Path.Combine(PhysicalCacheDir,<span class="stringliteral">&quot;web.config&quot;</span>)});
<a name="l00236"></a>00236             <span class="keywordflow">return</span> SecurityManager.IsGranted(writePermission);
<a name="l00237"></a>00237         }
<a name="l00238"></a>00238 
<a name="l00239"></a>00239         
<a name="l00240"></a>00240         <span class="keyword">protected</span> CustomDiskCache cache = null;
<a name="l00241"></a>00241         <span class="keyword">protected</span> CleanupManager cleaner = null;
<a name="l00242"></a>00242         <span class="keyword">protected</span> WebConfigWriter writer = null;
<a name="l00243"></a>00243 
<a name="l00244"></a>00244         <span class="keyword">protected</span> readonly <span class="keywordtype">object</span> _startSync = <span class="keyword">new</span> object();
<a name="l00245"></a>00245         <span class="keyword">protected</span> <span class="keyword">volatile</span> <span class="keywordtype">bool</span> _started = <span class="keyword">false</span>;<span class="comment"></span>
<a name="l00246"></a>00246 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00247"></a>00247 <span class="comment">        /// Returns true if the DiskCache instance is operational.</span>
<a name="l00248"></a>00248 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00249"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a32744b9ad1db64994e068f27cfe87314">00249</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> Started { <span class="keyword">get</span> { <span class="keywordflow">return</span> _started; } }<span class="comment"></span>
<a name="l00250"></a>00250 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00251"></a>00251 <span class="comment">        /// Attempts to start the DiskCache using the current settings. Returns true if succesful or if already started. Returns false on a configuration error.</span>
<a name="l00252"></a>00252 <span class="comment">        /// Called by Install()</span>
<a name="l00253"></a>00253 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00254"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a6c81fcb56683a5658456227469fa5d9a">00254</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a6c81fcb56683a5658456227469fa5d9a" title="Attempts to start the DiskCache using the current settings. Returns true if succesful or if already s...">Start</a>() {
<a name="l00255"></a>00255             <span class="keywordflow">if</span> (!IsConfigurationValid()) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00256"></a>00256             lock (_startSync) {
<a name="l00257"></a>00257                 <span class="keywordflow">if</span> (_started) <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00258"></a>00258                 <span class="keywordflow">if</span> (!IsConfigurationValid()) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00259"></a>00259 
<a name="l00260"></a>00260                 <span class="comment">//Init the writer.</span>
<a name="l00261"></a>00261                 writer = <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_web_config_writer.html" title="Handles writing a Web.Config to disk that uses Url Authorization to prevent visitors from accessing t...">WebConfigWriter</a>(<span class="keyword">this</span>,PhysicalCacheDir);
<a name="l00262"></a>00262                 <span class="comment">//Init the inner cache</span>
<a name="l00263"></a>00263                 cache = <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_custom_disk_cache.html" title="Handles access to a disk-based file cache. Handles locking and versioning. Supports subfolders for sc...">CustomDiskCache</a>(<span class="keyword">this</span>, PhysicalCacheDir, Subfolders, HashModifiedDate,AsyncBufferSize);
<a name="l00264"></a>00264                 <span class="comment">//Init the cleanup strategy</span>
<a name="l00265"></a>00265                 <span class="keywordflow">if</span> (AutoClean &amp;&amp; cleanupStrategy == null) cleanupStrategy = <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_cleanup_strategy.html">CleanupStrategy</a>(); <span class="comment">//Default settings if null</span>
<a name="l00266"></a>00266                 <span class="comment">//Init the cleanup worker</span>
<a name="l00267"></a>00267                 <span class="keywordflow">if</span> (AutoClean) cleaner = <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_cleanup_manager.html">CleanupManager</a>(<span class="keyword">this</span>, cache, cleanupStrategy);
<a name="l00268"></a>00268                 <span class="comment">//If we&#39;re running with subfolders, enqueue the cache root for cleanup (after the 5 minute delay)</span>
<a name="l00269"></a>00269                 <span class="comment">//so we don&#39;t eternally &#39;skip&#39; files in the root or in other unused subfolders (since only &#39;accessed&#39; subfolders are ever cleaned ). </span>
<a name="l00270"></a>00270                 <span class="keywordflow">if</span> (cleaner != null) cleaner.CleanAll();
<a name="l00271"></a>00271 
<a name="l00272"></a>00272                 <span class="keywordflow">if</span> (log != null) log.Info(<span class="stringliteral">&quot;DiskCache started successfully.&quot;</span>);
<a name="l00273"></a>00273                 <span class="comment">//Started successfully</span>
<a name="l00274"></a>00274                 _started = <span class="keyword">true</span>;
<a name="l00275"></a>00275                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00276"></a>00276             }
<a name="l00277"></a>00277         }<span class="comment"></span>
<a name="l00278"></a>00278 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00279"></a>00279 <span class="comment">        /// Returns true if stopped succesfully. Cannot be restarted</span>
<a name="l00280"></a>00280 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00281"></a>00281 <span class="comment">        /// &lt;returns&gt;&lt;/returns&gt;</span>
<a name="l00282"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a5cb5580fe25f56de3d31ca75ed91fa8c">00282</a> <span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#a5cb5580fe25f56de3d31ca75ed91fa8c" title="Returns true if stopped succesfully. Cannot be restarted.">Stop</a>() {
<a name="l00283"></a>00283             <span class="keywordflow">if</span> (cleaner != null) cleaner.Dispose();
<a name="l00284"></a>00284             cleaner = null;
<a name="l00285"></a>00285             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00286"></a>00286         }
<a name="l00287"></a>00287 
<a name="l00288"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#ad2c1159830b4553b13a51e6518b79fca">00288</a>         <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#ad2c1159830b4553b13a51e6518b79fca" title="Returns false if the cache is unable to process the request. If false, the caller should fall back to...">CanProcess</a>(HttpContext current, <a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html" title="A collection of data and callbacks that can be passed to a caching object.">IResponseArgs</a> e) {
<a name="l00289"></a>00289             <span class="comment">//Disk caching will &#39;pass on&#39; caching requests if &#39;cache=no&#39;.</span>
<a name="l00290"></a>00290             <span class="keywordflow">if</span> (((<a class="code" href="class_image_resizer_1_1_resize_settings.html" title="Represents the settings which will be used to process the image. Extends NameValueCollection to provi...">ResizeSettings</a>)e.<a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html#aa9dc61f9d5c59912f02c89da09abf69b" title="The rewritten querystring. Can be useful for caching systems that accept querystring arguments...">RewrittenQuerystring</a>).Cache == <a class="code" href="namespace_image_resizer.html#a6b30c95c789b77db2c5aa905345d917c" title="When to disk cache the image.">ServerCacheMode</a>.No) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00291"></a>00291             <span class="keywordflow">return</span> Started;<span class="comment">//Add support for nocache</span>
<a name="l00292"></a>00292         }
<a name="l00293"></a>00293 
<a name="l00294"></a>00294 
<a name="l00295"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#aea8298c74ed69a1689e1640f0991d825">00295</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_disk_cache.html#aea8298c74ed69a1689e1640f0991d825" title="Must update the cache if needed, then either rewrite, redirect or serve the cached data...">Process</a>(HttpContext context, <a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html" title="A collection of data and callbacks that can be passed to a caching object.">IResponseArgs</a> e) {
<a name="l00296"></a>00296 
<a name="l00297"></a>00297             <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_cache_result.html">CacheResult</a> r = Process(e);
<a name="l00298"></a>00298             context.Items[<span class="stringliteral">&quot;FinalCachedFile&quot;</span>] = r.<a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_cache_result.html#a29ef50e4a831f102e26f523f0007cc79" title="The physical path to the cached item. Verify .Data is null before trying to read from this file...">PhysicalPath</a>;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300             <span class="keywordflow">if</span> (r.<a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_cache_result.html#a46dd75c9f55a1061b9c4f80fa354d2bb" title="Provides a read-only stream to the data. Usually a MemoryStream instance, but you should dispose it o...">Data</a> == null) {
<a name="l00301"></a>00301 
<a name="l00302"></a>00302                 <span class="comment">//Calculate the virtual path</span>
<a name="l00303"></a>00303                 <span class="keywordtype">string</span> virtualPath = VirtualCacheDir.TrimEnd(<span class="charliteral">&#39;/&#39;</span>) + <span class="charliteral">&#39;/&#39;</span> + r.<a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_cache_result.html#ab6b009d31bcd4f00308a4f82c16f57ae" title="The path relative to the cache.">RelativePath</a>.Replace(<span class="charliteral">&#39;\\&#39;</span>, <span class="charliteral">&#39;/&#39;</span>).TrimStart(<span class="charliteral">&#39;/&#39;</span>);
<a name="l00304"></a>00304 
<a name="l00305"></a>00305                 <span class="comment">//Rewrite to cached, resized image.</span>
<a name="l00306"></a>00306                 context.RewritePath(virtualPath, <span class="keyword">false</span>);
<a name="l00307"></a>00307             } <span class="keywordflow">else</span> {
<a name="l00308"></a>00308                 <span class="comment">//Remap the response args writer to use the existing stream.</span>
<a name="l00309"></a>00309                 ((<a class="code" href="class_image_resizer_1_1_caching_1_1_response_args.html" title="IResponseArgs implementation.">ResponseArgs</a>)e).ResizeImageToStream = delegate(Stream s) {
<a name="l00310"></a>00310                     ((MemoryStream)r.<a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_cache_result.html#a46dd75c9f55a1061b9c4f80fa354d2bb" title="Provides a read-only stream to the data. Usually a MemoryStream instance, but you should dispose it o...">Data</a>).WriteTo(s);
<a name="l00311"></a>00311                 };
<a name="l00312"></a>00312                 context.RemapHandler(<span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_basic_1_1_no_cache_handler.html" title="Implements IHttpHandler, serves content for the NoCache plugin.">NoCacheHandler</a>(e));
<a name="l00313"></a>00313             }
<a name="l00314"></a>00314         }
<a name="l00315"></a>00315 
<a name="l00316"></a>00316         <span class="keyword">public</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_cache_result.html">CacheResult</a> Process(<a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html" title="A collection of data and callbacks that can be passed to a caching object.">IResponseArgs</a> e) {
<a name="l00317"></a>00317             <span class="comment">//Query for the modified date of the source file. If the source file changes on us during the write,</span>
<a name="l00318"></a>00318             <span class="comment">//we (may) end up saving the newer version in the cache properly, but with an older modified date.</span>
<a name="l00319"></a>00319             <span class="comment">//This will not cause any actual problems from a behavioral standpoint - the next request for the </span>
<a name="l00320"></a>00320             <span class="comment">//image will cause the file to be overwritten and the modified date updated.</span>
<a name="l00321"></a>00321             DateTime modDate = e.<a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html#aac9c73303f119c5530d14dfcdef7bce2" title="True if a modified date is available for verifying cache integrity.">HasModifiedDate</a> ? e.<a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html#a163d883b2e541e2702de8d7d09acec04" title="A delegate that returns the modified date of the source data.">GetModifiedDateUTC</a>() : DateTime.MinValue;
<a name="l00322"></a>00322 
<a name="l00323"></a>00323             <span class="comment">//Verify web.config exists in the cache folder.</span>
<a name="l00324"></a>00324             writer.CheckWebConfigEvery5();
<a name="l00325"></a>00325 
<a name="l00326"></a>00326             <span class="comment">//Cache the data to disk and return a path.</span>
<a name="l00327"></a>00327             <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_cache_result.html">CacheResult</a> r = cache.GetCachedFile(e.<a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html#a9325a2e3eb32f9e5b2a3e320fe51aab9" title="A string derived from the request, which can contain any kind of data. To get a cache key that varies...">RequestKey</a>, e.<a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html#ae76cf2d690bf450a0e71c7e33bb27d4c" title="A file extension appropriate for the resulting data. May be different than the extension on the origi...">SuggestedExtension</a>, e.<a class="code" href="interface_image_resizer_1_1_caching_1_1_i_response_args.html#a1090d53eee6cda04ba5ae3e611044495" title="A callback method that will resize, encode, and write the data to the given stream.">ResizeImageToStream</a>, modDate, CacheAccessTimeout,AsyncWrites);
<a name="l00328"></a>00328 
<a name="l00329"></a>00329             <span class="comment">//Fail</span>
<a name="l00330"></a>00330             <span class="keywordflow">if</span> (r.<a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_cache_result.html#acd995c6ea0a45350729d72bb88af1f31" title="The result of the cache check.">Result</a> == <a class="code" href="namespace_image_resizer_1_1_plugins_1_1_disk_cache.html#afb29b25106a646c2ee694841e4b57fa8">CacheQueryResult</a>.Failed)
<a name="l00331"></a>00331                 <span class="keywordflow">throw</span> <span class="keyword">new</span> ImageResizer.ImageProcessingException(<span class="stringliteral">&quot;Failed to acquire a lock on file \&quot;&quot;</span> + r.<a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_cache_result.html#a29ef50e4a831f102e26f523f0007cc79" title="The physical path to the cached item. Verify .Data is null before trying to read from this file...">PhysicalPath</a> + <span class="stringliteral">&quot;\&quot; within &quot;</span> + CacheAccessTimeout + <span class="stringliteral">&quot;ms. Caching failed.&quot;</span>);
<a name="l00332"></a>00332 
<a name="l00333"></a>00333             <span class="keywordflow">if</span> (r.<a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_cache_result.html#acd995c6ea0a45350729d72bb88af1f31" title="The result of the cache check.">Result</a> == <a class="code" href="namespace_image_resizer_1_1_plugins_1_1_disk_cache.html#afb29b25106a646c2ee694841e4b57fa8">CacheQueryResult</a>.Hit &amp;&amp; cleaner != null)
<a name="l00334"></a>00334                 cleaner.UsedFile(r.<a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_cache_result.html#ab6b009d31bcd4f00308a4f82c16f57ae" title="The path relative to the cache.">RelativePath</a>, r.<a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_cache_result.html#a29ef50e4a831f102e26f523f0007cc79" title="The physical path to the cached item. Verify .Data is null before trying to read from this file...">PhysicalPath</a>);
<a name="l00335"></a>00335 
<a name="l00336"></a>00336             <span class="keywordflow">return</span> r;
<a name="l00337"></a>00337         }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339         <span class="keyword">protected</span> <span class="keywordtype">bool</span> HasNTFSPermission(){
<a name="l00340"></a>00340             <span class="keywordflow">try</span> {
<a name="l00341"></a>00341                 <span class="keywordflow">if</span> (!Directory.Exists(PhysicalCacheDir)) Directory.CreateDirectory(PhysicalCacheDir);
<a name="l00342"></a>00342                 <span class="keywordtype">string</span> testFile = Path.Combine(this.PhysicalCacheDir, <span class="stringliteral">&quot;TestFile.txt&quot;</span>);
<a name="l00343"></a>00343                 File.WriteAllText(testFile, <span class="stringliteral">&quot;You may delete this file - it is written and deleted just to verify permissions are configured correctly&quot;</span>);
<a name="l00344"></a>00344                 File.Delete(testFile);
<a name="l00345"></a>00345                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00346"></a>00346             } <span class="keywordflow">catch</span> (Exception e){
<a name="l00347"></a>00347                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00348"></a>00348             }
<a name="l00349"></a>00349         }
<a name="l00350"></a>00350 
<a name="l00351"></a>00351         <span class="keyword">protected</span> <span class="keywordtype">string</span> GetExecutingUser() {
<a name="l00352"></a>00352             <span class="keywordflow">try</span> {
<a name="l00353"></a>00353                 <span class="keywordflow">return</span> Thread.CurrentPrincipal.Identity.Name;
<a name="l00354"></a>00354             } <span class="keywordflow">catch</span> {
<a name="l00355"></a>00355                 <span class="keywordflow">return</span> <span class="stringliteral">&quot;[Unknown - please check App Pool configuration]&quot;</span>;
<a name="l00356"></a>00356             }
<a name="l00357"></a>00357         }
<a name="l00358"></a>00358 
<a name="l00359"></a>00359         <span class="keyword">public</span> IEnumerable&lt;IIssue&gt; GetIssues() {
<a name="l00360"></a>00360             List&lt;IIssue&gt; issues = <span class="keyword">new</span> List&lt;IIssue&gt;();
<a name="l00361"></a>00361             <span class="keywordflow">if</span> (cleaner != null) issues.AddRange(cleaner.GetIssues());
<a name="l00362"></a>00362 
<a name="l00363"></a>00363             <span class="keywordflow">if</span> (!HasFileIOPermission()) 
<a name="l00364"></a>00364                 issues.Add(<span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_configuration_1_1_issues_1_1_issue.html">Issue</a>(<span class="stringliteral">&quot;DiskCache&quot;</span>, <span class="stringliteral">&quot;Failed to start: Write access to the cache directory is prohibited by your .NET trust level configuration.&quot;</span>, 
<a name="l00365"></a>00365                 <span class="stringliteral">&quot;Please configure your .NET trust level to permit writing to the cache directory. Most medium trust configurations allow this, but yours does not.&quot;</span>, <a class="code" href="namespace_image_resizer_1_1_configuration_1_1_issues.html#ada2af2a44c17c99a124cadb8a92f8555">IssueSeverity</a>.ConfigurationError));
<a name="l00366"></a>00366             
<a name="l00367"></a>00367             <span class="keywordflow">if</span> (!HasNTFSPermission()) 
<a name="l00368"></a>00368                 issues.Add(<span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_configuration_1_1_issues_1_1_issue.html">Issue</a>(<span class="stringliteral">&quot;DiskCache&quot;</span>, <span class="stringliteral">&quot;Not working: Your NTFS Security permissions are preventing the application from writing to the disk cache&quot;</span>,
<a name="l00369"></a>00369     <span class="stringliteral">&quot;Please give user &quot;</span> + GetExecutingUser() + <span class="stringliteral">&quot; read and write access to directory \&quot;&quot;</span> + PhysicalCacheDir + <span class="stringliteral">&quot;\&quot; to correct the problem. You can access NTFS security settings by right-clicking the aformentioned folder and choosing Properties, then Security.&quot;</span>, <a class="code" href="namespace_image_resizer_1_1_configuration_1_1_issues.html#ada2af2a44c17c99a124cadb8a92f8555">IssueSeverity</a>.ConfigurationError));
<a name="l00370"></a>00370 
<a name="l00371"></a>00371             <span class="keywordflow">if</span> (!Started &amp;&amp; !Enabled) issues.Add(<span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_configuration_1_1_issues_1_1_issue.html">Issue</a>(<span class="stringliteral">&quot;DiskCache&quot;</span>, <span class="stringliteral">&quot;DiskCache is disabled in Web.config. Set enabled=true on the &lt;diskcache /&gt; element to fix.&quot;</span>, null, <a class="code" href="namespace_image_resizer_1_1_configuration_1_1_issues.html#ada2af2a44c17c99a124cadb8a92f8555">IssueSeverity</a>.ConfigurationError));
<a name="l00372"></a>00372 
<a name="l00373"></a>00373             <span class="comment">//Warn user about setting hashModifiedDate=false in a web garden.</span>
<a name="l00374"></a>00374             <span class="keywordflow">if</span> (this.cleaner != null &amp;&amp; cleaner.ExteralProcessCleaning &amp;&amp; !<span class="keyword">this</span>.HashModifiedDate)
<a name="l00375"></a>00375                 issues.Add(<span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_configuration_1_1_issues_1_1_issue.html">Issue</a>(<span class="stringliteral">&quot;DiskCache&quot;</span>, <span class="stringliteral">&quot;You should set hashModifiedDate=\&quot;true\&quot; on the &lt;diskcache /&gt; element in Web.config.&quot;</span>,
<a name="l00376"></a>00376                     <span class="stringliteral">&quot;Setting false for this value in a Web Garden scenario can cause failed requests. (DiskCache detects one or more other process on this machine working on the same cache directory).&quot;</span>, <a class="code" href="namespace_image_resizer_1_1_configuration_1_1_issues.html#ada2af2a44c17c99a124cadb8a92f8555">IssueSeverity</a>.Critical));
<a name="l00377"></a>00377             <span class="keywordflow">if</span> (this.AsyncBufferSize &lt; 1024 * 1024 * 2)
<a name="l00378"></a>00378                 issues.Add(<span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_configuration_1_1_issues_1_1_issue.html">Issue</a>(<span class="stringliteral">&quot;DiskCache&quot;</span>, <span class="stringliteral">&quot;The asyncBufferSize should not be set below 2 megabytes (2097152). Found in the &lt;diskcache /&gt; element in Web.config.&quot;</span>,
<a name="l00379"></a>00379                     <span class="stringliteral">&quot;A buffer that is too small will cause requests to be processed synchronously. Remember to set the value to at least 4x the maximum size of an output image.&quot;</span>, <a class="code" href="namespace_image_resizer_1_1_configuration_1_1_issues.html#ada2af2a44c17c99a124cadb8a92f8555">IssueSeverity</a>.ConfigurationError));
<a name="l00380"></a>00380 
<a name="l00381"></a>00381             <span class="keywordtype">string</span> physicalCache = PhysicalCacheDir;
<a name="l00382"></a>00382             <span class="keywordflow">if</span> (!<span class="keywordtype">string</span>.IsNullOrEmpty(physicalCache)) {
<a name="l00383"></a>00383                 <span class="keywordtype">bool</span> isNetwork = <span class="keyword">false</span>;
<a name="l00384"></a>00384                 <span class="keywordflow">if</span> (physicalCache.StartsWith(<span class="stringliteral">&quot;\\\\&quot;</span>)) 
<a name="l00385"></a>00385                     isNetwork = <span class="keyword">true</span>;
<a name="l00386"></a>00386                 <span class="keywordflow">else</span>{
<a name="l00387"></a>00387                     <span class="keywordflow">try</span> {
<a name="l00388"></a>00388                         DriveInfo dri = <span class="keyword">new</span> DriveInfo(Path.GetPathRoot(physicalCache));
<a name="l00389"></a>00389                         <span class="keywordflow">if</span> (dri.DriveType == DriveType.Network) isNetwork = <span class="keyword">true</span>;
<a name="l00390"></a>00390                     } <span class="keywordflow">catch</span> { }
<a name="l00391"></a>00391                 }
<a name="l00392"></a>00392                 <span class="keywordflow">if</span> (isNetwork)
<a name="l00393"></a>00393                     issues.Add(<span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_configuration_1_1_issues_1_1_issue.html">Issue</a>(<span class="stringliteral">&quot;DiskCache&quot;</span>, <span class="stringliteral">&quot;It appears that the cache directory is located on a network drive.&quot;</span>,
<a name="l00394"></a>00394                         <span class="stringliteral">&quot;Both IIS and ASP.NET have trouble hosting websites with large numbers of folders over a network drive, such as a SAN. The cache will create &quot;</span> +
<a name="l00395"></a>00395                         Subfolders.ToString() + <span class="stringliteral">&quot; subfolders. If the total number of network-hosted folders exceeds 100, you should contact support@imageresizing.net and consult the documentation for details on configuring IIS and ASP.NET for this situation.&quot;</span>, <a class="code" href="namespace_image_resizer_1_1_configuration_1_1_issues.html#ada2af2a44c17c99a124cadb8a92f8555">IssueSeverity</a>.Warning));
<a name="l00396"></a>00396                     
<a name="l00397"></a>00397             }
<a name="l00398"></a>00398 
<a name="l00399"></a>00399             <span class="keywordflow">return</span> issues;
<a name="l00400"></a>00400         }
<a name="l00401"></a>00401     }
<a name="l00402"></a>00402 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Events</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
