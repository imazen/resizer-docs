<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>ImageResizer: C:/Users/nathanael/Documents/resizer/Plugins/Watermark/LegacyWatermarkFeatures.cs Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="imageresizer-logo-00aec4.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">ImageResizer
   &#160;<span id="projectnumber">3.4.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Events</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_0b4eaef40a1fe20bedafe9e8e719ce66.html">Plugins</a></li><li class="navelem"><a class="el" href="dir_1f627b62b053472e4bce8c272584933e.html">Watermark</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">LegacyWatermarkFeatures.cs</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/* Copyright (c) 2011 Nathanael Jones. See license.txt for your rights. */</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="keyword">using</span> System;</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="keyword">using</span> System.Collections.Generic;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="keyword">using</span> System.Text;</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="keyword">using</span> System.Collections.Specialized;</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="keyword">using</span> System.Drawing;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="keyword">using</span> System.Web;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="keyword">using</span> ImageResizer.Util;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="keyword">using</span> ImageResizer.Resizing;</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="keyword">using</span> System.Web.Hosting;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="keyword">using</span> ImageResizer.Configuration;</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="keyword">using</span> System.Web.Caching;</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="keyword">namespace </span>ImageResizer.Plugins.Watermark {<span class="comment"></span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">    /// &lt;summary&gt;</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">    /// Provides extensibility points for drawing watermarks and even modifying resizing/image settings</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">    /// &lt;/summary&gt;</span></div>
<div class="line"><a name="l00018"></a><span class="lineno"><a class="line" href="class_image_resizer_1_1_plugins_1_1_watermark_1_1_legacy_watermark_features.html">   18</a></span>&#160;<span class="comment"></span>    <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="class_image_resizer_1_1_plugins_1_1_watermark_1_1_legacy_watermark_features.html">LegacyWatermarkFeatures</a> : <a class="code" href="class_image_resizer_1_1_resizing_1_1_builder_extension.html">BuilderExtension</a> {</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;        [Obsolete(<span class="stringliteral">&quot;Use .OtherImages.Path instead&quot;</span>)]</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;        <span class="keyword">public</span> <span class="keywordtype">string</span> watermarkDir = null;</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;        [Obsolete(<span class="stringliteral">&quot;Use. OtherImages.Width/Height or a named preset instead&quot;</span>)]</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;        <span class="keyword">public</span> SizeF watermarkSize = <span class="keyword">new</span> SizeF(1, 1);</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;        [Obsolete(<span class="stringliteral">&quot;Use .OtherImages instead - it permits percentage and pixel values to be mixed.&quot;</span>)]</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;        <span class="keyword">public</span> Boolean valuesPercentages = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;        </div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;        <span class="keyword">public</span> Boolean keepAspectRatio = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;        [Obsolete(<span class="stringliteral">&quot;Use .OtherImages.Top/Left or an xml preset instead. &quot;</span>)]</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;        <span class="keyword">public</span> SizeF topLeftPadding = <span class="keyword">new</span> SizeF(0, 0);</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;        [Obsolete(<span class="stringliteral">&quot;Use .OtherImages.Bottom/Right or an xml preset instead.&quot;</span>)]</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;        <span class="keyword">public</span> SizeF bottomRightPadding = <span class="keyword">new</span> SizeF(0, 0);</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;        [Obsolete(<span class="stringliteral">&quot;New behavior defaults to true&quot;</span>)]</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;        <span class="keyword">public</span> Boolean hideIfTooSmall = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;        [Obsolete(<span class="stringliteral">&quot;Use .OtherImages.Align or an xml preset instead.&quot;</span>)]</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;        <span class="keyword">public</span> System.Drawing.ContentAlignment align = ContentAlignment.MiddleCenter;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;        <span class="keyword">protected</span> <a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html">Config</a> c;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;        </div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment">        /// &lt;summary&gt;</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment">        /// Loads a bitmap, cached using asp.net&#39;s cache</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment">        /// &lt;/summary&gt;</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="comment">        /// &lt;param name=&quot;localfile&quot;&gt;&lt;/param&gt;</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment">        /// &lt;returns&gt;&lt;/returns&gt;</span></div>
<div class="line"><a name="l00045"></a><span class="lineno"><a class="line" href="class_image_resizer_1_1_plugins_1_1_watermark_1_1_legacy_watermark_features.html#ad4f927e6cd43926ad66536dabd5ba0ed">   45</a></span>&#160;<span class="comment"></span>        <span class="keyword">public</span> Bitmap <a class="code" href="class_image_resizer_1_1_plugins_1_1_watermark_1_1_legacy_watermark_features.html#ad4f927e6cd43926ad66536dabd5ba0ed">GetMemCachedBitmap</a>(<span class="keywordtype">string</span> virtualPath) {</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;            <span class="comment">//If not ASP.NET, don&#39;t cache.</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;            <span class="keywordflow">if</span> (HttpContext.Current == null) <span class="keywordflow">return</span> c.CurrentImageBuilder.LoadImage(virtualPath, <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_resize_settings.html">ResizeSettings</a>());</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;            <span class="keywordtype">string</span> key = virtualPath.ToLowerInvariant();</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;            Bitmap b = HttpContext.Current.Cache[key] as Bitmap;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;            <span class="keywordflow">if</span> (b != null) <span class="keywordflow">return</span> b;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;            b = c.CurrentImageBuilder.LoadImage(virtualPath, <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_resize_settings.html">ResizeSettings</a>());</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;            <span class="comment">//Query VPPs for cache dependency. TODO: Add support for IVirtualImageProviders to customize cache dependencies.</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;            CacheDependency cd = null;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;            <span class="keywordflow">if</span> (HostingEnvironment.VirtualPathProvider != null) cd = HostingEnvironment.VirtualPathProvider.GetCacheDependency(virtualPath, <span class="keyword">new</span> <span class="keywordtype">string</span>[] { }, DateTime.UtcNow);</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;            HttpContext.Current.Cache.Insert(key, b, cd);</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;            <span class="keywordflow">return</span> b;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;        }</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;        <span class="keyword">protected</span> <span class="keywordtype">bool</span> LegacyDrawWatermark(<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html">ImageState</a> s) {</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;            <span class="keywordtype">string</span> watermark = s.settings[<span class="stringliteral">&quot;watermark&quot;</span>]; <span class="comment">//from the querystring</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;            Graphics g = s.destGraphics;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;            <span class="keywordflow">if</span> (<span class="keywordtype">string</span>.IsNullOrEmpty(watermark) || g == null) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;            <span class="keywordflow">if</span> (watermarkDir == null) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;            RectangleF imageBox = PolygonMath.GetBoundingBox(s.layout[<span class="stringliteral">&quot;image&quot;</span>]);</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;            <span class="comment">//Floor and cieling values to prevent fractional placement.</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;            imageBox.Width = (float)Math.Floor(imageBox.Width);</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;            imageBox.Height = (float)Math.Floor(imageBox.Height);</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;            imageBox.X = (float)Math.Ceiling(imageBox.X);</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;            imageBox.Y = (float)Math.Ceiling(imageBox.Y);</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;            <span class="keywordflow">if</span> (watermark.IndexOfAny(System.IO.Path.GetInvalidFileNameChars()) &gt; -1 ||</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;                watermark.IndexOfAny(<span class="keyword">new</span> <span class="keywordtype">char</span>[] { <span class="charliteral">&#39;\\&#39;</span>, <span class="charliteral">&#39;/&#39;</span> }) &gt; -1)</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;            <span class="comment">//Combine the directory with the base dir</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;            <span class="comment">//Is watermarkDir a physical path?</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;            <span class="keywordtype">char</span> slash = watermarkDir.Contains(<span class="stringliteral">&quot;/&quot;</span>) ? <span class="charliteral">&#39;/&#39;</span> : <span class="charliteral">&#39;\\&#39;</span>;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;            watermark = watermarkDir.TrimEnd(slash) + slash + watermark.TrimStart(slash);</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;            <span class="comment">//Verify the file exists if we&#39;re in ASP.NET. If the watermark doesn&#39;t exist, skip watermarking.</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;            <span class="keywordflow">if</span> (!c.Pipeline.FileExists(watermark, s.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a7229be6e840514ac987e571bfa7a9179">settings</a>) &amp;&amp; slash == <span class="charliteral">&#39;/&#39;</span>) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;            SizeF watermarkSize = this.watermarkSize;</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;            SizeF topLeftPadding = this.topLeftPadding;</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;            SizeF bottomRightPadding = this.bottomRightPadding;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;            <span class="comment">//Load the file specified in the querystring,</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;            Bitmap wb = GetMemCachedBitmap(watermark);</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;            lock (wb) {</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;                <span class="comment">//If percentages, resolve to pixels</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;                <span class="keywordflow">if</span> (valuesPercentages) {</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;                    <span class="comment">//Force into 0..1 range, inclusive.</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;                    watermarkSize.Height = Math.Max(0, Math.Min(1, watermarkSize.Height));</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;                    watermarkSize.Width = Math.Max(0, Math.Min(1, watermarkSize.Width));</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;                    topLeftPadding.Height = Math.Max(0, Math.Min(1, topLeftPadding.Height));</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;                    topLeftPadding.Width = Math.Max(0, Math.Min(1, topLeftPadding.Width));</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;                    bottomRightPadding.Height = Math.Max(0, Math.Min(1, bottomRightPadding.Height));</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;                    bottomRightPadding.Width = Math.Max(0, Math.Min(1, bottomRightPadding.Width));</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;                    <span class="comment">//Make sure everything adds up to 1</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;                    <span class="keywordtype">double</span> totalWidth = watermarkSize.Width + topLeftPadding.Width + bottomRightPadding.Width;</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;                    <span class="keywordflow">if</span> (totalWidth &gt; 1) {</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;                        totalWidth = 1 / totalWidth; <span class="comment">//Turn it into the factor we have to multiple by to make everything fit.</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;                        watermarkSize.Width *= (float)totalWidth;</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;                        topLeftPadding.Width *= (float)totalWidth;</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;                        bottomRightPadding.Width *= (float)totalWidth;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;                    }</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;                    <span class="keywordtype">double</span> totalHeight = watermarkSize.Height + topLeftPadding.Height + bottomRightPadding.Height;</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;                    <span class="keywordflow">if</span> (totalHeight &gt; 1) {</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;                        totalHeight = 1 / totalHeight; <span class="comment">//Turn it into the factor we have to multiply by to make everything fit.</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;                        watermarkSize.Height *= (float)totalHeight;</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;                        topLeftPadding.Height *= (float)totalHeight;</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;                        bottomRightPadding.Height *= (float)totalHeight;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;                    }</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;                    <span class="comment">//Now, we can resolve the percentages to pixels.</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;                    watermarkSize.Height *= imageBox.Height;</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;                    watermarkSize.Width *= imageBox.Width;</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;                    topLeftPadding.Height *= imageBox.Height;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;                    topLeftPadding.Width *= imageBox.Width;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;                    bottomRightPadding.Height *= imageBox.Height;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;                    bottomRightPadding.Width *= imageBox.Width;</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                }</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;                <span class="comment">//Keep aspect ratio, shrinking further if needed.</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;                <span class="keywordflow">if</span> (keepAspectRatio) watermarkSize = PolygonMath.DownScaleInside(wb.Size, watermarkSize);</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;                <span class="comment">//Floor all values to avoid rounding errors and blurry lines.</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;                watermarkSize = <span class="keyword">new</span> SizeF((<span class="keywordtype">float</span>)Math.Floor(watermarkSize.Width), (float)Math.Floor(watermarkSize.Height));</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;                topLeftPadding = <span class="keyword">new</span> SizeF((<span class="keywordtype">float</span>)Math.Floor(topLeftPadding.Width), (float)Math.Floor(topLeftPadding.Height));</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;                bottomRightPadding = <span class="keyword">new</span> SizeF((<span class="keywordtype">float</span>)Math.Floor(bottomRightPadding.Width), (float)Math.Floor(bottomRightPadding.Height));</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;                <span class="comment">//Check boundingbox</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;                SizeF watermarkBoundingBox = <span class="keyword">new</span> SizeF(watermarkSize.Width + topLeftPadding.Width + bottomRightPadding.Width,</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;                    watermarkSize.Height + topLeftPadding.Height + bottomRightPadding.Height);</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;                <span class="comment">//Don&#39;t draw the watermark if it is too small.</span></div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;                <span class="keywordflow">if</span> (!<a class="code" href="class_image_resizer_1_1_util_1_1_polygon_math.html">PolygonMath</a>.<a class="code" href="class_image_resizer_1_1_util_1_1_polygon_math.html#a98c83ada594ba88b34d97d26176f8ada">FitsInside</a>(watermarkBoundingBox, imageBox.Size)) {</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;                    <span class="keywordflow">if</span> (hideIfTooSmall) <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;                    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;                        SizeF oldSize = watermarkBoundingBox;</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;                        watermarkBoundingBox = PolygonMath.DownScaleInside(watermarkBoundingBox, imageBox.Size);</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;                        watermarkSize.Width -= (oldSize.Width - watermarkBoundingBox.Width);</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;                        watermarkSize.Height -= (oldSize.Height - watermarkBoundingBox.Height);</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;                    }</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;                }</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;                <span class="comment">//Floor all values again</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;                watermarkSize = <span class="keyword">new</span> SizeF((<span class="keywordtype">float</span>)Math.Floor(watermarkSize.Width), (float)Math.Floor(watermarkSize.Height));</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;                topLeftPadding = <span class="keyword">new</span> SizeF((<span class="keywordtype">float</span>)Math.Floor(topLeftPadding.Width), (float)Math.Floor(topLeftPadding.Height));</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;                bottomRightPadding = <span class="keyword">new</span> SizeF((<span class="keywordtype">float</span>)Math.Floor(bottomRightPadding.Width), (float)Math.Floor(bottomRightPadding.Height));</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;                <span class="keywordtype">float</span> innerWidth = (float)Math.Floor(imageBox.Width - Math.Abs(topLeftPadding.Width) - Math.Abs(bottomRightPadding.Width));</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;                <span class="keywordtype">float</span> innerHeight = (float)Math.Floor(imageBox.Height - Math.Abs(topLeftPadding.Height) - Math.Abs(bottomRightPadding.Height));</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;                <span class="keywordtype">float</span> x = 0;</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;                <span class="keywordtype">float</span> y = 0;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;                <span class="keywordflow">if</span> (align == ContentAlignment.BottomCenter || align == ContentAlignment.BottomLeft || align == ContentAlignment.BottomRight)</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;                    y = (innerHeight - watermarkSize.Height) + topLeftPadding.Height;</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;                if (align == ContentAlignment.MiddleCenter || align == ContentAlignment.MiddleLeft || align == ContentAlignment.MiddleRight)</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;                    y = (innerHeight - watermarkSize.Height) / 2 + topLeftPadding.Height;</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;                if (align == ContentAlignment.TopCenter || align == ContentAlignment.TopLeft || align == ContentAlignment.TopRight)</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                    y = topLeftPadding.Height;</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;                <span class="keywordflow">if</span> (align == ContentAlignment.BottomRight || align == ContentAlignment.MiddleRight || align == ContentAlignment.TopRight)</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;                    x = (innerWidth - watermarkSize.Width) + topLeftPadding.Width;</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;                if (align == ContentAlignment.BottomCenter || align == ContentAlignment.MiddleCenter || align == ContentAlignment.TopCenter)</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;                    x = (innerWidth - watermarkSize.Width) / 2 + topLeftPadding.Width;</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;                if (align == ContentAlignment.BottomLeft || align == ContentAlignment.MiddleLeft || align == ContentAlignment.TopLeft)</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;                    x = topLeftPadding.Width;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;                <span class="comment">//Draw watermark</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;                g.DrawImage(wb, <span class="keyword">new</span> Rectangle((<span class="keywordtype">int</span>)(x + imageBox.X), (<span class="keywordtype">int</span>)(y + imageBox.Y), (<span class="keywordtype">int</span>)watermarkSize.Width, (<span class="keywordtype">int</span>)watermarkSize.Height));</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;            }</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        }</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    }</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;}</div>
<div class="ttc" id="class_image_resizer_1_1_configuration_1_1_config_html"><div class="ttname"><a href="class_image_resizer_1_1_configuration_1_1_config.html">ImageResizer.Configuration.Config</a></div><div class="ttdef"><b>Definition:</b> <a href="_config_8cs_source.html#l00022">Config.cs:22</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_util_1_1_polygon_math_html_a98c83ada594ba88b34d97d26176f8ada"><div class="ttname"><a href="class_image_resizer_1_1_util_1_1_polygon_math.html#a98c83ada594ba88b34d97d26176f8ada">ImageResizer.Util.PolygonMath.FitsInside</a></div><div class="ttdeci">static bool FitsInside(SizeF inner, SizeF outer)</div><div class="ttdoc">Returns true if &amp;#39;inner&amp;#39; fits inside or equals &amp;#39;outer&amp;#39; </div><div class="ttdef"><b>Definition:</b> <a href="_polygon_math_8cs_source.html#l00420">PolygonMath.cs:420</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_resizing_1_1_image_state_html_a7229be6e840514ac987e571bfa7a9179"><div class="ttname"><a href="class_image_resizer_1_1_resizing_1_1_image_state.html#a7229be6e840514ac987e571bfa7a9179">ImageResizer.Resizing.ImageState.settings</a></div><div class="ttdeci">ResizeSettings settings</div><div class="ttdoc">The commands to apply to the bitmap </div><div class="ttdef"><b>Definition:</b> <a href="_image_state_8cs_source.html#l00025">ImageState.cs:25</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_plugins_1_1_watermark_1_1_legacy_watermark_features_html_ad4f927e6cd43926ad66536dabd5ba0ed"><div class="ttname"><a href="class_image_resizer_1_1_plugins_1_1_watermark_1_1_legacy_watermark_features.html#ad4f927e6cd43926ad66536dabd5ba0ed">ImageResizer.Plugins.Watermark.LegacyWatermarkFeatures.GetMemCachedBitmap</a></div><div class="ttdeci">Bitmap GetMemCachedBitmap(string virtualPath)</div><div class="ttdoc">Loads a bitmap, cached using asp.net&amp;#39;s cache </div><div class="ttdef"><b>Definition:</b> <a href="_legacy_watermark_features_8cs_source.html#l00045">LegacyWatermarkFeatures.cs:45</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_util_1_1_polygon_math_html"><div class="ttname"><a href="class_image_resizer_1_1_util_1_1_polygon_math.html">ImageResizer.Util.PolygonMath</a></div><div class="ttdoc">Defines a collection of utility functions for manipulating polygons. These functions may be (re)moved...</div><div class="ttdef"><b>Definition:</b> <a href="_polygon_math_8cs_source.html#l00013">PolygonMath.cs:13</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_resize_settings_html"><div class="ttname"><a href="class_image_resizer_1_1_resize_settings.html">ImageResizer.ResizeSettings</a></div><div class="ttdoc">Represents the settings which will be used to process the image. Extends NameValueCollection to provi...</div><div class="ttdef"><b>Definition:</b> <a href="_resize_settings_8cs_source.html#l00020">ResizeSettings.cs:20</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_resizing_1_1_image_state_html"><div class="ttname"><a href="class_image_resizer_1_1_resizing_1_1_image_state.html">ImageResizer.Resizing.ImageState</a></div><div class="ttdoc">Encapsulates the state of an image being resized. Can be used to simulate a resize as well as actuall...</div><div class="ttdef"><b>Definition:</b> <a href="_image_state_8cs_source.html#l00015">ImageState.cs:15</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_resizing_1_1_builder_extension_html"><div class="ttname"><a href="class_image_resizer_1_1_resizing_1_1_builder_extension.html">ImageResizer.Resizing.BuilderExtension</a></div><div class="ttdoc">Provides a useable base class that can be used to modify the behavior of ImageBuilder. When registered with an ImageBuilder instance, the ImageBuilder will call the corresponding methods on the extension prior to executing its own methods. </div><div class="ttdef"><b>Definition:</b> <a href="_builder_extension_8cs_source.html#l00011">BuilderExtension.cs:11</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_plugins_1_1_watermark_1_1_legacy_watermark_features_html"><div class="ttname"><a href="class_image_resizer_1_1_plugins_1_1_watermark_1_1_legacy_watermark_features.html">ImageResizer.Plugins.Watermark.LegacyWatermarkFeatures</a></div><div class="ttdoc">Provides extensibility points for drawing watermarks and even modifying resizing/image settings ...</div><div class="ttdef"><b>Definition:</b> <a href="_legacy_watermark_features_8cs_source.html#l00018">LegacyWatermarkFeatures.cs:18</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.5
</small></address>
</body>
</html>
