<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ImageResizer: ImageResizer.Plugins.WicBuilder.WicBuilderPlugin Class Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="imageresizer-logo-00aec4.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">ImageResizer
   &#160;<span id="projectnumber">3.3.3</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="classes.html"><span>Class&#160;Index</span></a></li>
      <li><a href="inherits.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Events</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="namespace_image_resizer.html">ImageResizer</a>      </li>
      <li class="navelem"><a class="el" href="namespace_image_resizer_1_1_plugins.html">Plugins</a>      </li>
      <li class="navelem"><a class="el" href="namespace_image_resizer_1_1_plugins_1_1_wic_builder.html">WicBuilder</a>      </li>
      <li class="navelem"><a class="el" href="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin.html">WicBuilderPlugin</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pro-methods">Protected Member Functions</a>  </div>
  <div class="headertitle">
<div class="title">ImageResizer.Plugins.WicBuilder.WicBuilderPlugin Class Reference</div>  </div>
</div><!--header-->
<div class="contents">
<!-- doxytag: class="ImageResizer::Plugins::WicBuilder::WicBuilderPlugin" --><!-- doxytag: inherits="ImageResizer::Resizing::BuilderExtension,ImageResizer::Plugins::IPlugin,ImageResizer::Configuration::Issues::IIssueProvider,ImageResizer::Plugins::IFileExtensionPlugin" --><div class="dynheader">
Inheritance diagram for ImageResizer.Plugins.WicBuilder.WicBuilderPlugin:</div>
<div class="dyncontent">
<div class="center"><img src="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin__inherit__graph.png" border="0" usemap="#_image_resizer_8_plugins_8_wic_builder_8_wic_builder_plugin_inherit__map" alt="Inheritance graph"/></div>
<map name="_image_resizer_8_plugins_8_wic_builder_8_wic_builder_plugin_inherit__map" id="_image_resizer_8_plugins_8_wic_builder_8_wic_builder_plugin_inherit__map">
<area shape="rect" id="node2" href="class_image_resizer_1_1_resizing_1_1_builder_extension.html" title="Provides a useable base class that can be used to modify the behavior of ImageBuilder. When registered with an ImageBuilder instance, the ImageBuilder will call the corresponding methods on the extension prior to executing its own methods." alt="" coords="59,102,316,149"/><area shape="rect" id="node4" href="class_image_resizer_1_1_resizing_1_1_abstract_image_processor.html" title="Not for external use. Inherit from BuilderExtension instead. Dual&#45;purpose base class for both ImageBu..." alt="" coords="5,6,371,53"/><area shape="rect" id="node6" href="interface_image_resizer_1_1_plugins_1_1_i_plugin.html" title="All plugins must implement this. Enables web.config addition and removal." alt="" coords="341,102,459,149"/><area shape="rect" id="node8" href="interface_image_resizer_1_1_configuration_1_1_issues_1_1_i_issue_provider.html" title="IIssueProvider" alt="" coords="483,102,705,149"/><area shape="rect" id="node10" href="interface_image_resizer_1_1_plugins_1_1_i_file_extension_plugin.html" title="For plugins that add support for new source file image extensions." alt="" coords="731,102,1037,149"/></map>
<center><span class="legend">[<a href="graph_legend.html">legend</a>]</span></center></div>
<div class="dynheader">
Collaboration diagram for ImageResizer.Plugins.WicBuilder.WicBuilderPlugin:</div>
<div class="dyncontent">
<div class="center"><img src="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin__coll__graph.png" border="0" usemap="#_image_resizer_8_plugins_8_wic_builder_8_wic_builder_plugin_coll__map" alt="Collaboration graph"/></div>
<map name="_image_resizer_8_plugins_8_wic_builder_8_wic_builder_plugin_coll__map" id="_image_resizer_8_plugins_8_wic_builder_8_wic_builder_plugin_coll__map">
<area shape="rect" id="node2" href="class_image_resizer_1_1_resizing_1_1_builder_extension.html" title="Provides a useable base class that can be used to modify the behavior of ImageBuilder. When registered with an ImageBuilder instance, the ImageBuilder will call the corresponding methods on the extension prior to executing its own methods." alt="" coords="59,102,316,149"/><area shape="rect" id="node4" href="class_image_resizer_1_1_resizing_1_1_abstract_image_processor.html" title="Not for external use. Inherit from BuilderExtension instead. Dual&#45;purpose base class for both ImageBu..." alt="" coords="5,6,371,53"/><area shape="rect" id="node6" href="interface_image_resizer_1_1_plugins_1_1_i_plugin.html" title="All plugins must implement this. Enables web.config addition and removal." alt="" coords="341,102,459,149"/><area shape="rect" id="node8" href="interface_image_resizer_1_1_configuration_1_1_issues_1_1_i_issue_provider.html" title="IIssueProvider" alt="" coords="483,102,705,149"/><area shape="rect" id="node10" href="interface_image_resizer_1_1_plugins_1_1_i_file_extension_plugin.html" title="For plugins that add support for new source file image extensions." alt="" coords="731,102,1037,149"/></map>
<center><span class="legend">[<a href="graph_legend.html">legend</a>]</span></center></div>

<p><a href="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin-members.html">List of all members.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a97b79ffbdeb2046c5b5eac49ee7e34e9"></a><!-- doxytag: member="ImageResizer::Plugins::WicBuilder::WicBuilderPlugin::Install" ref="a97b79ffbdeb2046c5b5eac49ee7e34e9" args="(Configuration.Config c)" -->
<a class="el" href="interface_image_resizer_1_1_plugins_1_1_i_plugin.html">IPlugin</a>&#160;</td><td class="memItemRight" valign="bottom"><b>Install</b> (<a class="el" href="class_image_resizer_1_1_configuration_1_1_config.html">Configuration.Config</a> c)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a8267dd21f3dbb1037ab7df7f9bb7acf5"></a><!-- doxytag: member="ImageResizer::Plugins::WicBuilder::WicBuilderPlugin::Uninstall" ref="a8267dd21f3dbb1037ab7df7f9bb7acf5" args="(Configuration.Config c)" -->
bool&#160;</td><td class="memItemRight" valign="bottom"><b>Uninstall</b> (<a class="el" href="class_image_resizer_1_1_configuration_1_1_config.html">Configuration.Config</a> c)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a9395ab5a936ee832819af009404c8a5d"></a><!-- doxytag: member="ImageResizer::Plugins::WicBuilder::WicBuilderPlugin::GetIssues" ref="a9395ab5a936ee832819af009404c8a5d" args="()" -->
IEnumerable&lt; <a class="el" href="interface_image_resizer_1_1_configuration_1_1_issues_1_1_i_issue.html">IIssue</a> &gt;&#160;</td><td class="memItemRight" valign="bottom"><b>GetIssues</b> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">IEnumerable&lt; string &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin.html#ac5da8942efdbf6a92d7736fb9f3d8192">GetSupportedFileExtensions</a> ()</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">If the plugin adds support for new file extensions (such as "psd"), they should be returned by this method.  <a href="#ac5da8942efdbf6a92d7736fb9f3d8192"></a><br/></td></tr>
<tr><td colspan="2"><h2><a name="pro-methods"></a>
Protected Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">override <a class="el" href="namespace_image_resizer_1_1_resizing.html#a22bbb53580a122efe469a26ad584fa86">RequestedAction</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin.html#ac298ce3871e1c85220f40da82b483205">BuildJob</a> (<a class="el" href="class_image_resizer_1_1_image_job.html">ImageJob</a> job)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Adds alternate pipeline based on WIC. Invoked by &amp;builder=wic. This method doesn't handle job.DisposeSource or job.DesposeDest or settings filtering, that's handled by <a class="el" href="class_image_resizer_1_1_image_builder.html" title="Provides methods for generating resized images, and for reading and writing them to disk...">ImageBuilder</a>. Handles all the work for turning 'source' into a byte[]/long pair.  <a href="#ac298ce3871e1c85220f40da82b483205"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual <a class="el" href="namespace_image_resizer_1_1_resizing.html#a22bbb53580a122efe469a26ad584fa86">RequestedAction</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin.html#a07987e59f23e7abf59d863db13240f42">BuildJobWic</a> (byte[] data, long lData, <a class="el" href="class_image_resizer_1_1_image_job.html">ImageJob</a> job, bool supportsTransparency)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Decodes the image in byte[] data, performs the image proccessing, and encodes it to job.Dest.  <a href="#a07987e59f23e7abf59d863db13240f42"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a5557df6ad105e2891607be8de0fe5832"></a><!-- doxytag: member="ImageResizer::Plugins::WicBuilder::WicBuilderPlugin::Encode" ref="a5557df6ad105e2891607be8de0fe5832" args="(IWICComponentFactory factory, IWICBitmapSource data, Size imageSize, ImageJob job)" -->
virtual <a class="el" href="namespace_image_resizer_1_1_resizing.html#a22bbb53580a122efe469a26ad584fa86">RequestedAction</a>&#160;</td><td class="memItemRight" valign="bottom"><b>Encode</b> (<a class="el" href="interface_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_i_w_i_c_component_factory.html">IWICComponentFactory</a> factory, <a class="el" href="interface_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_i_w_i_c_bitmap_source.html">IWICBitmapSource</a> data, Size imageSize, <a class="el" href="class_image_resizer_1_1_image_job.html">ImageJob</a> job)</td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock">
<p>Definition at line <a class="el" href="_wic_builder_8cs_source.html#l00023">23</a> of file <a class="el" href="_wic_builder_8cs_source.html">WicBuilder.cs</a>.</p>
</div><hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="ac298ce3871e1c85220f40da82b483205"></a><!-- doxytag: member="ImageResizer::Plugins::WicBuilder::WicBuilderPlugin::BuildJob" ref="ac298ce3871e1c85220f40da82b483205" args="(ImageJob job)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">override <a class="el" href="namespace_image_resizer_1_1_resizing.html#a22bbb53580a122efe469a26ad584fa86">RequestedAction</a> <a class="el" href="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin.html#ac298ce3871e1c85220f40da82b483205">ImageResizer.Plugins.WicBuilder.WicBuilderPlugin.BuildJob</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_image_resizer_1_1_image_job.html">ImageJob</a>&#160;</td>
          <td class="paramname"><em>job</em></td><td>)</td>
          <td><code> [inline, protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Adds alternate pipeline based on WIC. Invoked by &amp;builder=wic. This method doesn't handle job.DisposeSource or job.DesposeDest or settings filtering, that's handled by <a class="el" href="class_image_resizer_1_1_image_builder.html" title="Provides methods for generating resized images, and for reading and writing them to disk...">ImageBuilder</a>. Handles all the work for turning 'source' into a byte[]/long pair. </p>
<dl class="params"><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">job</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd></dd></dl>

<p>Definition at line <a class="el" href="_wic_builder_8cs_source.html#l00048">48</a> of file <a class="el" href="_wic_builder_8cs_source.html">WicBuilder.cs</a>.</p>
<div class="fragment"><pre class="fragment">                                                                  {
            <span class="keywordflow">if</span> (!<span class="stringliteral">&quot;wic&quot;</span>.Equals(job.Settings[<span class="stringliteral">&quot;builder&quot;</span>])) <span class="keywordflow">return</span> <a class="code" href="namespace_image_resizer_1_1_resizing.html#a22bbb53580a122efe469a26ad584fa86" title="What to do about remaining handlers/methods for the specified section.">RequestedAction</a>.None;

            <span class="comment">//Convert the source stream to a byte[] array and length.</span>
            byte[] data = null;
            <span class="keywordtype">long</span> lData = 0;


            <span class="comment">//This step gets a Stream instance, copies it to a MemoryStream, then accesses the underlying buffer to get the byte[] and length we need.</span>
            Stream s = null;
            <span class="keywordtype">bool</span> disposeStream = !(job.Source is Stream);
            <span class="keywordtype">long</span> originalPosition = 0;
            <span class="keywordtype">bool</span> restoreStreamPosition = <span class="keyword">false</span>;
            <span class="keywordflow">try</span> {
                <span class="comment">//Get a Stream instance for the job</span>
                <span class="keywordtype">string</span> path;
                s = c.<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html#a9b11da5f1856427a835034d52700c093" title="Returns a shared instance of ImageManager, (or a subclass if it has been upgraded). Instances change whenever ImageBuilderExtensions change.">CurrentImageBuilder</a>.<a class="code" href="class_image_resizer_1_1_image_builder.html#ab51799a036b1624f4e5d9c2aa2fcfa88" title="For plugin use only. Returns a stream instance from the specified source object and settings object...">GetStreamFromSource</a>(job.Source, job.Settings, ref disposeStream, out path, out restoreStreamPosition);
                <span class="keywordflow">if</span> (s == null) <span class="keywordflow">return</span> <a class="code" href="namespace_image_resizer_1_1_resizing.html#a22bbb53580a122efe469a26ad584fa86" title="What to do about remaining handlers/methods for the specified section.">RequestedAction</a>.None; <span class="comment">//We don&#39;t support the source object!</span>
                <span class="keywordflow">if</span> (job.ResetSourceStream) restoreStreamPosition = <span class="keyword">true</span>;
                job.SourcePathData = path;

                <span class="comment">//Save the original stream positione</span>
                originalPosition = (restoreStreamPosition) ? s.Position : -1;

                data = <a class="code" href="class_image_resizer_1_1_extension_methods_1_1_stream_extensions.html" title="Provides extension methods for copying streams.">StreamExtensions</a>.<a class="code" href="class_image_resizer_1_1_extension_methods_1_1_stream_extensions.html#a37c8daa2d13e4f2343b80b352a91796a" title="Attempts to return a byte[] array containing the remaining portion of the stream. Unlike CopyToBytes(...">CopyOrReturnBuffer</a>(s, out lData,<span class="keyword">false</span>, 0x1000);
            } <span class="keywordflow">finally</span> {
                <span class="keywordflow">if</span> (s != null &amp;&amp; restoreStreamPosition &amp;&amp; s.CanSeek) s.Seek(originalPosition, SeekOrigin.Begin);
                <span class="keywordflow">if</span> (disposeStream) s.Dispose();
            }

            <span class="comment">//Ok, now we have our byte[] and length. </span>

            <span class="comment">//Let&#39;s find out if transparency is supported.</span>
            <a class="code" href="interface_image_resizer_1_1_encoding_1_1_i_encoder.html" title="An image encoder. Exposes methods for suitability checking, encoding, transparency compatibility chec...">IEncoder</a> managedEncoder = c.<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html#aa8cdada7d657ec3078e5d16310f198f7" title="Access and modify plugins.">Plugins</a>.<a class="code" href="class_image_resizer_1_1_configuration_1_1_plugin_config.html#a2e4ab3b7cd725d4048be67bc21725eb4" title="Returns an instance of the first encoder that claims to be able to handle the specified settings...">GetEncoder</a>(job.Settings, job.SourcePathData);

            <span class="keywordtype">bool</span> supportsTransparency = managedEncoder.<a class="code" href="interface_image_resizer_1_1_encoding_1_1_i_encoder.html#adb440f5f1d5b9a4ba55df65163cc8c40" title="True if the output format will support transparency as it is currently configured.">SupportsTransparency</a>;

            <a class="code" href="namespace_image_resizer_1_1_resizing.html#a22bbb53580a122efe469a26ad584fa86" title="What to do about remaining handlers/methods for the specified section.">RequestedAction</a> result = <a class="code" href="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin.html#a07987e59f23e7abf59d863db13240f42" title="Decodes the image in byte[] data, performs the image proccessing, and encodes it to job...">BuildJobWic</a>(data, lData, job, supportsTransparency);
            GC.KeepAlive(data);
            <span class="keywordflow">return</span> result;
        }
</pre></div>
</div>
</div>
<a class="anchor" id="a07987e59f23e7abf59d863db13240f42"></a><!-- doxytag: member="ImageResizer::Plugins::WicBuilder::WicBuilderPlugin::BuildJobWic" ref="a07987e59f23e7abf59d863db13240f42" args="(byte[] data, long lData, ImageJob job, bool supportsTransparency)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">virtual <a class="el" href="namespace_image_resizer_1_1_resizing.html#a22bbb53580a122efe469a26ad584fa86">RequestedAction</a> <a class="el" href="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin.html#a07987e59f23e7abf59d863db13240f42">ImageResizer.Plugins.WicBuilder.WicBuilderPlugin.BuildJobWic</a> </td>
          <td>(</td>
          <td class="paramtype">byte[]&#160;</td>
          <td class="paramname"><em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">long&#160;</td>
          <td class="paramname"><em>lData</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_image_resizer_1_1_image_job.html">ImageJob</a>&#160;</td>
          <td class="paramname"><em>job</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>supportsTransparency</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [inline, protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Decodes the image in byte[] data, performs the image proccessing, and encodes it to job.Dest. </p>
<dl class="params"><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">data</td><td>The buffer containing the encoded image file</td></tr>
    <tr><td class="paramname">lData</td><td>The number of bytes to read</td></tr>
    <tr><td class="paramname">job</td><td></td></tr>
    <tr><td class="paramname">supportsTransparency</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd></dd></dl>

<p>Definition at line <a class="el" href="_wic_builder_8cs_source.html#l00098">98</a> of file <a class="el" href="_wic_builder_8cs_source.html">WicBuilder.cs</a>.</p>
<div class="fragment"><pre class="fragment">                                                                                                                        {

            ResizeSettings settings = job.Settings; ResizeSettings q = settings;
            <span class="keywordtype">string</span> path = job.SourcePathData;

            <span class="comment">//A list of COM objects to destroy</span>
            List&lt;object&gt; com = <span class="keyword">new</span> List&lt;object&gt;();
            <span class="keywordflow">try</span> {
                <span class="comment">//Create the factory</span>
                <a class="code" href="interface_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_i_w_i_c_component_factory.html">IWICComponentFactory</a> factory  = (<a class="code" href="interface_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_i_w_i_c_component_factory.html">IWICComponentFactory</a>)<span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_w_i_c_imaging_factory.html">WICImagingFactory</a>();
                com.Add(factory);

                <span class="comment">//Wrap the byte[] with a IWICStream instance</span>
                var streamWrapper = factory.CreateStream();
                streamWrapper.InitializeFromMemory(data, (uint)lData);
                com.Add(streamWrapper);

                var decoder = factory.CreateDecoderFromStream(streamWrapper, null,
                                                              WICDecodeOptions.WICDecodeMetadataCacheOnLoad);
                com.Add(decoder);

                <span class="comment">//Figure out which frame to work with</span>
                <span class="keywordtype">int</span> frameIndex = 0;
                <span class="keywordflow">if</span> (!<span class="keywordtype">string</span>.IsNullOrEmpty(q[<span class="stringliteral">&quot;page&quot;</span>]) &amp;&amp; !<span class="keywordtype">int</span>.TryParse(q[<span class="stringliteral">&quot;page&quot;</span>], NumberStyles.Number, NumberFormatInfo.InvariantInfo, out frameIndex))
                    <span class="keywordflow">if</span> (!<span class="keywordtype">string</span>.IsNullOrEmpty(q[<span class="stringliteral">&quot;frame&quot;</span>]) &amp;&amp; !<span class="keywordtype">int</span>.TryParse(q[<span class="stringliteral">&quot;frame&quot;</span>], NumberStyles.Number, NumberFormatInfo.InvariantInfo, out frameIndex))
                        frameIndex = 0;

                <span class="comment">//So users can use 1-based numbers</span>
                frameIndex--;

                <span class="keywordflow">if</span> (frameIndex &gt; 0) {
                    <span class="keywordtype">int</span> frameCount = (int)decoder.GetFrameCount(); <span class="comment">//Don&#39;t let the user go past the end.</span>
                    <span class="keywordflow">if</span> (frameIndex &gt;= frameCount) frameIndex = frameCount - 1;
                }

                <a class="code" href="interface_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_i_w_i_c_bitmap_frame_decode.html">IWICBitmapFrameDecode</a> frame = decoder.GetFrame((uint)Math.Max(0,frameIndex));
                com.Add(frame);

                

                WICBitmapInterpolationMode interpolationMode = WICBitmapInterpolationMode.WICBitmapInterpolationModeFant;
                <span class="keywordflow">if</span> (<span class="stringliteral">&quot;nearest&quot;</span>.Equals(settings[<span class="stringliteral">&quot;w.filter&quot;</span>], StringComparison.OrdinalIgnoreCase)) interpolationMode = WICBitmapInterpolationMode.WICBitmapInterpolationModeNearestNeighbor;
                <span class="keywordflow">if</span> (<span class="stringliteral">&quot;bicubic&quot;</span>.Equals(settings[<span class="stringliteral">&quot;w.filter&quot;</span>], StringComparison.OrdinalIgnoreCase)) interpolationMode = WICBitmapInterpolationMode.WICBitmapInterpolationModeCubic;
                <span class="keywordflow">if</span> (<span class="stringliteral">&quot;linear&quot;</span>.Equals(settings[<span class="stringliteral">&quot;w.filter&quot;</span>], StringComparison.OrdinalIgnoreCase)) interpolationMode = WICBitmapInterpolationMode.WICBitmapInterpolationModeLinear;
                <span class="keywordflow">if</span> (<span class="stringliteral">&quot;nearestneighbor&quot;</span>.Equals(settings[<span class="stringliteral">&quot;w.filter&quot;</span>], StringComparison.OrdinalIgnoreCase)) interpolationMode = WICBitmapInterpolationMode.WICBitmapInterpolationModeLinear;
                
                <span class="comment">//Find the original image size</span>
                uint origWidth, origHeight;
                frame.GetSize(out origWidth,out origHeight);
                Size orig = <span class="keyword">new</span> Size((<span class="keywordtype">int</span>)origWidth,(<span class="keywordtype">int</span>)origHeight);

                Guid pixelFormat;
                frame.GetPixelFormat(out pixelFormat);
                <span class="comment">//Calculate the new size of the image and the canvas.</span>
                <a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html" title="Encapsulates the state of an image being resized. Can be used to simulate a resize as well as actuall...">ImageState</a> state = <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html" title="Encapsulates the state of an image being resized. Can be used to simulate a resize as well as actuall...">ImageState</a>(settings, orig, <span class="keyword">true</span>);
                c.<a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html#a9b11da5f1856427a835034d52700c093" title="Returns a shared instance of ImageManager, (or a subclass if it has been upgraded). Instances change whenever ImageBuilderExtensions change.">CurrentImageBuilder</a>.<a class="code" href="class_image_resizer_1_1_image_builder.html#a8e2f4b3bbf8bb38e54249490122ebb71" title="Processes an ImageState instance. Used by Build, GetFinalSize, and TranslatePoint. Can be overriden by a plugin with the OnProcess method.">Process</a>(state);


                Rectangle imageDest = <a class="code" href="class_image_resizer_1_1_util_1_1_polygon_math.html" title="Defines a collection of utility functions for manipulating polygons. These functions may be (re)moved...">PolygonMath</a>.<a class="code" href="class_image_resizer_1_1_util_1_1_polygon_math.html#a61b50db80ba6c732565d07ef6163c0a0" title="Rounds a floating-point rectangle to an integer rectangle using System.Round.">ToRectangle</a>(<a class="code" href="class_image_resizer_1_1_util_1_1_polygon_math.html" title="Defines a collection of utility functions for manipulating polygons. These functions may be (re)moved...">PolygonMath</a>.<a class="code" href="class_image_resizer_1_1_util_1_1_polygon_math.html#a2a0699cc81aa9335505c77939c6ba4bd" title="Returns a bounding box for the specified set of points.">GetBoundingBox</a>(state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a845b5dc0d563cd83e8591ceccdbfe31e" title="The layout object. Used for calculated and flowing the layout of the various rings around the image (...">layout</a>[<span class="stringliteral">&quot;image&quot;</span>]));

              
                <a class="code" href="interface_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_i_w_i_c_bitmap_source.html">IWICBitmapSource</a> imageData = frame; 
                <span class="comment">//Are we cropping? then daisy-chain a clipper</span>
                <span class="keywordflow">if</span> (state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a22528462bb2ca64173878ef4441bad28" title="The rectangular portion of the source image to copy.">copyRect</a>.Left != 0 || state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a22528462bb2ca64173878ef4441bad28" title="The rectangular portion of the source image to copy.">copyRect</a>.Top != 0 || state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a22528462bb2ca64173878ef4441bad28" title="The rectangular portion of the source image to copy.">copyRect</a>.Width != state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a72e11433b4c36caccab68577e864202c" title="The original size of the source bitmap. Use this instead of accessing the bitmap directly for this in...">originalSize</a>.Width || state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a22528462bb2ca64173878ef4441bad28" title="The rectangular portion of the source image to copy.">copyRect</a>.Height != state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a72e11433b4c36caccab68577e864202c" title="The original size of the source bitmap. Use this instead of accessing the bitmap directly for this in...">originalSize</a>.Height) {

                    <span class="comment">//Cropping is absurdly slow... 4x slower than resizing!</span>
                    <span class="comment">//Cropping after resizing (unintuitively) is faster.</span>
                    <span class="keywordflow">if</span> (imageDest.Width != state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a72e11433b4c36caccab68577e864202c" title="The original size of the source bitmap. Use this instead of accessing the bitmap directly for this in...">originalSize</a>.Width || imageDest.Height != state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a72e11433b4c36caccab68577e864202c" title="The original size of the source bitmap. Use this instead of accessing the bitmap directly for this in...">originalSize</a>.Height) {
                        <span class="keywordtype">double</span> sx = (double)imageDest.Width / (<span class="keywordtype">double</span>)state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a22528462bb2ca64173878ef4441bad28" title="The rectangular portion of the source image to copy.">copyRect</a>.Width;
                        <span class="keywordtype">double</span> sy = (double)imageDest.Height / (<span class="keywordtype">double</span>)state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a22528462bb2ca64173878ef4441bad28" title="The rectangular portion of the source image to copy.">copyRect</a>.Height;
                        uint uncroppedDestWidth = (uint)Math.Round(sx * state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a72e11433b4c36caccab68577e864202c" title="The original size of the source bitmap. Use this instead of accessing the bitmap directly for this in...">originalSize</a>.Width);
                        uint uncroppedDestHeight = (uint)Math.Round(sy * state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a72e11433b4c36caccab68577e864202c" title="The original size of the source bitmap. Use this instead of accessing the bitmap directly for this in...">originalSize</a>.Height);
                        
                        var scaler = factory.CreateBitmapScaler();
                        scaler.Initialize(imageData, uncroppedDestWidth, uncroppedDestHeight, interpolationMode);
                        com.Add(scaler);

                        <span class="comment">//TODO: cropping is not consistent with GDI.</span>
                        var clipper = factory.CreateBitmapClipper();
                        clipper.Initialize(scaler, <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_w_i_c_rect.html">WICRect</a> { 
                            X = (int)Math.Floor((<span class="keywordtype">double</span>)state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a22528462bb2ca64173878ef4441bad28" title="The rectangular portion of the source image to copy.">copyRect</a>.X * sx),
                            Y = (int)Math.Floor((<span class="keywordtype">double</span>)state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a22528462bb2ca64173878ef4441bad28" title="The rectangular portion of the source image to copy.">copyRect</a>.Y * sy), 
                            Width = imageDest.Width, 
                            Height = imageDest.Height
                        });
                        com.Add(clipper);
                        imageData = clipper;

                    } <span class="keywordflow">else</span> {
                        var clipper = factory.CreateBitmapClipper();
                        clipper.Initialize(imageData, <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_wic_1_1_interop_services_1_1_com_types_1_1_w_i_c_rect.html">WICRect</a> { X = (int)state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a22528462bb2ca64173878ef4441bad28" title="The rectangular portion of the source image to copy.">copyRect</a>.X, Y = (<span class="keywordtype">int</span>)state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a22528462bb2ca64173878ef4441bad28" title="The rectangular portion of the source image to copy.">copyRect</a>.Y, Width = (int)state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a22528462bb2ca64173878ef4441bad28" title="The rectangular portion of the source image to copy.">copyRect</a>.Width, Height = (<span class="keywordtype">int</span>)state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a22528462bb2ca64173878ef4441bad28" title="The rectangular portion of the source image to copy.">copyRect</a>.Height });
                        com.Add(clipper);
                        imageData = clipper;
                    }
                    <span class="comment">//If we&#39;re scaling but not cropping.</span>
                }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (imageDest.Width != state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a72e11433b4c36caccab68577e864202c" title="The original size of the source bitmap. Use this instead of accessing the bitmap directly for this in...">originalSize</a>.Width || imageDest.Height != state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#a72e11433b4c36caccab68577e864202c" title="The original size of the source bitmap. Use this instead of accessing the bitmap directly for this in...">originalSize</a>.Height) {
                    var scaler = factory.CreateBitmapScaler();
                    scaler.Initialize(imageData, (uint)imageDest.Width, (uint)imageDest.Height, interpolationMode);
                    com.Add(scaler);
                    imageData = scaler;
                }

                

                <span class="comment">//Are we padding? Then we have to do an intermediate write.</span>
                <span class="keywordflow">if</span> (state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#af7685bdf458df8b87e3de9f18629c919" title="The size of the target bitmap image. Set after all sizing operations have completed.">destSize</a>.Width != imageDest.Width || state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#af7685bdf458df8b87e3de9f18629c919" title="The size of the target bitmap image. Set after all sizing operations have completed.">destSize</a>.Height != imageDest.Height){
                    byte[] bgcolor = <a class="code" href="class_image_resizer_1_1_plugins_1_1_wic_1_1_conversion_utils.html">ConversionUtils</a>.ConvertColor(job.Settings.BackgroundColor, pixelFormat);

                    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; bgcolor.Length; i++) bgcolor[i] = 255; <span class="comment">//White</span>

                    var padder = <span class="keyword">new</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_wic_1_1_wic_bitmap_padder.html">WicBitmapPadder</a>(imageData, imageDest.X, imageDest.Y, state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#af7685bdf458df8b87e3de9f18629c919" title="The size of the target bitmap image. Set after all sizing operations have completed.">destSize</a>.Width - (imageDest.X + imageDest.Width), state.<a class="code" href="class_image_resizer_1_1_resizing_1_1_image_state.html#af7685bdf458df8b87e3de9f18629c919" title="The size of the target bitmap image. Set after all sizing operations have completed.">destSize</a>.Height - (imageDest.Y + imageDest.Height), bgcolor, null);
                    imageData = padder;
                }

                <span class="comment">//Now encode imageData and be done with it...</span>
                <span class="keywordflow">return</span> Encode(factory, imageData, imageDest.Size, job);
            } <span class="keywordflow">finally</span> {
                <span class="comment">//Manually cleanup all the com reference counts, aggressively</span>
                <span class="keywordflow">while</span> (com.Count &gt; 0) {
                    Marshal.ReleaseComObject(com[com.Count - 1]); <span class="comment">//In reverse order, so no item is ever deleted out from under another.</span>
                    com.RemoveAt(com.Count - 1);
                }
            }
        }
</pre></div>
</div>
</div>
<a class="anchor" id="ac5da8942efdbf6a92d7736fb9f3d8192"></a><!-- doxytag: member="ImageResizer::Plugins::WicBuilder::WicBuilderPlugin::GetSupportedFileExtensions" ref="ac5da8942efdbf6a92d7736fb9f3d8192" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">IEnumerable&lt;string&gt; <a class="el" href="class_image_resizer_1_1_plugins_1_1_wic_builder_1_1_wic_builder_plugin.html#ac5da8942efdbf6a92d7736fb9f3d8192">ImageResizer.Plugins.WicBuilder.WicBuilderPlugin.GetSupportedFileExtensions</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>If the plugin adds support for new file extensions (such as "psd"), they should be returned by this method. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd></dd></dl>

<p>Implements <a class="el" href="interface_image_resizer_1_1_plugins_1_1_i_file_extension_plugin.html#a53672fd2aee854a01f313f099c95b330">ImageResizer.Plugins.IFileExtensionPlugin</a>.</p>

<p>Definition at line <a class="el" href="_wic_builder_8cs_source.html#l00266">266</a> of file <a class="el" href="_wic_builder_8cs_source.html">WicBuilder.cs</a>.</p>
<div class="fragment"><pre class="fragment">                                                                {
            <span class="keywordflow">return</span> <span class="keyword">new</span> <span class="keywordtype">string</span>[]{<span class="stringliteral">&quot;hdp&quot;</span>,<span class="stringliteral">&quot;jxr&quot;</span>,<span class="stringliteral">&quot;wdp&quot;</span>};<span class="comment">//Plus the ones already listed by ImageBuilder</span>
            <span class="comment">//We can enumerate available codecs through factory.CreateComponentEnumerator and factory.CreateComponentInfo...</span>
            <span class="comment">//But those codecs only give us Author, CLSID, FriendlyName, SpecVersion, VendorGUID, and Version. No list of supported file extensions.</span>
            <span class="comment">//So maybe it&#39;s best to make that user-specified?</span>
        }
</pre></div>
</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li>C:/Users/Administrator/Documents/resizer/Plugins/Wic/<a class="el" href="_wic_builder_8cs_source.html">WicBuilder.cs</a></li>
</ul>
</div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Events</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
