<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>ImageResizer: C:/Users/nathanael/Documents/resizer/Plugins/DiskCache/LockProvider.cs Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="imageresizer-logo-00aec4.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">ImageResizer
   &#160;<span id="projectnumber">3.4.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Events</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_0b4eaef40a1fe20bedafe9e8e719ce66.html">Plugins</a></li><li class="navelem"><a class="el" href="dir_c40d1be011819c7d3f0b5389486b8856.html">DiskCache</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">LockProvider.cs</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/* Copyright (c) 2011 Nathanael Jones. See license.txt for your rights. */</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="keyword">using</span> System;</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="keyword">using</span> System.Collections.Generic;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="keyword">using</span> System.Text;</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="keyword">using</span> System.Threading;</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="keyword">namespace </span>ImageResizer.Plugins.DiskCache {</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    <span class="keyword">public</span> delegate <span class="keywordtype">void</span> LockCallback();<span class="comment"></span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">    /// &lt;summary&gt;</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">    /// Provides locking based on a string key. </span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">    /// Locks are local to the LockProvider instance.</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">    /// The class handles disposing of unused locks. Generally used for </span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">    /// coordinating writes to files (of which there can be millions). </span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">    /// Only keeps key/lock pairs in memory which are in use.</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">    /// Thread-safe.</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">    /// &lt;/summary&gt;</span></div>
<div class="line"><a name="l00018"></a><span class="lineno"><a class="line" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html">   18</a></span>&#160;<span class="comment"></span>    <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html">LockProvider</a> {</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment">        /// &lt;summary&gt;</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">        /// The only objects in this collection should be for open files. </span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment">        /// &lt;/summary&gt;</span></div>
<div class="line"><a name="l00023"></a><span class="lineno"><a class="line" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html#a0cfb76a116c6befc5eed7680cc6dee81">   23</a></span>&#160;<span class="comment"></span>        <span class="keyword">protected</span> Dictionary&lt;String, Object&gt; locks = </div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;                        <span class="keyword">new</span> Dictionary&lt;string, object&gt;(StringComparer.Ordinal);<span class="comment"></span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment">        /// &lt;summary&gt;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment">        /// Synchronization object for modifications to the &#39;locks&#39; dictionary</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">        /// &lt;/summary&gt;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno"><a class="line" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html#af682de769d94aff88a726f3142b5b1ee">   28</a></span>&#160;<span class="comment"></span>        <span class="keyword">protected</span> <span class="keywordtype">object</span> createLock = <span class="keyword">new</span> object();</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment">        /// &lt;summary&gt;</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment">        /// Returns true if the given key *might* be locked.</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment">        /// &lt;/summary&gt;</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment">        /// &lt;param name=&quot;key&quot;&gt;&lt;/param&gt;</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment">        /// &lt;returns&gt;&lt;/returns&gt;</span></div>
<div class="line"><a name="l00035"></a><span class="lineno"><a class="line" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html#a142346f3b9254c84868e31ededa706c6">   35</a></span>&#160;<span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html#a142346f3b9254c84868e31ededa706c6">MayBeLocked</a>(<span class="keywordtype">string</span> key)</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;        {</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;            lock (createLock)</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;            {</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;                <span class="keywordflow">return</span> locks.ContainsKey(key);</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;            }</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;        }</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment">        /// &lt;summary&gt;</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment">        /// Attempts to execute the &#39;success&#39; callback inside a lock based on &#39;key&#39;.  If successful, returns true.</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="comment">        /// If the lock cannot be acquired within &#39;timoutMs&#39;, returns false</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="comment">        /// In a worst-case scenario, it could take up to twice as long as &#39;timeoutMs&#39; to return false.</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="comment">        /// &lt;/summary&gt;</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="comment">        /// &lt;param name=&quot;key&quot;&gt;&lt;/param&gt;</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="comment">        /// &lt;param name=&quot;success&quot;&gt;&lt;/param&gt;</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="comment">        /// &lt;param name=&quot;failure&quot;&gt;&lt;/param&gt;</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="comment">        /// &lt;param name=&quot;timeoutMs&quot;&gt;&lt;/param&gt;</span></div>
<div class="line"><a name="l00053"></a><span class="lineno"><a class="line" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html#aba5ee5d1323568b30fc351151524ac0c">   53</a></span>&#160;<span class="comment"></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html#aba5ee5d1323568b30fc351151524ac0c">TryExecute</a>(<span class="keywordtype">string</span> key, <span class="keywordtype">int</span> timeoutMs, LockCallback success){</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;            <span class="comment">//Record when we started. We don&#39;t want an infinite loop.</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;            DateTime startedAt = DateTime.UtcNow;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;            <span class="comment">// Tracks whether the lock acquired is still correct</span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;            <span class="keywordtype">bool</span> validLock = <span class="keyword">true</span>; </div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;            <span class="comment">// The lock corresponding to &#39;key&#39;</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;            <span class="keywordtype">object</span> itemLock = null;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;            <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;                <span class="comment">//We have to loop until we get a valid lock and it stays valid until we lock it.</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;                <span class="keywordflow">do</span> {</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;                    <span class="comment">// 1) Creation/aquire phase</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;                    lock (createLock) {</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;                        <span class="comment">// We have to lock on dictionary writes, since otherwise </span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;                        <span class="comment">// two locks for the same file could be created and assigned</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;                        <span class="comment">// at the same time. (i.e, between TryGetValue and the assignment)</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;                        <span class="keywordflow">if</span> (!locks.TryGetValue(key, out itemLock))</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;                            locks[key] = itemLock = <span class="keyword">new</span> Object(); <span class="comment">//make a new lock!</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;                    }</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;                    <span class="comment">// Loophole (part 1):</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;                    <span class="comment">// Right here - this is where another thread (executing part 2) could remove &#39;itemLock&#39;</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;                    <span class="comment">// from the dictionary, and potentially, yet another thread could </span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;                    <span class="comment">// insert a new value for &#39;itemLock&#39; into the dictionary... etc, etc..</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;                    <span class="comment">// 2) Execute phase</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;                    <span class="keywordflow">if</span> (System.Threading.Monitor.TryEnter(itemLock, timeoutMs)) {</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;                        <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;                            <span class="comment">// May take minutes to acquire this lock. </span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;                            <span class="comment">// Trying to detect an occurence of loophole above</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;                            <span class="comment">// Check that itemLock still exists and matches the dictionary</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;                            lock (createLock) {</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;                                <span class="keywordtype">object</span> newLock = null;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;                                validLock = locks.TryGetValue(key, out newLock);</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;                                validLock = validLock &amp;&amp; newLock == itemLock;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;                            }</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;                            <span class="comment">// Only run the callback if the lock is valid</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;                            <span class="keywordflow">if</span> (validLock) {</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;                                success(); <span class="comment">// Extremely long-running callback, perhaps throwing exceptions</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;                                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;                            }</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;                        } <span class="keywordflow">finally</span> {</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;                            System.Threading.Monitor.Exit(itemLock);<span class="comment">//release lock</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;                        }</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;                        validLock = <span class="keyword">false</span>; <span class="comment">//So the finally clause doesn&#39;t try to clean up the lock, someone else will do that.</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;                        <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">//Someone else had the lock, they can clean it up.</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;                    }</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;                    <span class="comment">//Are we out of time, still having an invalid lock?</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;                    <span class="keywordflow">if</span> (!validLock &amp;&amp; Math.Abs(DateTime.UtcNow.Subtract(startedAt).TotalMilliseconds) &gt; timeoutMs) {</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;                        <span class="comment">//We failed to get a valid lock in time. </span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;                        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;                    }</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;                    <span class="comment">// If we had an invalid lock, we have to try everything over again.</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;                } <span class="keywordflow">while</span> (!validLock);</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;            } <span class="keywordflow">finally</span> {</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;                <span class="keywordflow">if</span> (validLock) {</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;                    <span class="comment">// Loophole (part 2). When loophole part 1 and 2 cross paths,</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;                    <span class="comment">// An lock object may be removed before being used, and be orphaned</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;                    <span class="comment">// 3) Cleanup phase - Attempt cleanup of lock objects so we don&#39;t </span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;                    <span class="comment">//   have a *very* large and slow dictionary.</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;                    lock (createLock) {</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;                        <span class="comment">//  TryEnter() fails instead of waiting. </span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;                        <span class="comment">//  A normal lock would cause a deadlock with phase 2. </span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;                        <span class="comment">//  Specifying a timeout would add great and pointless overhead.</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;                        <span class="comment">//  Whoever has the lock will clean it up also.</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;                        <span class="keywordflow">if</span> (System.Threading.Monitor.TryEnter(itemLock)) {</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;                            <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;                                <span class="comment">// It succeeds, so no-one else is working on it </span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;                                <span class="comment">// (but may be preparing to, see loophole)</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;                                <span class="comment">// Only remove the lock object if it </span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;                                <span class="comment">// still exists in the dictionary as-is</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;                                <span class="keywordtype">object</span> existingLock = null;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;                                <span class="keywordflow">if</span> (locks.TryGetValue(key, out existingLock)</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                                    &amp;&amp; existingLock == itemLock)</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;                                    locks.Remove(key);</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;                            } <span class="keywordflow">finally</span> {</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;                                <span class="comment">// Remove the lock</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;                                System.Threading.Monitor.Exit(itemLock);</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;                            }</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;                        }</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;                    }</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;                }</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;            }</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;            <span class="comment">// Ideally the only objects in &#39;locks&#39; will be open operations now.</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        }</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    }</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;}</div>
<div class="ttc" id="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider_html_aba5ee5d1323568b30fc351151524ac0c"><div class="ttname"><a href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html#aba5ee5d1323568b30fc351151524ac0c">ImageResizer.Plugins.DiskCache.LockProvider.TryExecute</a></div><div class="ttdeci">bool TryExecute(string key, int timeoutMs, LockCallback success)</div><div class="ttdoc">Attempts to execute the &amp;#39;success&amp;#39; callback inside a lock based on &amp;#39;key&amp;#39;. If successful, returns true. If the lock cannot be acquired within &amp;#39;timoutMs&amp;#39;, returns false In a worst-case scenario, it could take up to twice as long as &amp;#39;timeoutMs&amp;#39; to return false. </div><div class="ttdef"><b>Definition:</b> <a href="_lock_provider_8cs_source.html#l00053">LockProvider.cs:53</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider_html_a142346f3b9254c84868e31ededa706c6"><div class="ttname"><a href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html#a142346f3b9254c84868e31ededa706c6">ImageResizer.Plugins.DiskCache.LockProvider.MayBeLocked</a></div><div class="ttdeci">bool MayBeLocked(string key)</div><div class="ttdoc">Returns true if the given key might be locked. </div><div class="ttdef"><b>Definition:</b> <a href="_lock_provider_8cs_source.html#l00035">LockProvider.cs:35</a></div></div>
<div class="ttc" id="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider_html"><div class="ttname"><a href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html">ImageResizer.Plugins.DiskCache.LockProvider</a></div><div class="ttdoc">Provides locking based on a string key. Locks are local to the LockProvider instance. The class handles disposing of unused locks. Generally used for coordinating writes to files (of which there can be millions). Only keeps key/lock pairs in memory which are in use. Thread-safe. </div><div class="ttdef"><b>Definition:</b> <a href="_lock_provider_8cs_source.html#l00018">LockProvider.cs:18</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.5
</small></address>
</body>
</html>
