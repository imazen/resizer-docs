<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ImageResizer: ImageResizer.Plugins.DiskCache.LockProvider Class Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="resizer-icon-64.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">ImageResizer
   &#160;<span id="projectnumber">3.2.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="classes.html"><span>Class&#160;Index</span></a></li>
      <li><a href="inherits.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Events</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="namespace_image_resizer.html">ImageResizer</a>      </li>
      <li class="navelem"><a class="el" href="namespace_image_resizer_1_1_plugins.html">Plugins</a>      </li>
      <li class="navelem"><a class="el" href="namespace_image_resizer_1_1_plugins_1_1_disk_cache.html">DiskCache</a>      </li>
      <li class="navelem"><a class="el" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html">LockProvider</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pro-attribs">Protected Attributes</a>  </div>
  <div class="headertitle">
<div class="title">ImageResizer.Plugins.DiskCache.LockProvider Class Reference</div>  </div>
</div><!--header-->
<div class="contents">
<!-- doxytag: class="ImageResizer::Plugins::DiskCache::LockProvider" -->
<p>Provides locking based on a string key. Locks are local to the <a class="el" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html" title="Provides locking based on a string key. Locks are local to the LockProvider instance. The class handles disposing of unused locks. Generally used for coordinating writes to files (of which there can be millions). Only keeps key/lock pairs in memory which are in use. Thread-safe.">LockProvider</a> instance. The class handles disposing of unused locks. Generally used for coordinating writes to files (of which there can be millions). Only keeps key/lock pairs in memory which are in use. Thread-safe.  
 <a href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html#details">More...</a></p>

<p><a href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider-members.html">List of all members.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html#aba5ee5d1323568b30fc351151524ac0c">TryExecute</a> (string key, int timeoutMs, LockCallback success)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Attempts to execute the 'success' callback inside a lock based on 'key'. If successful, returns true. If the lock cannot be acquired within 'timoutMs', returns false In a worst-case scenario, it could take up to twice as long as 'timeoutMs' to return false.  <a href="#aba5ee5d1323568b30fc351151524ac0c"></a><br/></td></tr>
<tr><td colspan="2"><h2><a name="pro-attribs"></a>
Protected Attributes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">Dictionary&lt; String, Object &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html#a0cfb76a116c6befc5eed7680cc6dee81">locks</a></td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">The only objects in this collection should be for open files.  <a href="#a0cfb76a116c6befc5eed7680cc6dee81"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">object&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html#af682de769d94aff88a726f3142b5b1ee">createLock</a> = new object()</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Synchronization object for modifications to the 'locks' dictionary.  <a href="#af682de769d94aff88a726f3142b5b1ee"></a><br/></td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>Provides locking based on a string key. Locks are local to the <a class="el" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html" title="Provides locking based on a string key. Locks are local to the LockProvider instance. The class handles disposing of unused locks. Generally used for coordinating writes to files (of which there can be millions). Only keeps key/lock pairs in memory which are in use. Thread-safe.">LockProvider</a> instance. The class handles disposing of unused locks. Generally used for coordinating writes to files (of which there can be millions). Only keeps key/lock pairs in memory which are in use. Thread-safe. </p>

<p>Definition at line <a class="el" href="_lock_provider_8cs_source.html#l00018">18</a> of file <a class="el" href="_lock_provider_8cs_source.html">LockProvider.cs</a>.</p>
</div><hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="aba5ee5d1323568b30fc351151524ac0c"></a><!-- doxytag: member="ImageResizer::Plugins::DiskCache::LockProvider::TryExecute" ref="aba5ee5d1323568b30fc351151524ac0c" args="(string key, int timeoutMs, LockCallback success)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html#aba5ee5d1323568b30fc351151524ac0c">ImageResizer.Plugins.DiskCache.LockProvider.TryExecute</a> </td>
          <td>(</td>
          <td class="paramtype">string&#160;</td>
          <td class="paramname"><em>key</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>timeoutMs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">LockCallback&#160;</td>
          <td class="paramname"><em>success</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Attempts to execute the 'success' callback inside a lock based on 'key'. If successful, returns true. If the lock cannot be acquired within 'timoutMs', returns false In a worst-case scenario, it could take up to twice as long as 'timeoutMs' to return false. </p>
<dl class="params"><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">key</td><td></td></tr>
    <tr><td class="paramname">success</td><td></td></tr>
    <tr><td class="paramname">failure</td><td></td></tr>
    <tr><td class="paramname">timeoutMs</td><td></td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="_lock_provider_8cs_source.html#l00038">38</a> of file <a class="el" href="_lock_provider_8cs_source.html">LockProvider.cs</a>.</p>
<div class="fragment"><pre class="fragment">                                                                               {
            <span class="comment">//Record when we started. We don&#39;t want an infinite loop.</span>
            DateTime startedAt = DateTime.UtcNow;

            <span class="comment">// Tracks whether the lock acquired is still correct</span>
            <span class="keywordtype">bool</span> validLock = <span class="keyword">true</span>; 
            <span class="comment">// The lock corresponding to &#39;key&#39;</span>
            <span class="keywordtype">object</span> itemLock = null;

            <span class="keywordflow">try</span> {
                <span class="comment">//We have to loop until we get a valid lock and it stays valid until we lock it.</span>
                <span class="keywordflow">do</span> {
                    <span class="comment">// 1) Creation/aquire phase</span>
                    lock (<a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html#af682de769d94aff88a726f3142b5b1ee" title="Synchronization object for modifications to the &#39;locks&#39; dictionary.">createLock</a>) {
                        <span class="comment">// We have to lock on dictionary writes, since otherwise </span>
                        <span class="comment">// two locks for the same file could be created and assigned</span>
                        <span class="comment">// at the same time. (i.e, between TryGetValue and the assignment)</span>
                        <span class="keywordflow">if</span> (!<a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html#a0cfb76a116c6befc5eed7680cc6dee81" title="The only objects in this collection should be for open files.">locks</a>.TryGetValue(key, out itemLock))
                            <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html#a0cfb76a116c6befc5eed7680cc6dee81" title="The only objects in this collection should be for open files.">locks</a>[key] = itemLock = <span class="keyword">new</span> Object(); <span class="comment">//make a new lock!</span>

                    }
                    <span class="comment">// Loophole (part 1):</span>
                    <span class="comment">// Right here - this is where another thread (executing part 2) could remove &#39;itemLock&#39;</span>
                    <span class="comment">// from the dictionary, and potentially, yet another thread could </span>
                    <span class="comment">// insert a new value for &#39;itemLock&#39; into the dictionary... etc, etc..</span>

                    <span class="comment">// 2) Execute phase</span>
                    <span class="keywordflow">if</span> (System.Threading.Monitor.TryEnter(itemLock, timeoutMs)) {
                        <span class="keywordflow">try</span> {
                            <span class="comment">// May take minutes to acquire this lock. </span>

                            <span class="comment">// Trying to detect an occurence of loophole above</span>
                            <span class="comment">// Check that itemLock still exists and matches the dictionary</span>
                            lock (<a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html#af682de769d94aff88a726f3142b5b1ee" title="Synchronization object for modifications to the &#39;locks&#39; dictionary.">createLock</a>) {
                                <span class="keywordtype">object</span> newLock = null;
                                validLock = <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html#a0cfb76a116c6befc5eed7680cc6dee81" title="The only objects in this collection should be for open files.">locks</a>.TryGetValue(key, out newLock);
                                validLock = validLock &amp;&amp; newLock == itemLock;
                            }
                            <span class="comment">// Only run the callback if the lock is valid</span>
                            <span class="keywordflow">if</span> (validLock) {
                                success(); <span class="comment">// Extremely long-running callback, perhaps throwing exceptions</span>
                                <span class="keywordflow">return</span> <span class="keyword">true</span>;
                            }

                        } <span class="keywordflow">finally</span> {
                            System.Threading.Monitor.Exit(itemLock);<span class="comment">//release lock</span>
                        }
                    } <span class="keywordflow">else</span> {
                        validLock = <span class="keyword">false</span>; <span class="comment">//So the finally clause doesn&#39;t try to clean up the lock, someone else will do that.</span>
                        <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">//Someone else had the lock, they can clean it up.</span>
                    }

                    <span class="comment">//Are we out of time, still having an invalid lock?</span>
                    <span class="keywordflow">if</span> (!validLock &amp;&amp; Math.Abs(DateTime.UtcNow.Subtract(startedAt).TotalMilliseconds) &gt; timeoutMs) {
                        <span class="comment">//We failed to get a valid lock in time. </span>
                        <span class="keywordflow">return</span> <span class="keyword">false</span>;
                    }


                    <span class="comment">// If we had an invalid lock, we have to try everything over again.</span>
                } <span class="keywordflow">while</span> (!validLock);
            } <span class="keywordflow">finally</span> {
                <span class="keywordflow">if</span> (validLock) {
                    <span class="comment">// Loophole (part 2). When loophole part 1 and 2 cross paths,</span>
                    <span class="comment">// An lock object may be removed before being used, and be orphaned</span>

                    <span class="comment">// 3) Cleanup phase - Attempt cleanup of lock objects so we don&#39;t </span>
                    <span class="comment">//   have a *very* large and slow dictionary.</span>
                    lock (<a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html#af682de769d94aff88a726f3142b5b1ee" title="Synchronization object for modifications to the &#39;locks&#39; dictionary.">createLock</a>) {
                        <span class="comment">//  TryEnter() fails instead of waiting. </span>
                        <span class="comment">//  A normal lock would cause a deadlock with phase 2. </span>
                        <span class="comment">//  Specifying a timeout would add great and pointless overhead.</span>
                        <span class="comment">//  Whoever has the lock will clean it up also.</span>
                        <span class="keywordflow">if</span> (System.Threading.Monitor.TryEnter(itemLock)) {
                            <span class="keywordflow">try</span> {
                                <span class="comment">// It succeeds, so no-one else is working on it </span>
                                <span class="comment">// (but may be preparing to, see loophole)</span>
                                <span class="comment">// Only remove the lock object if it </span>
                                <span class="comment">// still exists in the dictionary as-is</span>
                                <span class="keywordtype">object</span> existingLock = null;
                                <span class="keywordflow">if</span> (<a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html#a0cfb76a116c6befc5eed7680cc6dee81" title="The only objects in this collection should be for open files.">locks</a>.TryGetValue(key, out existingLock)
                                    &amp;&amp; existingLock == itemLock)
                                    <a class="code" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html#a0cfb76a116c6befc5eed7680cc6dee81" title="The only objects in this collection should be for open files.">locks</a>.Remove(key);
                            } <span class="keywordflow">finally</span> {
                                <span class="comment">// Remove the lock</span>
                                System.Threading.Monitor.Exit(itemLock);
                            }
                        }
                    }
                }
            }
            <span class="comment">// Ideally the only objects in &#39;locks&#39; will be open operations now.</span>
            <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }
</pre></div>
</div>
</div>
<hr/><h2>Member Data Documentation</h2>
<a class="anchor" id="af682de769d94aff88a726f3142b5b1ee"></a><!-- doxytag: member="ImageResizer::Plugins::DiskCache::LockProvider::createLock" ref="af682de769d94aff88a726f3142b5b1ee" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">object <a class="el" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html#af682de769d94aff88a726f3142b5b1ee">ImageResizer.Plugins.DiskCache.LockProvider.createLock</a> = new object()<code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Synchronization object for modifications to the 'locks' dictionary. </p>

<p>Definition at line <a class="el" href="_lock_provider_8cs_source.html#l00028">28</a> of file <a class="el" href="_lock_provider_8cs_source.html">LockProvider.cs</a>.</p>

</div>
</div>
<a class="anchor" id="a0cfb76a116c6befc5eed7680cc6dee81"></a><!-- doxytag: member="ImageResizer::Plugins::DiskCache::LockProvider::locks" ref="a0cfb76a116c6befc5eed7680cc6dee81" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">Dictionary&lt;String, Object&gt; <a class="el" href="class_image_resizer_1_1_plugins_1_1_disk_cache_1_1_lock_provider.html#a0cfb76a116c6befc5eed7680cc6dee81">ImageResizer.Plugins.DiskCache.LockProvider.locks</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>Initial value:</b><div class="fragment"><pre class="fragment"> 
                        <span class="keyword">new</span> Dictionary&lt;string, object&gt;(StringComparer.Ordinal)
</pre></div>
<p>The only objects in this collection should be for open files. </p>

<p>Definition at line <a class="el" href="_lock_provider_8cs_source.html#l00023">23</a> of file <a class="el" href="_lock_provider_8cs_source.html">LockProvider.cs</a>.</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li>C:/Users/Administrator/Documents/resizer/Plugins/DiskCache/<a class="el" href="_lock_provider_8cs_source.html">LockProvider.cs</a></li>
</ul>
</div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Events</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
