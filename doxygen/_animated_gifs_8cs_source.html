<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ImageResizer: C:/Users/Administrator/Documents/resizer/Plugins/AnimatedGifs/AnimatedGifs.cs Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="resizer-icon-64.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">ImageResizer
   &#160;<span id="projectnumber">3.2.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">C:/Users/Administrator/Documents/resizer/Plugins/AnimatedGifs/AnimatedGifs.cs</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 ï»¿<span class="comment">/* Copyright (c) 2011 Nathanael Jones. See license.txt for your rights */</span>
<a name="l00002"></a>00002 <span class="keyword">using</span> System;
<a name="l00003"></a>00003 <span class="keyword">using</span> System.Collections.Generic;
<a name="l00004"></a>00004 <span class="keyword">using</span> System.Text;
<a name="l00005"></a>00005 <span class="keyword">using</span> ImageResizer;
<a name="l00006"></a>00006 <span class="keyword">using</span> System.IO;
<a name="l00007"></a>00007 <span class="keyword">using</span> System.Drawing.Imaging;
<a name="l00008"></a>00008 <span class="keyword">using</span> System.Collections.Specialized;
<a name="l00009"></a>00009 <span class="keyword">using</span> System.Drawing;
<a name="l00010"></a>00010 <span class="keyword">using</span> ImageResizer.Resizing;
<a name="l00011"></a>00011 <span class="keyword">using</span> ImageResizer.Encoding;
<a name="l00012"></a>00012 <span class="keyword">using</span> ImageResizer.Configuration;
<a name="l00013"></a>00013 <span class="keyword">using</span> ImageResizer.Plugins.Basic;
<a name="l00014"></a><a class="code" href="namespace_image_resizer_1_1_plugins_1_1_animated_gifs.html">00014</a> <span class="keyword">namespace </span>ImageResizer.Plugins.<a class="code" href="class_image_resizer_1_1_plugins_1_1_animated_gifs_1_1_animated_gifs.html">AnimatedGifs</a>
<a name="l00015"></a>00015 {
<a name="l00016"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_animated_gifs_1_1_animated_gifs.html">00016</a>     <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="class_image_resizer_1_1_plugins_1_1_animated_gifs_1_1_animated_gifs.html">AnimatedGifs</a> : <a class="code" href="class_image_resizer_1_1_resizing_1_1_builder_extension.html" title="Provides a useable base class that can be used to modify the behavior of ImageBuilder. When registered with an ImageBuilder instance, the ImageBuilder will call the corresponding methods on the extension prior to executing its own methods.">BuilderExtension</a>, <a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_plugin.html" title="All plugins must implement this. Enables web.config addition and removal.">IPlugin</a>
<a name="l00017"></a>00017     {
<a name="l00018"></a>00018         <a class="code" href="class_image_resizer_1_1_configuration_1_1_config.html">Config</a> c;
<a name="l00019"></a>00019         <span class="keyword">public</span> <a class="code" href="class_image_resizer_1_1_plugins_1_1_animated_gifs_1_1_animated_gifs.html">AnimatedGifs</a>(){}
<a name="l00020"></a>00020         <span class="keyword">public</span> <a class="code" href="interface_image_resizer_1_1_plugins_1_1_i_plugin.html" title="All plugins must implement this. Enables web.config addition and removal.">IPlugin</a> Install(Configuration.Config c) {
<a name="l00021"></a>00021             c.Plugins.add_plugin(<span class="keyword">this</span>);
<a name="l00022"></a>00022             this.c = c;
<a name="l00023"></a>00023             <span class="keywordflow">return</span> <span class="keyword">this</span>;
<a name="l00024"></a>00024         }
<a name="l00025"></a>00025 
<a name="l00026"></a>00026         <span class="keyword">public</span> <span class="keywordtype">bool</span> Uninstall(Configuration.Config c) {
<a name="l00027"></a>00027             c.Plugins.remove_plugin(<span class="keyword">this</span>);
<a name="l00028"></a>00028             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00029"></a>00029         }
<a name="l00030"></a>00030 <span class="comment"></span>
<a name="l00031"></a>00031 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00032"></a>00032 <span class="comment">        /// We cannot fix buildToBitmap, only buildToStream</span>
<a name="l00033"></a>00033 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00034"></a>00034 <span class="comment">        /// &lt;param name=&quot;source&quot;&gt;&lt;/param&gt;</span>
<a name="l00035"></a>00035 <span class="comment">        /// &lt;param name=&quot;dest&quot;&gt;&lt;/param&gt;</span>
<a name="l00036"></a>00036 <span class="comment">        /// &lt;param name=&quot;settings&quot;&gt;&lt;/param&gt;</span>
<a name="l00037"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_animated_gifs_1_1_animated_gifs.html#a87efbd57704156a9a554c96618a79307">00037</a> <span class="comment"></span>        <span class="keyword">protected</span> <span class="keyword">override</span> <a class="code" href="namespace_image_resizer_1_1_resizing.html#a22bbb53580a122efe469a26ad584fa86" title="What to do about remaining handlers/methods for the specified section.">RequestedAction</a> <a class="code" href="class_image_resizer_1_1_plugins_1_1_animated_gifs_1_1_animated_gifs.html#a87efbd57704156a9a554c96618a79307" title="We cannot fix buildToBitmap, only buildToStream.">buildToStream</a>(Bitmap source, Stream dest, <a class="code" href="class_image_resizer_1_1_resize_settings.html" title="Represents the settings which will be used to process the image. Extends NameValueCollection to provi...">ResizeSettings</a> settings) {
<a name="l00038"></a>00038             <span class="comment">//Determines output format, includes code for saving in a variety of formats.</span>
<a name="l00039"></a>00039             <span class="keywordflow">if</span> (ImageFormat.Gif.Equals(source.RawFormat) &amp;&amp; <span class="comment">//If it&#39;s a GIF</span>
<a name="l00040"></a>00040                 settings[<span class="stringliteral">&quot;frame&quot;</span>] == null &amp;&amp;    <span class="comment">//With no frame specifier</span>
<a name="l00041"></a>00041                 source.FrameDimensionsList != null &amp;&amp; source.FrameDimensionsList.Length &gt; 0) { <span class="comment">//With multiple frames</span>
<a name="l00042"></a>00042                 <a class="code" href="interface_image_resizer_1_1_encoding_1_1_i_encoder.html" title="An image encoder. Exposes methods for suitability checking, encoding, transparency compatibility chec...">IEncoder</a> enc = c.Plugins.EncoderProvider.GetEncoder(settings, source);
<a name="l00043"></a>00043                 
<a name="l00044"></a>00044                 <span class="keywordflow">if</span> (enc.<a class="code" href="interface_image_resizer_1_1_encoding_1_1_i_encoder.html#a7cbe10dac3c2bad04d088ae6f20e4180" title="Returns the appropriate mime-time for the output format as currently configured.">MimeType</a>.Equals(<span class="stringliteral">&quot;image/gif&quot;</span>, StringComparison.OrdinalIgnoreCase) &amp;&amp; source.GetFrameCount(FrameDimension.Time) &gt; 1) {
<a name="l00045"></a>00045                     WriteAnimatedGif(source, dest, enc, settings);
<a name="l00046"></a>00046                     <span class="keywordflow">return</span> <a class="code" href="namespace_image_resizer_1_1_resizing.html#a22bbb53580a122efe469a26ad584fa86" title="What to do about remaining handlers/methods for the specified section.">RequestedAction</a>.Cancel;
<a name="l00047"></a>00047                 }
<a name="l00048"></a>00048 
<a name="l00049"></a>00049             }
<a name="l00050"></a>00050             <span class="keywordflow">return</span> <a class="code" href="namespace_image_resizer_1_1_resizing.html#a22bbb53580a122efe469a26ad584fa86" title="What to do about remaining handlers/methods for the specified section.">RequestedAction</a>.None;
<a name="l00051"></a>00051         }
<a name="l00052"></a>00052         
<a name="l00053"></a>00053         <span class="keyword">private</span>  <span class="keywordtype">void</span> WriteAnimatedGif(Bitmap src, Stream output, <a class="code" href="interface_image_resizer_1_1_encoding_1_1_i_encoder.html" title="An image encoder. Exposes methods for suitability checking, encoding, transparency compatibility chec...">IEncoder</a> ios, <a class="code" href="class_image_resizer_1_1_resize_settings.html" title="Represents the settings which will be used to process the image. Extends NameValueCollection to provi...">ResizeSettings</a> queryString)
<a name="l00054"></a>00054         {
<a name="l00055"></a>00055             <span class="comment">//http://www.fileformat.info/format/gif/egff.htm</span>
<a name="l00056"></a>00056             <span class="comment">//http://www.fileformat.info/format/gif/spec/44ed77668592476fb7a682c714a68bac/view.htm</span>
<a name="l00057"></a>00057 
<a name="l00058"></a>00058             <span class="comment">//Heavily modified and patched from comments on http://bloggingabout.net/blogs/rick/archive/2005/05/10/3830.aspx</span>
<a name="l00059"></a>00059             MemoryStream memoryStream = null;
<a name="l00060"></a>00060             BinaryWriter writer = null;
<a name="l00061"></a>00061             <span class="comment">//Variable declaration</span>
<a name="l00062"></a>00062             <span class="keywordflow">try</span>
<a name="l00063"></a>00063             {
<a name="l00064"></a>00064                 writer = <span class="keyword">new</span> BinaryWriter(output);
<a name="l00065"></a>00065                 memoryStream = <span class="keyword">new</span> MemoryStream(4096);
<a name="l00066"></a>00066                 <span class="comment">//Write the GIF 89a sig</span>
<a name="l00067"></a>00067                 writer.Write(<span class="keyword">new</span> byte[] { (byte)<span class="charliteral">&#39;G&#39;</span>, (byte)<span class="charliteral">&#39;I&#39;</span>, (byte)<span class="charliteral">&#39;F&#39;</span>, (byte)<span class="charliteral">&#39;8&#39;</span>, (byte)<span class="charliteral">&#39;9&#39;</span>, (byte)<span class="charliteral">&#39;a&#39;</span> });
<a name="l00068"></a>00068                 
<a name="l00069"></a>00069                 <span class="comment">//We parse this from the source image</span>
<a name="l00070"></a>00070                 <span class="keywordtype">int</span> loops = GetLoops(src.PropertyItems);
<a name="l00071"></a>00071                 <span class="keywordtype">int</span>[] delays = GetDelays(src.PropertyItems);<span class="comment">//20736 (delays) 20737 (loop);</span>
<a name="l00072"></a>00072                 
<a name="l00073"></a>00073                 <span class="keywordtype">int</span> frames = src.GetFrameCount(FrameDimension.Time);
<a name="l00074"></a>00074                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> frame = 0; frame &lt; frames; frame++)
<a name="l00075"></a>00075                 {
<a name="l00076"></a>00076                     <span class="comment">//Select the frame</span>
<a name="l00077"></a>00077                     src.SelectActiveFrame(FrameDimension.Time, frame);
<a name="l00078"></a>00078 
<a name="l00079"></a>00079       
<a name="l00080"></a>00080                     <span class="comment">// http://radio.weblogs.com/0122832/2005/10/20.html</span>
<a name="l00081"></a>00081                     <span class="comment">//src.MakeTransparent(); This call makes some GIFs replicate the first image on all frames.. i.e. SelectActiveFrame doesn&#39;t work.</span>
<a name="l00082"></a>00082                     
<a name="l00083"></a>00083                     <span class="keyword">using</span> (Bitmap b = c.CurrentImageBuilder.Build(src,queryString,<span class="keyword">false</span>)){
<a name="l00084"></a>00084                         <span class="comment">//Useful to check if animation is occuring - sometimes the problem isn&#39;t the output file, but the input frames are </span>
<a name="l00085"></a>00085                         <span class="comment">//all the same.</span>
<a name="l00086"></a>00086                         <span class="comment">//for (var i = 0; i &lt; b.Height; i++) b.SetPixel(frame * 10, i, Color.Green);</span>
<a name="l00087"></a>00087                         <span class="comment">// b.Save(memoryStream, ImageFormat.Gif);</span>
<a name="l00088"></a>00088                         ios.<a class="code" href="interface_image_resizer_1_1_encoding_1_1_i_encoder.html#a9cf9397f4528608e91785410afb73eb6" title="Encodes the image to the specified stream.">Write</a>(b, memoryStream); <span class="comment">//Allows quantization and dithering</span>
<a name="l00089"></a>00089                     }
<a name="l00090"></a>00090                     
<a name="l00091"></a>00091                     GifClass gif = <span class="keyword">new</span> GifClass();
<a name="l00092"></a>00092                     gif.LoadGifPicture(memoryStream);
<a name="l00093"></a>00093                     <span class="keywordflow">if</span> (frame == 0)
<a name="l00094"></a>00094                     {
<a name="l00095"></a>00095                         <span class="comment">//Only one screen descriptor per file. Steal from the first image</span>
<a name="l00096"></a>00096                         writer.Write(gif.m_ScreenDescriptor.ToArray());
<a name="l00097"></a>00097                         <span class="comment">//How many times to loop the image (unless it is 1) IE and FF3 loop endlessley if loop=1</span>
<a name="l00098"></a>00098                         <span class="keywordflow">if</span> (loops != 1) 
<a name="l00099"></a>00099                             writer.Write(GifCreator.CreateLoopBlock(loops));
<a name="l00100"></a>00100                     }
<a name="l00101"></a>00101                     <span class="comment">//Restore frame delay</span>
<a name="l00102"></a>00102                     <span class="keywordtype">int</span> delay = 0;
<a name="l00103"></a>00103                     <span class="keywordflow">if</span> (delays != null &amp;&amp; delays.Length &gt; frame) delay = delays[frame];
<a name="l00104"></a>00104                     writer.Write(GifCreator.CreateGraphicControlExtensionBlock(delay)); <span class="comment">//The delay/transparent color block</span>
<a name="l00105"></a>00105                     writer.Write(gif.m_ImageDescriptor.ToArray()); <span class="comment">//The image desc</span>
<a name="l00106"></a>00106                     writer.Write(gif.m_ColorTable.ToArray()); <span class="comment">//The palette</span>
<a name="l00107"></a>00107                     writer.Write(gif.m_ImageData.ToArray()); <span class="comment">//Image data</span>
<a name="l00108"></a>00108 
<a name="l00109"></a>00109                     memoryStream.SetLength(0); <span class="comment">//Clear the mem stream, but leave it allocated for now</span>
<a name="l00110"></a>00110                     memoryStream.Seek(0, SeekOrigin.Begin); <span class="comment">//Reset memory buffer</span>
<a name="l00111"></a>00111                 }
<a name="l00112"></a>00112                 
<a name="l00113"></a>00113                 writer.Write((byte)0x3B); <span class="comment">//End file</span>
<a name="l00114"></a>00114             }
<a name="l00115"></a>00115             <span class="keywordflow">finally</span>
<a name="l00116"></a>00116             {
<a name="l00117"></a>00117                <span class="keywordflow">if</span> (memoryStream != null) memoryStream.Dispose();
<a name="l00118"></a>00118                <span class="comment">//if (writer != null) writer.Close</span>
<a name="l00119"></a>00119             }
<a name="l00120"></a>00120         }<span class="comment"></span>
<a name="l00121"></a>00121 <span class="comment">        /// &lt;summary&gt;</span>
<a name="l00122"></a>00122 <span class="comment">        /// Returns the first PropertyItem with a matching ID</span>
<a name="l00123"></a>00123 <span class="comment">        /// &lt;/summary&gt;</span>
<a name="l00124"></a>00124 <span class="comment">        /// &lt;param name=&quot;items&quot;&gt;&lt;/param&gt;</span>
<a name="l00125"></a>00125 <span class="comment">        /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;</span>
<a name="l00126"></a>00126 <span class="comment">        /// &lt;returns&gt;&lt;/returns&gt;</span>
<a name="l00127"></a><a class="code" href="class_image_resizer_1_1_plugins_1_1_animated_gifs_1_1_animated_gifs.html#ad3c354c63dad9344b18c2f4b4a880566">00127</a> <span class="comment"></span>          <span class="keyword">protected</span> <span class="keyword">static</span> PropertyItem getById(PropertyItem[] items, <span class="keywordtype">int</span> <span class="keywordtype">id</span>)
<a name="l00128"></a>00128           {
<a name="l00129"></a>00129               <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; items.Length; i++)
<a name="l00130"></a>00130                <span class="keywordflow">if</span> (items[i] != null &amp;&amp; items[i].Id == <span class="keywordtype">id</span>)
<a name="l00131"></a>00131                    <span class="keywordflow">return</span> items[i];
<a name="l00132"></a>00132 
<a name="l00133"></a>00133               <span class="keywordflow">return</span> null;
<a name="l00134"></a>00134           }
<a name="l00135"></a>00135           <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keywordtype">int</span>[] GetDelays(PropertyItem[] items)
<a name="l00136"></a>00136           {
<a name="l00137"></a>00137               <span class="comment">//Property item ID 20736 http://bytes.com/groups/net-vb/692099-problem-animated-gifs</span>
<a name="l00138"></a>00138               PropertyItem pi = getById(items, 20736);
<a name="l00139"></a>00139               <span class="keywordflow">if</span> (pi == null) <span class="keywordflow">return</span> null;
<a name="l00140"></a>00140               <span class="comment">//Combine bytes into integers</span>
<a name="l00141"></a>00141               <span class="keywordtype">int</span>[] vals = <span class="keyword">new</span> <span class="keywordtype">int</span>[pi.Value.Length / 4];
<a name="l00142"></a>00142               <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; pi.Value.Length; i+=4){
<a name="l00143"></a>00143                   vals[i / 4] = BitConverter.ToInt32(pi.Value, i);
<a name="l00144"></a>00144               }
<a name="l00145"></a>00145               <span class="keywordflow">return</span> vals;
<a name="l00146"></a>00146               
<a name="l00147"></a>00147           }
<a name="l00148"></a>00148           <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keywordtype">int</span> GetLoops(PropertyItem[] items)
<a name="l00149"></a>00149           {
<a name="l00150"></a>00150             <span class="comment">// http://weblogs.asp.net/justin_rogers/archive/2004/01/19/60424.aspx</span>
<a name="l00151"></a>00151               <span class="comment">//Property item ID 20737</span>
<a name="l00152"></a>00152               PropertyItem pi = getById(items, 20737);
<a name="l00153"></a>00153               <span class="keywordflow">if</span> (pi == null) <span class="keywordflow">return</span> 0;
<a name="l00154"></a>00154               <span class="comment">//Combine bytes into integers</span>
<a name="l00155"></a>00155               <span class="keywordflow">return</span> pi.Value[0] + (pi.Value[1] &lt;&lt; 8);
<a name="l00156"></a>00156           }
<a name="l00157"></a>00157 
<a name="l00158"></a>00158 
<a name="l00159"></a>00159           
<a name="l00160"></a>00160     }
<a name="l00161"></a>00161     
<a name="l00162"></a>00162 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Events</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
